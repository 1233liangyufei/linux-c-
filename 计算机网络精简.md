# 计算机网络——概论-因特网构成与服务描述

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.08.28 15:10:34字数 731阅读 26

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 因特网

因特网是一种特定的计算机网络，也是当今世界主流的计算机组网方式。
因特网可按其构成和其所提供的服务描述。

## 构成描述

因特网在硬件构成上，大致有端系统，通信链路，分组交换机三类部件。

### 端系统（end system）

又称主机（host）

  包括桌面PC,Linux工作站，服务器，智能手机，平板电脑，汽车，环境传感器，智能家电等。

  端系统可分为客户机和服务器。

### 通信链路

传输速率 比特/秒 bps 即 bit/s

#### 物理媒体

**导引型媒体** 电波沿固体媒体前行

**非导引型媒体** 电波在空气或外层空间中传播

**成本** 安装物理链路的劳动力成本通常比材料成本高几个数量级

##### 双绞铜线

常用于电话网。

便宜。

双绞线由两根隔离的铜线绞合而成以减少临近绞线的电气干扰。

多根绞线捆扎成电缆，并覆盖外层防护层。

##### 同轴电缆

常用于电视系统。

由两个同心铜导体组成。

##### 光纤

长途导引型媒体。

导引光脉冲，不受电磁干扰。

光设备成本高，如发射器，接收器，交换机。难以在短途传输中应用。

##### 陆地无线电信道

短距离，个人设备，蓝牙

局域，无线LAN

广域，蜂窝接入

##### 卫星无线电信道

### 分组交换机(packet switch)

由一条入通信链路接收到达的分组，并从一条出通信链路转发该分组。

路由器和链路层交换机是因特网中主要的分组交换机。

（实际售卖的分组交换机可能同时包含网络层路由器和链路层交换机等多种功能部件）

#### 分组（packet）

数据分段后加上首部字节形成的数据包。

#### 路由器

常用于网络核心

#### 链路层交换机

常用于接入网

## 服务描述

### 因特网应用程序编程接口(因特网API)

  规定运行在一个端系统上的软件请求因特网基础设施向运行在另一个端系统上的特定目的地软件交付数据的方式。

### 网络协议

  一个协议定义了在两个或多个通信实体之间交换的报文格式和次序，以及报文发送，接收或其他事件下的动作。

 协议包括语法，语义，时序三要素。

## 因特网标准

由Internet Engineering Task Force,IETF 研发
IETF标准文档 Requset For Comment,RFC

# 计算机网络——概论-网络边缘·接入网·网络核心

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.08.28 15:48:09字数 1,195阅读 18

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 网络边缘

  接入因特网的各种端系统

# 接入网

将端系统连接到其边缘路由器的物理链路。
**边缘路由器** 端系统到任何其他远程端系统的路径上的第一台路由器。

铺设新线路成本高昂（铺设成本高，线路本身的成本很低），故往往考虑复用已有线路网络，如电话网和有线电视网。

### 数字用户线接入(Digital Subscriber Line,DSL)

利用本地电话公司现有的本地电话基础设施。
住户通常从提供本地电话接入的本地电话公司处获得DSL接入。本地电话公司作为用户的ISP。
借助用户侧的DSL调制解调器，分频器，本地电话公司侧的数字用户线接入复用器，将家庭电话线分作三个频段：

1. 高速下行通道，50kHz-1MHz
2. 中速上行通道，4kHz-50kHz
3. 双向电话信道，0-4kHz

### 电缆因特网接入(cable Internet access)

利用有线电视公司现有的有线电视基础设施。
住户从有线电视公司获得电缆因特网接入。有线电视公司作为用户ISP。

用户侧的电缆调制解调器，电视公司侧的电缆调制解调端接系统将通信链路分为上行和下行两个信道。下行信道速率通常更高。

**特征** 共享广播媒体。

**混合光纤同轴** 光缆连接有线电视公司和地区枢纽，同轴电缆连接地区枢纽和住户。
**光纤到户** 提供从本地中心局直接到家庭的光纤路径。

### 卫星链路

### 拨号接入

使用传统电话线，类似DSL，但传输速率更慢。

### 以太网

局域网接入技术。
用户通过双绞铜线与以太网交换机相连，以太网交换机（网络）与因特网相连。

### WiFi

基于IEEE802.11技术的无线局域网接入。

### 广域无线接入

3G,4G等无线技术，复用移动电话基础设施，通过蜂窝网提供商运营的基站转发分组。

# 网络核心

网络核心是分组交换机（路由器）以及连接交换机的网络

### 因特网服务提供商（Internet Service Provider,ISP)

端系统通过ISP接入因特网。
ISP为用户，内容提供者提供接入。

ISP大致是分层级的，但没有正式的，公认的标准。(在国内，行政命令规定了ISP的层级，如工信部规定，中国电信的ChinaNet骨干网、CN2骨干网与中国联通的骨干网，以及中国教育网在国内属于第一级网络，之间互联不收取费用。)
全球性的顶层ISP大致有 Level 3 通信，AT&T，Sprint,NTT等。

国内ISP情况可参考博文 [https://www.cnblogs.com/onepixel/p/10238221.html](https://links.jianshu.com/go?to=https%3A%2F%2Fwww.cnblogs.com%2Fonepixel%2Fp%2F10238221.html)

### 网络的网络

端系统与接入ISP相连。接入ISP间必须互联。

#### 网络结构

以ISP为顶点，因特网结构可视为图。
图的主体大致是森林。即ISP大致上是分层的。
可不严格地分为顶层ISP，区域ISP，接入网ISP等。
高层ISP为低层ISP提供服务，并依据流量收取费用。
顶层ISP间必须互联以实现全球联网。
因特网不是严格的树结构，有时没有严格的层级，即存在横边。

**存在点（Point of Presence,PoP）** 供应商网络中数台路由器组成的群组，客户ISP可以连接到提供商ISP的存在点。即存在点是高层ISP对底层ISP的连入接口。
**多宿** 底层ISP可选择与多个高层ISP连接。
**对等** 大致同层次的ISP间可以对等，即将它们的网络直接连接，通常不结算流量费用，以减少经过高层ISP的流量。
**因特网交换点(Internet Exchange Point,IXP)** 因特网链路汇合点，多个ISP可在IXP处共同对等。

**内容提供商网络** 内容提供商在全球部署数据中心，通过专用线路连接，其主体独立于公共因特网，专用网络上仅承载内容提供商自身的流量。
内容提供商网络依据需要，与公共因特网中各层级的ISP互联。

# 计算机网络——概论-多路复用

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.08.28 16:49:33字数 450阅读 14

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 多路复用（电路交换的无共享多路复用）

通常，（无共享的）多路复用将链路或其它网络资源划分为资源片；
将资源片分配给各路呼叫；
每路呼叫独占分配到的资源片进行通信；
资源片可能闲置；

## 频分多路复用(frequency division multiplexing,FDM)

各用户占用不同频带；

## 波分多路复用(wavelength division multiplexing,WDM)

各用户占用不同波长；
就是光链路的频分多路复用，只是通常用波长来衡量光的频率；

## 时分多路复用(time division multiplexing,TDM)

各用户占用不同时隙；
将时间划分为帧，每个帧内划分出多个时隙，将时隙分配给各个用户；

## 码分多路复用(code division multiplexing,CDM)

各用户占用不同码片序列；
码分多路复用技术中，多个用户使用特定的码片序列编码数据，可同时在同频段上收发数据而不互相干扰；

具体地，
各用户的码片序列互相正交，以保证编码后的数据互不干扰；
以下将二进制0映射为-1，二进制1映射为+1；
在发送端，编码信号=原始数据*码片序列 ；
在信道上，总编码信号是所有用户的叠加编码信号；
在接受端，码片序列与总编码信号的内积就是相应用户发送的数据；

常用于无线链路共享；

# 统计多路复用（分组交换的共享多路复用）

在分组交换网络中的按需共享链路；

# 计算机网络——概论-数据交换

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.08.28 17:02:09字数 374阅读 9

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

数据交换可分为电路交换，报文交换，分组交换三类。

## 电路交换

端系统通信开始前，建立连接。通信会话期间，通信链路上的交换机为连接维护状态，维持相应资源。
电路交换分建立连接，通信，拆除连接三个阶段。
特点是独占资源。
*电话网络是典型的电路交换网络。*

## 报文交换

源发送（应用层）信息的整体；
*常用于电报网络*

## 分组交换

**分组** 报文划分成的小数据块，分组通过通信链路和分组交换机在源和目的地间传输。
分组需要拆分与重组，相对报文交换会产生额外开销；
分组交换适用于突发数据传输网络，可能产生拥塞现象。

*因特网使用分组交换机制*

#### 存储转发机制

交换机能开始向输出链路传送分组的第一个比特前，必须接受整个分组。
在存储转发机制下，由于被存储转发的数据单位较小，分组交换比往往报文交换更迅速。

#### 路由

路由器从一条输入链路得到分组后，决定选择哪条输出链路。
依据：转发表，路由选择协议

# 计算机网络——概论-网络性能度量

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.09.25 14:38:43字数 659阅读 11

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 速率

单位时间（秒）传输的信息（比特）量

单位：b/s（或bps）、kb/s、Mb/s、Gb/s
计算机网络语境下， k=103、M=106、G=10^9
速率往往是指额定速率或标称速率，即理想状态下的最大速率

#### 带宽(bandwidth)

信道速率

在通信领域原指信号具有的频带宽度，即最高频率与最低频率之差，单位是赫兹（Hz）

网络领域的“带宽”通常是数字信道所能传送的“最高数据率”，单位：b/s (bps)

#### 吞吐量

端到端速率

**瞬时吞吐量** 单位时间内目的端系统接收到的数据量 , 单位 bps

吞吐量取决于链路上的瓶颈速率和干扰流量（共用某段链路的其他流量）
现实因特网中通信的瓶颈链路往往在于接入网而非网络核心

# 时延

#### 结点时延

###### **处理时延**

检查分组首部，决定将分组导向何处所需的时间。
其他：比特级差错检验

###### **排队时延**

分组在链路上等待传输所需的时间
**流量强度**
单位时间到达结点的数据量比上单位时间离开节点的数据量
分组长度L*分组到达速率a/链路带宽R
流量强度若大于一，等待队列趋于无限延长。

###### **传输时延**

将分组的所有比特推上输出链路所需的时间
分组长度/链路带宽

###### **传播时延**

比特从链路起点到链路终点所需的时间
物理链路长度/信号传播速度

#### 端到端时延

链路总时延，包括端系统应用特定的时延。

**端到端总传输时延**
各个链路传输时延之和，忽略其它时延
设 报文 M bit,链路带宽 R bps,分组长度（忽略分组头） L bit,通过的链路数 h
则 端到端总传输时延 T = M/R + (h-1)L/R
即总传输时延为整个报文的传输时延加上一个分组通过所有链路的时延；

#### 丢包

结点上等待传输的队列过长，超出容量限制，导致结点丢弃某些分组。
丢包率 = 丢包数/已发分组数

#### 时延带宽积

传播时延 * 带宽
单位 bit

链路的时延带宽积又称为以比特为单位的链路长度

。





0人点赞



计算机网络





"小礼物走一走，来简书关注我"

还没有人赞赏，支持一下

![  ](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃]()HIT-施某 

总资产0.121 (约0.01元)共写了5.2W字获得0个赞共0个粉丝























### 全部评论0只看作者按时间倒序按时间正序



















### 推荐阅读[更多精彩内容]()

- [计算机网络_网络层]()

  网络层提供的两种服务 在计算机网络领域，网络层应该向运输层提供怎样的服务（面向连接还是无连接）曾引起了长期的争论，...

  [![img](https:////upload.jianshu.io/users/upload_avatars/1213532/1ca87466e108?imageMogr2/auto-orient/strip|imageView2/1/w/48/h/48/format/webp)srtianxia]()阅读 783评论 0赞 6

  ![img](https:////upload-images.jianshu.io/upload_images/1213532-9bab3c0f95453abe.png?imageMogr2/auto-orient/strip|imageView2/1/w/300/h/240/format/webp)

- [计算机网络---章节2~4]()

  第二章 物理层 频分复用：频分复用的用户在同样的时间占用不同的带宽资源（频率带宽） 时分复用：时分复用的用户在不同...

  [![img](https:////upload.jianshu.io/users/upload_avatars/1309773/6b034480-c826-40d5-ad54-f66a77c67950.jpg?imageMogr2/auto-orient/strip|imageView2/1/w/48/h/48/format/webp)PramaWells]()阅读 501评论 0赞 1

  ![img](https:////upload-images.jianshu.io/upload_images/1309773-4065a30246d20b55.jpg?imageMogr2/auto-orient/strip|imageView2/1/w/300/h/240/format/webp)

- [【笔记】谢希仁—计网五版：chapter four 网络层（二）]()

  五、因特网的路由选择协议 1.有关路由选择协议的几个基本概念 Ⅰ、理想的路由算法 路由表中的路由是怎样得出的呢？核...

  [![img](https:////upload.jianshu.io/users/upload_avatars/5859322/6eb151db-0353-484d-a033-6c77eec2755e.jpg?imageMogr2/auto-orient/strip|imageView2/1/w/48/h/48/format/webp)dmmy大印]()阅读 327评论 0赞 3

  ![img](https:////upload-images.jianshu.io/upload_images/5859322-3ab84d7121c12d1b.png?imageMogr2/auto-orient/strip|imageView2/1/w/300/h/240/format/webp)

- [计算机网络]()

  参考文档《自顶向下方法》待阅读 （一）计算机网络和因特网 什么是因特网 具体构成描述：因特网是一个世纪范围内的计算...

  [![img](https:////upload.jianshu.io/users/upload_avatars/12213455/339b61d4-53e8-41f4-b6a4-28a9fd91529f.PNG?imageMogr2/auto-orient/strip|imageView2/1/w/48/h/48/format/webp)siuLimTau]()阅读 231评论 1赞 0

- [计算机网络自学笔记:什么是计算机网络]()

  计算机网络是计算机专业的王牌核心课程之一,在面试中的重要性不言而喻,年假的这一段时间,重新刷了一遍这门课,其中记录...

  [![img](https:////upload.jianshu.io/users/upload_avatars/3070770/df9d23fb-2b85-4f23-99ca-e722f81ad7cd.jpg?imageMogr2/auto-orient/strip|imageView2/1/w/48/h/48/format/webp)云时之间]()阅读 533评论 0赞 4

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃]()

总资产0.121 (约0.01元)



[计算机网络——网络层-路由算法概述]()

阅读 7

[计算机网络——链路层-链路虚拟化]()



作者：疼呃

链接：https://www.jianshu.com/p/e171a946e124

来源：简书

著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

# 计算机网络——应用层-概述

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.09.25 14:39:20字数 779阅读 19

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 网络应用程序体系结构

## 客户-服务器体系结构（client-server architecture）

#### 服务器

- 7*24小时提供服务
- 永久性访问地址/域名
- 利用大量服务器的集群实现可扩展性

#### 客户机

- 与服务器通信，使用服务器提供的服务
- 间歇性接入网络
- 可能使用动态IP地址
- 不会与其他客户机直接通信

如：Web,TFP,Telnet,电子邮件

## 对等体系结构（P2P architecture)

不依赖或极少地依赖中心服务器。
应用程序在间断连接的主机对间直接通信。
**对等方** P2P体系下直接通信的主机。
流量密集型应用常用P2P结构。

如：BitTorrent,P2P下载加速器，因特网电话，IPTV

优点：高度可伸缩
缺点：难于管理

## 混合体系结构(Hybrid)

结合了C/S,P2P结构。
如许多即时通讯应用中，服务器用于跟踪用户IP，用户到用户报文直接在用户主机间传输。

# 进程通信

进程是通信中会话双方的实体。

#### 套接字

同一主机内，应用层与运输层间的接口，是操作系统提供的对因特网服务的抽象。
开发者可通过套接字控制应用层的一切行为，但对运输层的控制非常有限。

#### 进程寻址

**标识进程**

1. 主机地址： IP地址
2. 主机中的进程标识符： 端口号

[周知端口号](https://links.jianshu.com/go?to=https%3A%2F%2Fwww.iana.org%2Fassignments%2Fservice-names-port-numbers%2Fservice-names-port-numbers.xhtml)

# 可供进程使用的运输层服务

#### 可靠数据传输

运输层协议确保进程到进程的可靠数据传输：数据正确，完全地交付
丢包：结点缓存溢出，数据比特损坏。

#### 吞吐量(速率，带宽)保证

运输层协议提供确保可用的吞吐量。
即协议确保可用吞吐量总大于r 比特每秒。

#### 定时(延时)保证

运输层协议确保延时低于一定值。

#### 安全性保证

运输层协议保证数据机密性，完整性等。

#### 因特网运输服务

**TCP服务** 面向链接的可靠数据传输服务

**UDP服务** 无连接的不可靠数据传输服务

**安全套接字层（Secure Sockets Layer,SSL）**
应用层协议，提供进程到进程的安全性服务。
依赖运输层的TCP服务。
有自己的套接字API，需要在通信应用程序的双方部署相应SSL代码（SSL库，类）

# 应用层协议

定义应用程序进程如何传递报文，具体地，定义：

- 报文类型
- 报文语法 报文字段及格式
- 字段语义
- 进程何时，如何发送报文，如何响应报文

**公有域应用层协议** 常由RFC 文档定义
**私有应用层协议**

应用层协议是网络应用的重要组成部分。

# 计算机网络——应用层-Web&HTTP

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.09.25 14:39:31字数 2,205阅读 8

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# Web(World Wide Web)

20世纪90年代初
因特网应用

**Web应用的组成**

- 文档格式标准 HTML
- Web浏览器
- Web服务器
- 应用层协议HTTP

### 网页(Web Page)

由对象组成。对象是一个文件，如HTML文件，JPEG图像，Java程序，视频片段等。
对象可通过一个URL地址寻址。
Web页面常由一个HTML基本文件和多个引用对象构成。

### URL地址

URL(Uniform Resoure Locator)：统一资源定位器 RFC1738

```cpp
Scheme://host:port/path
```

用以寻址Web对象
由一个存放对象的服务器主机名和对象路径名构成。

# 超文本传输协议(HyperText Transfer Protocol,HTTP)

HTTP 由客户端程序和服务端程序实现，二者通过交换HTTP报文会话。
HTTP规范定义了HTTP客户端和服务端之间的通信协议。

Web浏览器实现HTTP客户端,请求、接收、展示Web对象
Web服务器实现HTTP服务端,响应客户的请求，发送对象

HTTP使用TCP作为支撑运输层协议。

端口：80

**无状态协议** 服务器不保存关于客户的任何信息
服务器向客户发送被请求的文件，而不存储任何关于客户的状态信息。

**往返时间（Round-Trip Time,RTT)**
一个短分组从客户到服务器然后再返回客户所花费的时间。

### 非持续连接

某客户和服务器的一次会话中，每个请求/响应对通过一个单独的TCP连接传输

HTTP 1.0版本使用非持续性连接

#### 串行非持续连接

对多个待获得的web对象，客户端一次只请求一个对象，待前一个对象接收完毕后再发送对下一个对象的请求。

**时间分析**

- 为请求一个小web对象(对象传输时间可忽略)，需要消耗两个RTT时间。第一个RTT执行TCP握手的前两部分，第二个RTT结合TCP握手的第三部分发送请求报文，接收响应报文。
- 请求一个引用a个小web对象的小基本web对象需要耗时![(a+1)*2](https://math.jianshu.com/math?formula=(a%2B1)*2)个RTT

#### 并行非持续连接

浏览器通常支持并行的TCP连接。并行TCP连接数通常为5~10个。
对多个待获得的web对象，客户端一次可同时建立多个TCP连接，以同时请求多个web对象。
**时间分析**

- 建立TCP连接并获得小基本web文档需要两个RTT。若在浏览器并行能力之内，被引用的多个小web对象可同时获得，需要两个RTT。共4个RTT。

### 持续连接

某客户和服务器的一次会话中，所有请求/响应对经同一TCP连接传输

HTTP 1.1版本在默认方式下采用持续连接，但也可由客户端/服务器配置为非持续连接。

#### 无流水(pipelining)的持久性连接

客户端只有收到前一个响应后才发送新的请求
可理解为同个TCP内的串行

**时间分析**

- 建立TCP连接并获得小基本web文档需要两个RTT。每个被引用的小web对象耗时1个RTT。
- 请求一个引用a个小web对象的小基本web对象需要耗时![2+a](https://math.jianshu.com/math?formula=2%2Ba)个RTT

#### 带有流水机制的持久性连接

客户端只要遇到一个引用对象就尽快发出请求
可理解为同个TCP内的并行
HTTP 1.1的默认选项

**时间分析**

- 理想情况下，收到所有的引用对象只需耗时约1个RTT
- 请求一个引用a个小web对象的小基本web对象需要耗时![3](https://math.jianshu.com/math?formula=3)个RTT

**TCP 三次握手**
1.客户向服务器发送一个小TCP报文段；
2.服务器用一个小TCP报文段做出确认和响应；
3.客户向服务器返回确认和一个HTTP请求报文；
4.服务器返回相应HTML文件;

## HTTP报文格式

**HTTP规范**
[RFC 1945](https://links.jianshu.com/go?to=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc1945) , [RFC 2616](https://links.jianshu.com/go?to=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc2616)

用ASCII文本书写
HTTP协议有两类消息，请求消息(request)和响应消息(response)

### HTTP 请求报文

**请求行** HTTP请求报文的第一行

- 方法字段 值可用为：GET POST HEAD PUT DELETE ； 绝大多数HTTP请求报文使用GET方法
- URL字段 请求对象的标识
- HTTP版本字段

方法

- GET方法 请求一个对象
- POST方法 提交表单
- HEAD方法 类GET，但返回特殊的响应报文(无实体体)，而非所请求的对象，常用于调试
- PUT方法 用户上传对象到指定Web服务器的指定目录
- DELETE方法 允许用户删除Web服务器上的对象

**首部行** 请求行后继的其它行，包含一些会话信息

**空行** 回车换行，分隔首部行和实体体

**实体体(entity body)**
GET方法下实体体为空
POST方法下实体体包含表单信息

### HTTP 响应报文

**状态行**

- 协议版本字段
- 状态码
- 状态信息

常见状态码

- 200 OK
- 301 Moved Permanently
- 400 Bad Request
- 404 Not Found
- 505 HTTP Version Not Supported

**首部行**

**空行**

**实体体**
包含了所请求的对象

## cookie

HTTP是无状态协议，但cookie技术允许服务器识别用户
cookie在无状态的HTTP之上建立一个用户会话层

参见 [RFC 6265]

**cookie组件**

- HTTP响应报文中的cookie首部行
- HTTP请求报文中的cookie首部行
- 用户端系统中保留一个cookie文件，由浏览器管理
- Web站点中的后台数据库

cookie技术的争议在于它可能泄露用户的隐私

## Web缓存器（代理服务器）

代表原Web服务器来响应HTTP请求的网络实体

- Web缓冲器的存储空间保存最近请求过的对象的副本
- 可以配置用户浏览器，使得HTTP请求首先指向Web缓冲器

Web缓冲器通常由ISP购买并安装

### 条件GET方法

允许缓存器证实其缓存的副本是新的。
如果缓存器有web对象最新的版本，则初始服务器不需要向缓存器发送该web对象

在HTTP请求消息中声明所持有版本的日期
If-modified-since: <date>

如果缓存的版本是最新的，则响应消息中不包含对象
HTTP/1.0 304 Not Modified

### web缓存工作机制

1. 浏览器向web缓存器请求web对象A,若该请求缓存未命中，则缓存器向存放A的初始服务器请求web对象A并缓存之，而后将对象A发送给浏览器。
   注意初始服务器给缓存器的响应报文中包括首部行:Last-Modified:date 1，该行说明了对象A上次被修改的时间。
2. 一定时间后，浏览器再次向web缓存器请求web对象A,该请求缓存命中，且浏览器注意到A的上次修改时间为date 1。
   缓存器向初始服务器发送条件GET请求，该请求在对web对象A的普通请求基础上添加了首部行：If-Modified-Since:date 1。
3. 初始服务器收到缓存器的条件GET请求，检查在date 1后该对象有无修改，若有修改，发送新的对象A并附上最近一次修改的时间。若未修改，发送带有 304 Not Modified 状态行的响应报文，且该报文实体体为空。
4. 缓存器接收到初始服务器响应后，给浏览器发送相应对象A。

#### 缓存机制优点

1. web缓存器可大大减少对客户请求的响应时间，特别是当客户与初始服务器间的瓶颈带宽远低于客户与web缓存器间的瓶颈带宽时。
2. 大大减少一个机构的接入链路到因特网的通信流量以降低费用
3. 从整体上，大大减小因特网上的Web流量，实现有效的内容分发

**内容分发网络（Content Distribution Network,CDN）**
基于缓存器技术，CDN公司在因特网上安装许多地理上分散的缓存器，使得大流量本地化。
有共享CDN(Akamai,Limelight)，专用CDN（谷歌，微软）

# 计算机网络——应用层-FTP文件传输协议

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.09.25 14:39:44字数 176阅读 14

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

用户在本地主机与远程主机间传输文件

端口：21

FTP使用多个并行TCP链接

**控制连接** 在主机间传输控制信息，如用户标识，口令，文件命令等
**数据连接** 实际传递文件
控制连接是持续的，一次会话维持一个控制连接
数据连接是非持续的，为每一次文件传输创建一个新数据连接

**带外传送（out-of-band）** 使用独立控制连接，如FTP
**带内传送（in-band)** 在传送数据的同一个连接内传输控制信息，如HTTP

# 计算机网络——应用层-邮件&SMTP

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.09.25 14:39:52字数 1,511阅读 7

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 因特网电子邮件系统(email)

### 组成部分

- **用户代理** 邮件客户端，允许用户阅读，回复，转发，保存，撰写报文（电子邮件）
- **邮件服务器** 每个邮件接收方都在某邮件服务器上有一个邮箱,邮箱存储发给该用户的Email，邮箱的消息队列存储等待发送的Email
- **简单邮件传输协议，SMTP** 邮件服务器之间传递消息所使用的协议

- 发送方代理和发送方服务器间，可通过SMTP，HTTP协议推送报文；
- 发送方服务器和接收方服务器间，通过邮件传输协议SMTP推送报文；
- 接收方服务器和接收方代理间，可通过邮件访问协议，如POP3,IMAP,HTTP等拉取报文；

# SMTP简单邮件传输协议(Simple Mail Transfer Protocol,SMTP)

用于从发送方邮件服务器发送报文到接收方邮件服务器

参见 [RFC 5321]

- 古老（1982年有正式RFC文档，但事实上早在此前出现），限制报文的体只能用ASCII表示。传输现代多媒体附件时，要将多媒体数据编码为ASCII码，用SMTP传输完毕后再解码还原为多媒体数据。
- SMTP一般不使用中间邮件服务器发送邮件，即使两服务器相距甚远也会尝试直接建立连接。
- 依赖TCP运输层协议，端口：25，使用持久性连接
- 要求消息必须由7位ASCII码构成
- SMTP通信双方在TCP连接建立之后，还会进行应用层的握手，SMTP客户端会指示收发双方的邮件地址。
- SMTP服务器利用CRLF.CRLF确定消息的结束。
- 若SMTP发送方服务器有多个发往同一接收服务器的报文，它会在同一TCP连接内传输，但在每个报文发送前都进行应用层握手（声明邮件的收发双方）

**命令/响应交互模式**

- 命令(command): ASCII文本
- 响应(response): 状态代码和语句

### 拉协议（pull protocol）

用户依据协议从服务器上拉取信息，连接由文件接收方发起。如HTTP（的主要功能）

### 推协议（push protocol）

用户依据协议把文件推送到服务器上，连接由文件发送方发起。如SMTP

### SMTP对比HTTP

同：都用于主机间的文件传输
异：

1. HTTP主要是拉协议，SMTP主要是推协议。
2. HTTP无编码限制，SMTP要求每个报文（包括报文体）使用7比特的ASCII码格式。
3. 对于由多个对象组成的文档，HTTP将每个对象封装到独立的报文中，而SMTP把所有报文对象放在一个报文内。

# Email消息格式

定义邮件消息本身的格式，包括首部行和报文体

参见 [RFC 5322]

**头部行(header)**

- To
- From
- Subject 主题，可选的

email头部行不同于SMTP中的命令，尽管它们可能冗余了同样的信息。email from，to头部行是email报文的一部分，而SMTP的from,to命令是SMTP握手协议的一部分。

**空行** 分隔

**消息体(body)**
消息本身，只能是ASCII字符

### Email消息格式：多媒体扩展 MIME

MIME：多媒体邮件扩展 RFC 2045, 2056
通过在邮件头部增加额外的行以声明MIME的内容类型
额外的头部行包括数据编码方法，多媒体类型，子类型，参数等。

# **邮件访问协议**

用于接收方从接收方邮件服务器上拉取报文。

常用邮件访问协议：

- Post Office Protocol-Version 3,POP3
- Internet Mail Access Protocol,IMAP
- HTTP

## POP协议

极为简单的邮件访问协议。带有认证/授权和下载功能。

参见 [RFC 1939]

POP3的包括 特许，事务处理，更新三个阶段

POP3是无状态的

服务器响应

- +OK [可选的数据]
- -ERR

### 认证过程

用户代理以明文形式发送用户名和口令以鉴别用户

客户端命令

- User：声明用户名
- Pass: 声明密码

### 事务阶段

用户代理拉取报文
获取服务器上的报文信息
将报文标记为待删除

- List：列出消息数量
- Retr：用编号获取消息
- Dele: 删除消息
- Quit

### 更新阶段

发生在用户发出quit命令后，删除那些被用户标记为待删除的报文

## IMAP协议

比POP3功能更为强大也更为复杂的邮件访问协议

所有消息统一保存在一个地方：服务器
允许用户利用文件夹组织消息
IMAP支持跨会话(Session)的用户状态

## HTTP协议

现今基于Web的电子邮件都使用HTTP协议，此时用户代理就是普通的浏览器。
用户和邮件服务器间的报文传输都通过HTTP进行，而邮件服务器间的报文传输仍通过SMTP进行。

# **邮件发送过程**

1. 发送方用户代理用SMTP（或HTTP）将邮件推送至发送方邮件服务器；
2. 发送方邮件服务器用SMTP将邮件推送至接收方邮件服务器；具体地，发送方邮件暂存与发送方邮件服务器中，发送方邮件服务器会周期性的尝试连接接收方服务器，若多次尝试失败，则返回给发送方一个错误信息
3. 接收方邮件服务器分发邮件给接收方；具体地，接收方通过邮件访问协议从接收方邮件服务器上拉取邮件。



0人点赞

计算机网络

# 计算机网络——应用层-域名解析服务DNS

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.09.25 14:40:03字数 2,083阅读 11

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# DNS域名解析协议

**因特网主机标识**

1. 主机名 hostname
2. IP地址 IP adress

**域名系统（Domain Name System,DNS）**

主要提供主机名到IP地址转换的服务
包括

- 一个由分层的DNS服务器实现的分布式数据库
- 一个使得主机能够查询分布式数据库的应用层协议

DNS服务器通常是运行Berkely Internet Name Domain（BIND）软件的UNIX机器

DNS协议基于UDP
端口:53
参见 [RFC 1034],[RFC 1035]

## DNS服务

1. **解析主机名为IP地址**
2. **主机别名(host aliasing)** 主机可拥有一个 *规范主机名* 和若干主机别名。DNS提供通过主机别名获得规范主机名及主机IP的服务
3. **邮件服务器别名** MX记录技术允许一个机构使用相同（但不同类型）的主机名。即该机构的web服务器可以和该机构的邮件服务器同名。
4. **负载分配** DNS可用于在冗余的服务器间进行负载分配。一个规范主机名可以映射到一个地址集合，当用户请求解析该规范主机名时，DNS返回相应IP地址集合，但是在每次响应中轮换IP地址次序，以将负载分配到不同服务器（进程通常默认使用IP地址集合中的第一个地址）

## DNS工作机制

### 分布式层次数据库

DNS使用了大量服务器，它们以层次方式组织，分布在全世界范围内。

DNS大致分三类
**根DNS服务器**
因特网上共13个根DNS服务器，标号[A-M]
每台逻辑上的根服务器实际上是一个冗余的服务器网络。

**顶级域DNS服务器**
负责顶级域名
负责com, org, net,edu等顶级域名和cn, uk, fr等国家顶级域名
参见 [IANA TLD](https://links.jianshu.com/go?to=https%3A%2F%2Fwww.iana.org%2Fdomains%2Froot%2Fdb)

**权威DNS服务器**
因特网上具有公共可访问主机的机构必须提供公共可访问的DNS记录。
机构可以选择实现自己的权威DNS服务器以管理该机构的公共可访问DNS记录，也可以选择由DNS服务提供商管理该机构的公共可访问DNS记录（付服务提供商钱，存服务提供商的权威DNS服务器里）
实践中，权威DNS服务器可能有多层。

**本地DNS服务器**
*严格地说，不属于DNS层次结构*
功能上非必须，提供代理，缓存作用
每个ISP(大学，院系，公司，小区)都拥有一台本地DNS服务器。本地DNS服务器通常在地理上临近用户主机。

当主机发出DNS请求时，请求被发往本地DNS服务器，本地DBS服务器起代理作用，它将请求转发到DNS服务器层次结构中。

**递归查询** A请求B,B请求C,C返回给B,B返回给A
**迭代查询** A请求B,B返回给A,A请求C,C返回给A

实践中，从主机到本地DNS的查询是递归的，从本地DNS到DNS层次结构的查询是迭代的。

### DNS缓存

- 减少延时，减少DNS流量
- 在一个请求链中，当某DNS服务器接收到一个回答时，它能将该回答缓存在本地存储器中。
- 对一个请求，它首先查看本地缓存，若无，再请求相应DNS服务器。
- DNS在一定时间后（常为两天）会丢弃缓存的信息。

## DNS记录

**资源记录（Resource Record,RR）** DNS服务器存储RR。每个DNS回答报文包含若干条RR。

资源记录 RR = （Name,Value,Type,TTL）

TTL 记录生存时间，即记录应当从缓存中移除的时间。

#### RR主要类型

1. **Type = A** Name 为主机名，Value 是该主机名对应的IP地址。 A类RR提供规范主机名到IP地址的映射
2. **Type = NS** Name 为域，Value为知晓如何获得该域中主机IP地址的权威DNS服务器的主机名。NS类RR提供沿查询链路由DNS的信息
3. **Type = CNAME** Name 为主机别名，Value 为规范主机名。CNAME类RR提供别名到规范主机名的映射
4. **Type = MX** Name为邮件服务器别名，Value为规范主机名。MX类RR提供邮件服务器别名到规范主机名的映射。MX记录允许一个机构的邮件服务器和其他服务器使用相同的别名。

对某给定主机名h，h的权威DNS服务器s1，DNS请求链中s1的上游DNS服务器s0，必有：
s1中有一条主机名h的A类记录；
s0中有一条NS记录，该记录对应包含主机名h的域；
s0中有一条A类记录，该记录提供NS记录中Value值所对应的IP地址；

## DNS报文

DNS有且仅有查询，回答两种报文，且两者遵照相同的格式，格式如下：

**首部区域**
12byte

1. **标识符**字段 16bit 标识一次查询，一个请求/响应对中有相同的标识符。
2. **标志**字段 若干标志。 查询/回答标志位 指出报文为查询报文亦或回答报文；权威标志位 指示相应服务器是否为所查询主机名的权威服务器； 递归可用标志位 指示该DNS服务器是否支持递归查询；希望递归标志位 指示客户是否希望在服务器没有记录时执行递归查询；
3. **问题数**字段
4. **回答RR数**字段
5. **权威RR数**字段
6. **附加RR数**字段

**问题区域**
正在进行的查询信息

1. **名字**字段 所查询的主机名
2. **类型**字段 指示所查询的主机名类型 是否为邮件服务器地址（MX记录或A记录）

**回答区域**
所查询主机名相关的资源记录
若干条RR

**权威区域**
其他权威服务器的记录

**附加区域**
其他有帮助的记录
例如所查询的邮件服务器的规范主机名。

## 向DNS数据库中插入记录

**DNS注册登记机构**
商业实体，验证待注册域名的唯一性，将待注册域名输入DNS数据库，并为注册服务收取少量费用。

**因特网名字和地址分配机构(Internet Corporation for Assigned Names and Numbers,ICANN)**
ICANN授权注册登记机构。
[http://www.internic.net](https://links.jianshu.com/go?to=http%3A%2F%2Fwww.internic.net)

向某注册登记机构注册域名h时，需要提供域名h的基本和辅助权威DNS服务器的名字和IP地址。
对所提供的每一个权威DNS服务器的名字和地址，该注册登记机构确保将相应的NS类记录，A类记录输入对应的顶级域DNS服务器。
注册者还需确保域名h的Web服务器A类记录，邮件服务器MX类记录被输入上述权威DNS服务器中。

## 其它资料

[https://jocent.me/2017/06/18/dns-protocol-principle.html](https://links.jianshu.com/go?to=https%3A%2F%2Fjocent.me%2F2017%2F06%2F18%2Fdns-protocol-principle.html)

## DNS安全性

### DDos

利用僵尸网络向根域名服务器发送大量ICMP ping报文。
向顶级域名服务器发送大量DNS请求。

### 中间人攻击

截获来自主机的请求并向主机发送伪造的回答

### DNS毒害攻击

向DNS服务器发送伪造的回答，诱使服务器在它的缓存中接收伪造的记录

### DNS反射攻击

利用DNS服务攻击其它主机。
构造大量DNS请求，将请求的源伪造为待攻击的主机，精心设计请求报文使得回答报文的大小大于请求报文的大小，从而起到放大攻击流量的作用。



0人点赞

计算机网络

# 计算机网络——应用层-P2P文件分发

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.09.25 14:40:10字数 1,584阅读 9

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# P2P对等体系结构

对一直开启的基础设施服务器有最小程度的依赖，成对间歇连接的主机（对等方）彼此直接通信。

## P2P文件分发与C/S文件分发的对比

**文件分发模型**

- 将一个文件分发给一个固定的集合。
- 假定因特网核心带宽充足，网络瓶颈在接入网
- 服务器接入链路上载速率![u_s](https://math.jianshu.com/math?formula=u_s)
- 对等方![i](https://math.jianshu.com/math?formula=i)接入链路上载速率![u_i](https://math.jianshu.com/math?formula=u_i)
- 对等方![i](https://math.jianshu.com/math?formula=i)接入链路下载速率![d_i](https://math.jianshu.com/math?formula=d_i)
- 待分发文件大小![F](https://math.jianshu.com/math?formula=F)
- 要获得该文件的对等方数量![N](https://math.jianshu.com/math?formula=N)

### 客户/服务器文件分发

服务器向每个客户发送文件的一个副本，服务器负担大，服务器流量消耗大

![D_{cs} = max \{ \frac{NF}{u_s},\frac{F}{d_{min} } \}](https://math.jianshu.com/math?formula=D_%7Bcs%7D%20%3D%20max%20%5C%7B%20%5Cfrac%7BNF%7D%7Bu_s%7D%2C%5Cfrac%7BF%7D%7Bd_%7Bmin%7D%20%7D%20%5C%7D)

对足够大的N,分发时间随N线性增加

### P2P文件分发

每个客户作为对等方，可重新分发它所有的文件的任何部分。

![D{p2p} = max \{ \frac{F}{u_s}, \frac{F}{d_{min}},\frac{NF}{u_s+\sum_{i=1}^{n}u_i}\}](https://math.jianshu.com/math?formula=D%7Bp2p%7D%20%3D%20max%20%5C%7B%20%5Cfrac%7BF%7D%7Bu_s%7D%2C%20%5Cfrac%7BF%7D%7Bd_%7Bmin%7D%7D%2C%5Cfrac%7BNF%7D%7Bu_s%2B%5Csum_%7Bi%3D1%7D%5E%7Bn%7Du_i%7D%5C%7D)

**扩展性** 对于变量用户规模，客户/服务器体系的总传输时间是线性的，而P2P体系的总传输时间是亚线性且有上界的。

## BitTorrent协议

用于文件分发的流行P2P协议。

**洪流(torrent)** 参与一个特定文件分发的所有对等体的集合

**文件块** 洪流中的对等方彼此传输等长的文件块；

**追踪器（tracker）** 一个对等方加入洪流时，向追踪器注册自己，并周期性地通知追踪器自己仍在洪流中。追踪器维护正在参与洪流的对等方列表。
BitTorrent协议中的追踪器是分布式的，即后文中的DHT。

**邻近对等方** 洪流中，成功创建TCP连接的一对对等方 。

新对等方A加入洪流时，追踪器（随机地）将洪流的某个子集中所有对等方的ip地址发送给A;
A持有该对等方列表，并试图与该列表上的所有对等方创建并行的TCP连接；
A的邻近对等方不断变动，旧邻近对等方可能离开，新邻近对等方可能与A成功创建TCP连接；
A周期性地询问邻近对等方所持有的块列表，并根据列表信息，对A自身当前未拥有的块发出请求；

**最稀缺优先技术** 对等方A在决定请求哪些块时，首先请求那些A的邻近对等方中副本最少的块，以大致均衡每个块在洪流中的副本数量。

**对换算法** 对等方A决定响应邻近对等方们的那个请求。A根据当前向它提供数据的邻居的速率，给出优先权。每个时间周期，A根据优先权决定它向哪些邻居传送数据；每过多个时间周期，A随机选出一个邻居并向他发送数据。
以上关于交换的激励机制常被称为一报还一报。这种激励方案能被回避。但事实上，BitTorrent的生态比较成功。

## 分布式P2P体系数据库，DHT

**中心式数据库模型**
客户/服务器体系，中心数据库存储键值对，客户可用特定键查询值。

**分布式散列表(Distributed Hash Table,DHT)**
分布式P2P体系，大量对等方维护一个键值对的表，每个对等方只存储该表的一个小子集。
允许任一对等方用一个特定键查询该分布式数据库。分布式数据库定位拥有该键值对的对等方，并返回该键值对。
允许任一对等方向数据库中插入新键值对。

### 朴素设计

在所有对等方中随机分布键值对，每个对等方维护一个所有参与对等方的表。查询键k时向所有其他对等方发送查询。维护键k的对等方向查询者发送响应。
此方案无扩展性，随对等方数量增多，数据库复杂性大大增加。

### 基于散列的设计

为每个对等方分配一个标识符id，id为n比特整数。
定义将键映射到n比特整数的哈希函数。

**中心问题**
定义为对等方分配键的规则。

对键key，为id最邻近hash(key)的对等方分配该键值对。
最邻近：键的最邻近后继

插入键值对：确定最邻近该键hash的对等方，而后向该对等方发送查询报文。
如何确定最邻近该键hash的对等方？恰当组织数据库结构

### DHT结构

将DHT组织为连通图
连通度过高，每个对等方需维护的邻居数过多
连通度过低，DHT为解析一个查询而需转发的报文次数过多

**环形DHT**
将对等方组织为环，每个对等方仅与其直接后继和直接前驱联系。

对等方收到一个查询报文时，判断是否应有自己处理该报文，若不是，则将报文转发给后继邻居

**捷径DHT**
以环形DHT为基础，为每个对等方维护适量的捷径对等方。

对等方收到一个查询报文时，判断是否应有自己处理该报文，若不是，则将报文转发给最邻近该键hash的邻居

研究表明，DHT可被设计为每个对等方的邻居数和每个请求的报文转发次数都在O(logN)，N为对等方总数

#### 对等方扰动

P2P体系中，对等方可不加警示地到来或离去。

为处理对等方扰动，每个对等方应存储冗余的邻居信息。如环形DHT中每个对等方可以同时存储第一后继和第二后继。



0人点赞

计算机网络

# 计算机网络——传输层-概述

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.09.25 14:40:17字数 755阅读 10

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 概述

运输层协议为不同主机上的进程提供逻辑通信。
运输层协议在端系统中实现。

**报文段(segment)** 运输层分组
*某些文献中，将TCP运输层分组称作报文段，UDP运输层分组称作数据报，将网络层分组也称作数据报。*

- 在发送端，运输层从发送进程接收报文，将之转换为若干报文段，并将报文段传递给发送端的网络层，网络层将之转换为网络层数据报并发往目的地端系统；
- 在接收端，网络层接收数据报并提取还原为运输层报文段，将报文段上交给运输层，运输层处理报文段，将之还原为报文，交付接收进程。

因特网运输层提供TCP和UDP两种协议。

## 运输层与网络层的关系

- 网络层提供主机间的逻辑通信，运输层提供不同主机上进程间的逻辑通信。
- 运输层依赖网络层提供的服务。
- 运输层协议只工作在端系统中，在端系统中运输层协议负责将报文在进程和网络边缘（网络层组件）间传输。
- 运输层协议不关心报文在网络核心中的传输，网络层路由器不处理也不识别运输层加在报文中的任何信息。
- 运输层协议能提供的服务受限于底层网络层协议的服务模型。
- 运输层协议能通过一些工作为上层提供底层网络层协议不能提供的一些功能。

## 网络层简介

网络层协议：网际协议 IP
IP为主机间提供逻辑通信

IP 服务模型是**尽力而为交付服务**，即IP尽力在通信的主机间交付报文，但不做任何确保，是不可靠服务。

**IP地址** 网络层地址，每台主机至少有一个IP地址

## TCP/UDP简介

**基本服务**

1. 将端系统间的IP交付服务扩展为运行在端系统上的两进程间的交付服务，即运输层多路复用与多路分解。
2. 提供完整性检查，即差错检验。

**不提供的服务**

1. 延迟保证
2. 带宽保证

### **用户数据报协议，UDP**

仅提供以上两项基本服务

### **传输控制协议，TCP**

在两项基本服务之外，提供附加服务

1. 可靠数据传输 确保正确地，按序地将数据从发送进程交付给接收进程
2. 拥塞控制 防止任何一条TCP连接用过多的流量来淹没通信主机之间的链路和交换设备以优化整个因特网环境。

# 多路复用与多路分解

将由网络层提供的主机到主机的服务扩展到主机间进程到进程的交付服务。

**套接字**
 运输层和应用层间的编程接口。
 进程可拥有一个或多个套接字；
 运输层事实上是从套接字获取数据，并向套接字交付数据。

**端口号**
 报文段中有源端口号字段，目的端口号字段以指示报文要交付到的套接字。
 16bit [0,65535]

**周知端口号**
 0~1023
 保留给周知应用层协议。
 [IANA文档](https://links.jianshu.com/go?to=https%3A%2F%2Fwww.iana.org%2Fassignments%2Fservice-names-port-numbers%2Fservice-names-port-numbers.xhtml)

**多路分解**
 在接收端，将运输层报文段中的数据交付到正确的套接字

**多路复用**
 在发送端，从不同套接字中收集数据块，并为每个数据块封装上首部信息从而生成报文段，而后将报文段传递到网络层。

### 无连接的多路复用与多路分解

UDP套接字由二元组（目的IP，目的端口号）标识。（但相应运输层报文段中仍包含源ip,源端口）
 这意味着有着不同（源IP，源端口号）的UDP报文段可以被定向到相同UDP套接字

### 面向连接的多路复用与多路分解

TCP套接字由四元组（源IP，源端口号，目的IP，目的端口号）标识。

作者：疼呃

链接：https://www.jianshu.com/p/9d0524833b8e

来源：简书

著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

# UDP(User Datagram Protocol)

UDP 提供多路复用/分解功能和低限度的差错检测功能，此外几乎没有对IP协议增加其它。

参加 [RFC 768]

要在UDP上实现可靠数据传输需在应用层实现可靠性机制。

**优点**

1.  **控制精确** UDP会立即将进程交付的数据打包，交付网络层，而不做其它工作
2.  **无需连接建立** 无需握手，没有连接建立的时延
3.  **无连接状态** 无需维护连接状态，资源消耗少
4.  **分组首部开销小** UDP报文首部仅8byte

**常见UDP应用**

- DNS域名转换
- RIP路由选择表更新
- SNMP网络数据管理
- 某些多媒体应用

## UDP差错检测

- UDP只提供差错检测，不提供差错恢复。某些实现丢弃受损的报文段，某些实现交付受损的报文段并给出警告。
- 许多链路层协议提供了差错检验，但端到端路径上任可能有未提供差错检验的链路。此外，存储于交换机内存时，bit差错也可能被引入分组。故UDP提供端到端的差错检验。
-  **端到端原则**  某功能必须基于端到端实现：与在较高层级提供该功能的代价相比，在较低层级上设置的功能可能是冗余的或几乎没有价值的。

**发送方**

1. 将段的内容视为16-bit整数
2. 校验和计算：计算所有整数的和，进位加在和的后面，将得到的值按位求反，得到校验和
3. 发送方将校验和放入校验和字段

**接收方**

1. 计算所收到段的校验和
2. 将其与校验和字段进行对比
    • 不相等：检测出错误
    • 相等：没有检测出错误（但可能有错误）

## UDP报文段



![img](https:////upload-images.jianshu.io/upload_images/19345082-c6a53a05f91ad0b5.png?imageMogr2/auto-orient/strip|imageView2/2/w/633/format/webp)

UDP报文段

**首部字段**
 4个首部字段，每个2byte。

1. 源端口号
2. 目的端口号
3. 长度
4. 检验和

**数据字段**
 应用数据

作者：疼呃

链接：https://www.jianshu.com/p/989ff0cf7d94

来源：简书

著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

# 可靠数据传输原理

可靠数据传输的实现问题在应用层，运输层，网络层，链路层普遍存在，本节在一般情境下讨论可靠数据传输。

为上层实体提供的服务抽象：数据可通过可靠信道传输。

### 可靠信道

1.**不错**  数据流中的比特不会反转
 2.**不乱**  所有数据包按其发送顺序交付
 3.**不丢**  数据包不会丢失

# 可靠数据传输协议设计

- 渐进地设计可靠数据传输协议的发送方和接收方
- 只考虑单向数据传输，但控制信息双向流动
- 利用状态机刻画传输协议

## 接口



![img](https:////upload-images.jianshu.io/upload_images/19345082-3b1165fe3ccf05c2.png?imageMogr2/auto-orient/strip|imageView2/2/w/1033/format/webp)

可靠数据传输协议基本结构.png

## Rdt 1.0——底层信道完全可靠

#### 假定

- 底层信道完全可靠，即底层信道不错，不乱，不丢

#### 状态机



![img](https:////upload-images.jianshu.io/upload_images/19345082-adfbb7c2b031bab2.png?imageMogr2/auto-orient/strip|imageView2/2/w/500/format/webp)

发送方.png



![img](https:////upload-images.jianshu.io/upload_images/19345082-9bce0f468d6aff1a.png?imageMogr2/auto-orient/strip|imageView2/2/w/444/format/webp)

接收方.png

## Rdt 2.0——底层信道可能有位错误

#### 假定

- ！底层信道可能翻转分组中的位，但假定接收方的反馈报文不会发送错误
- 底层信道不乱不丢

#### 应对机制

##### 差错检测

一种使得接收方可以确认分组是否含比特差错的机制

- 利用校验和检测位错误
- ACK:接收方显式通知发送方分组已正确接收
- NAK:接收方显式通知发送方分组存在差错

##### 差错恢复

- 发送方得知分组出错后（收到NAK），重传分组
- 基于这种重传机制的rdt协议称为自动重传请求协议（Automatic Repeat reQuest,ARQ）

##### 停—等协议

发送方发出一个分组后，等待接收方的反馈（ACK或NAK），在等待状态下，发送方不会发出新的分组

#### 新机制

- 差错检测
- 接收方反馈控制消息: ACK/NAK
- 重传

#### 状态机



![img](https:////upload-images.jianshu.io/upload_images/19345082-3dc0cbaccca62e46.png?imageMogr2/auto-orient/strip|imageView2/2/w/623/format/webp)

发送方.png



![img](https:////upload-images.jianshu.io/upload_images/19345082-9b02dda8271c5bbe.png?imageMogr2/auto-orient/strip|imageView2/2/w/332/format/webp)

接收方.png

## Rdt 2.1——接收方反馈可能受损

#### 假定

- ！底层信道可能翻转分组中的位，特别的，接收方的反馈报文也可能发生错误
- 底层信道不乱不丢

#### 应对机制

##### 差错检测

- 为ACK/NAK增加校验和

##### 差错恢复

- 发送方收到受损的接收方反馈报文后，重传当前分组

##### 冗余分组问题

- 发送方对受损ACK或NAK直接重传分组的策略，引入了冗余分组，为处理冗余分组：
   发送方对分组编号，接收方记住上一个收到的分组编号，此处只需{0,1}编号；
   接收方收到重复的分组时，丢弃分组并发送该分组的ACK；

#### 新机制

- 增加了对反馈报文的差错检测机制和差错恢复机制
- 引入了冗余分组问题
- 为每个分组增加了序列号{0，1}

#### 状态机



![img](https:////upload-images.jianshu.io/upload_images/19345082-83092767bf201b86.png?imageMogr2/auto-orient/strip|imageView2/2/w/877/format/webp)

发送方.png



![img](https:////upload-images.jianshu.io/upload_images/19345082-bf27067519e5854b.png?imageMogr2/auto-orient/strip|imageView2/2/w/1054/format/webp)

接收方.png

## Rdt 2.2——无NAK消息协议

#### 假定

同Rdt 2.1

- 底层信道可能翻转分组中的位
- 底层信道不乱不丢

#### 目标

- 在设计上消除反馈报文NAK以实现简化

#### 新机制

- 取消NAK
- 接收方在反馈报文ACK中加入对应分组的编号
-  **冗余ACK策略**
   接收方收到错误分组i+1后，发送一个对分组i的ACK;
   发送方收到对分组i的两个ACK后，可断定接收方没有正确接收分组i+1,故应重传分组i+1

#### 状态机



![img](https:////upload-images.jianshu.io/upload_images/19345082-e06c3a44f1d6a927.png?imageMogr2/auto-orient/strip|imageView2/2/w/1008/format/webp)

状态机片段

## Rdt 3.0——底层信道可能丢失分组

#### 假定

- 底层信道可能翻转分组中的位
- ！底层信道可能丢失分组
- 底层信道不乱，即分组被按其发送顺序接收。

#### 关注点

- 如何检测丢包，丢包发生后如何处置

#### 丢包检测与恢复

- 发送方等待合理时间，若该时间内未收到ACK,则重传分组

可能的情况：

1. 发送方发送的数据分组丢失
2. 接收方发送的ACK分组丢失
3. 数据分组或ACK分组传输的时延过长

#### 冗余

- 接收方发送的ACK分组丢失会引发发送方重传，其结果是接收方收到冗余数据分组
- 发送方发送的数据分组传输时延过长会引发发送方重传，其结果是接收方收到冗余数据分组
- 接收方发送的ACK分组传输的时延过长会引发发送方重传，其结果是发送方收到冗余ACK

以上冗余状况都可以依靠分组编号机制解决

#### 状态机



![img](https:////upload-images.jianshu.io/upload_images/19345082-dde925ac52f81c45.png?imageMogr2/auto-orient/strip|imageView2/2/w/917/format/webp)

发送方.png

#### 分析

- Rdt 3.0能够正确工作，但性能很差
- 原因在于停等机制，大部分的时间发送方都在等待对上一个分组的确认
- 由于停等机制，信道上的分组几乎不可能乱序，故rdt3.0是可以实际工作的，问题在于效率过低

作者：疼呃

链接：https://www.jianshu.com/p/63af9c7b5943

来源：简书

著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

# 计算机网络——传输层-滑动窗口协议

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.09.26 15:43:05字数 1,135阅读 15

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 流水线可靠数据传输协议

*停等协议的效率极低，发送方的理论效率不到链路物理上限的千分之一*

**流水线**
允许发送方发送多个分组而无需等待确认

流水线技术：

1. 分组编号 每个输送中的逻辑分组（即不计重传）必须有唯一序号
2. 分组缓存 发送方和接收方必须缓存多个分组
3. 差错恢复 包括回退N步和选择重传两种基本方法

## 滑动窗口协议

- 用于实现流水线机制的技术

**窗口**

- 允许使用的序列号范围
- 对发送方，已被发送但未被确认的分组的许可序号范围以及可用序号的范围
- 窗口长度为N：最多有N个等待确认的消息

**滑动窗口**

- 随着协议的运行，窗口在序列号空间内向前滑动

**重传机制**

- 根据重传机制的不同，有回退N步和选择重传两者实现

## 回退N步(Go-Back-N,GBN)

以回退N步作为差错恢复机制的滑动窗口协议

**分组序号**

- **基序号** 最早的未确认分组的序号
- **下一个序号** 下一个待发送分组的序号，即最小的未使用序号

**累积确认** 对序号n的ACK代表接收方已经正确接收序号不超过n的所有分组

#### 发送方行为

1. 上层调用 若窗口未满，产生分组并发送之，同时更新相应状态；若窗口已满，暂不发送（缓存数据，通知上层，同步机制等方式）
2. 收到ACK
3. 超时事件 若出现超时，重传所有已发送且未确认的分组

#### 接收方行为

对按序到达的分组，接收并发送ACK；对失序分组，直接丢弃，并重新确认序列号最大的、按序到达的分组

#### 特点

接收方只需要记住一个待接收分组序号
接收方没有分组缓存

**回退N步的问题** 单个分组的差错能引起大量分组的重传

#### 状态机



![img](https://upload-images.jianshu.io/upload_images/19345082-e01057cf60461bcf.png?imageMogr2/auto-orient/strip|imageView2/2/w/861/format/webp)

发送方.png



![img](https://upload-images.jianshu.io/upload_images/19345082-522146ee6a5c826d.png?imageMogr2/auto-orient/strip|imageView2/2/w/912/format/webp)

接收方.png

## 选择重传（Selective Repeat,SR）

选择重传协议让发送方仅重传那些它怀疑在接收方出错的分组，以避免不必要的重传。

#### 新机制

- 不再使用累积确认，ACK只确认特定分组。
- 接收方设置缓存，缓存乱序到达的分组
- 发送方只重传那些没收到ACK的分组，为每个分组设置定时器

#### 发送方行为

- 从上层收到数据 检查下一个可用于该分组的序号，若序号位于发送方窗口内，则打包数据并发送。否则暂不发送（缓存，通知上层，同步机制等待）
- 分组超时 每个已发送未确认分组都有一个逻辑定时器，一定时间内未收到该分组的ACK则重传之
- 收到分组i的ACK 若i在窗口内，将该分组标记为已确认。若i=窗口基序号，则窗口前移。若窗口前移了且有序号落在窗口内的未发生分组，则发送这些分组。

#### 接收方行为

- 确认正确接收的分组。若该分组失序，则将之缓存直至所有该分组之前的分组都被接收，再将一批连续的分组按序交付上层。若该分组已被正确接收（说明对该分组的ACK丢失或损坏了），仍要发送一个ACK。

#### 状态机



![img](https://upload-images.jianshu.io/upload_images/19345082-09ac736c4bcfa2b0.png?imageMogr2/auto-orient/strip|imageView2/2/w/481/format/webp)

发送方.png



![img](https://upload-images.jianshu.io/upload_images/19345082-6d6c7cd8ca31d7ad.png?imageMogr2/auto-orient/strip|imageView2/2/w/483/format/webp)

接收方.png

#### 序列号空间大小限制

问题：序列号空间大小与窗口
尺寸需满足什么关系？
NS+NR<=2k

# 底层信道具有分组重排序的可能

即分组通过链路网络传播时，分组序列的接收顺序和分组序列的发送顺序可能不一致。

具有分组重排序可能性的信道，可视为信道具有缓存分组，并在将来任意时刻释放所缓存的分组的可能。

实际应用中，通常假定分组在底层信道中存活时间不会超过某个固定值（如3分钟）。

# 计算机网络——传输层-TCP

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.09.27 19:35:27字数 3,920阅读 7

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 概述

### TCP服务

- **多路复用与多路分解**
  将端系统间的IP交付服务扩展为运行在端系统上的两进程间的交付服务，即运输层多路复用与多路分解。
- **可靠数据传输**
  即保证分组不错不丢不乱
- **拥塞控制**
  防止任何一条TCP连接用过多的流量淹没通信主机之间的链路和交换设备以优化整个因特网环境

### TCP特点

- **三次握手** 两进程在通过TCP传递传递有效数据前，必须互相握手，即发送某些预备报文段以建立确保数据传输的参数。
  客户首先发出一个特殊报文段，服务器用另一个特殊报文段响应，最后，客户用第三个特殊报文段作为响应。前两个特殊报文段不承载有效载荷，第三个报文段可以承载有效载荷。
- **面向连接**
  通信双方在发送数据之前必须建立连接。
  TCP协议仅在端系统中运行，连接状态在端系统中维护，中间网络元素不会维护TCP连接状态。
- **双全工服务** AB两进程间的TCP连接可以从A向B传输数据也可以从B向A传输数据。
  TCP是双全工的
- **点对点** TCP是点对点的，不支持多播
  *多播*： 一次发送操作中，从一个发送方将数据传输给多个接收方
- **缓存上层数据** 发送方应用层通过套接字向TCP传递数据，TCP将数据引导至该连接的发送缓存中，发送缓存在三次握手期间设置。
- **最大报文段（有效载荷）长度(Maximun Segment Size,MSS)** TCP可以从缓存中取出并放入报文段中的最大数据数量。 MSS通常根据最大链路层帧长度设置。该设置保证一个TCP报文段封装在IP数据报中后，再加上TCP/IP的首部，其总长度将适合单个链路层帧。
- **流水线机制** TCP使用流水线机制，但结合了GBN和SR的特点，在收发双方都设置有缓存

### TCP连接的组成

- 两个端系统中，各自的TCP缓存，变量，与进程连接的套接字。
- 两端系统之间的网络元素没有为该连接分配任何缓存和变量。

# TCP报文段

TCP报文段由首部字段和数据字段组成。数据字段最大长度由MSS限制。



![img](https://upload-images.jianshu.io/upload_images/19345082-fb25f4b1e51d1c8a.png?imageMogr2/auto-orient/strip|imageView2/2/w/688/format/webp)

TCP报文段.png

## 首部字段结构

1. **源端口号** 用于多路复用/分解
2. **目的端口号** 用于多路复用/分解
3. **序号字段** 32bit 用于实现可靠数据传输
4. **确认号字段** 32bit 用于实现可靠数据传输
5. **接收窗口字段** 16bit 用于流量控制
6. **检验和字段** 16bit 用于差错检测
7. **首部长度字段** 4bit 指示TCP首部长度。（选项字段常为空，故TCP首部典型长度为20byte）
8. **选项字段** 可选的，变长的。 可用于协商MSS大小，传输窗口调节因子，时间戳等。
9. **标志字段** 6bit
   ACK位用于指示该报文段包括对一个已被成功接收的报文段的确认。
   RST，SYN,FIN位用于连接的建立与拆除。
   PSH位指示接收方应立即将数据交付上层。
   URG位指示报文段中存在被发送端上层实体设置为紧急的数据。
   在实践中，PSH，URG未被使用。 （然鹅可以监测到一些报文的PSH位被置位）

# TCP可靠数据传输

### 序号和确认号

TCP将数据视为无结构的有序字节流。

**报文段序号** 序号建立在传送的字节流上而非建立在传送的报文段序列上。报文段序号是该报文段首字节的字节流编号。发送方TCP隐式地对字节流中的每一个字节编号，将一个报文段中首字节的字节编号作为该报文段的序号。

**确认号** 主机A填充进报文段的确认号是主机A期望从主机B收到的下一字节的序号。

**累计确认** TCP只确认流中至第一个丢失字节为止的字节。即确认号之前的所有字节都已正确接收。

**失序报文段** TCP RFC 中未规定如何处理收到的失序报文段。实现者可以令接收方直接丢弃失序报文段，也可以令接收方缓存失序的字节。实践中一般缓存失序的字节。

**初始序号** 一条TCP连接双方可以随机地选择初始序号，以减小将网络中的其它报文段（先前建立，现已关闭的连接）误认为本连接报文段的可能。

**确认信号** 确认报文段可以在一个独立的报文段中传输（数据字段为空），也可以被一个含有效数据的报文段捎带。

## 丢包检测与恢复

- TCP提供定时器超时和冗余ACK两种丢包检测机制（冗余ACK也可表征包错误）
- 相应地，TCP提供超时重传和快速重传两种丢包恢复机制（快速重传也可恢复包错误）

### TCP超时机制

- TCP需要超时重传机制以处理报文段的丢失。
  一个重要的问题是如何设置超时间隔的长度。
  RTT可以作为超时间隔长度设置的一个重要参考。

### 往返时间估计

**往返时延(Round-Trip Time,RTT)** 从发送端发送一段数据开始，到发送端收到来自接收端的确认总共经历的时延。
RTT由三个部分决定：链路的传播时间，端系统的处理时间，路由器的缓存中的排队和处理时间。

**样本RTT（SampleRTT）** 报文段的样本RTT是 从某报文段交付IP到对该报文段的确认被收到之间的时间量。TCP根据具体实现在某些时刻作样本RTT测量。只可能为已发送未确认报文段做测量，不会为已重传报文段做测量
报文段的样本RTT会随着路由器拥塞和端系统负载情况变化，任一给定样本RTT都是非典型的。

**平均RTT（EstimatedRTT）** TCP维护样本RTT的均值，每获得一个新样本就更新该均值。
![EstimatedRTT = （1-a) * SampleRTT + a * SampleRTT](https://math.jianshu.com/math?formula=EstimatedRTT%20%3D%20%EF%BC%881-a)%20*%20SampleRTT%20%2B%20a%20*%20SampleRTT)
这是一种老化算法，或称指数加权移动平均。新样本权重大于老样本权重。
a常取1/8

**偏差RTT（DevRTT)** 描述RTT的偏差
![DevRTT = （1-b) * DevRTT + b * | SampleRTT - EstimatedRTT |](https://math.jianshu.com/math?formula=DevRTT%20%3D%20%EF%BC%881-b)%20*%20DevRTT%20%2B%20b%20*%20%7C%20SampleRTT%20-%20EstimatedRTT%20%7C)
b常取1/4
RTT波动越大，DevRTT越大

### 超时间隔加倍

- 每当超时事件发生时，TCP会重置定时器，且新TimeoutInterval为原TimeoutInterval的两倍。而在其它情况下，TimeoutInterval或根据EstimatedRTT和DevRTT计算，或使用初始值。
- 超时间隔加倍潜在的提供了一定的拥塞控制功能。因为超时事件很可能是由网络拥塞引起的，超时间隔加倍有助于缓解拥塞。

### 重传超时间隔 TimeoutInterval

![TimeoutInterval = TimeoutInterval_{(0)}](https://math.jianshu.com/math?formula=TimeoutInterval%20%3D%20TimeoutInterval_%7B(0)%7D) （0） 初始值
![TimeoutInterval = EstimatedRTT + 4*DevRTT](https://math.jianshu.com/math?formula=TimeoutInterval%20%3D%20EstimatedRTT%20%2B%204*DevRTT) (1) 正常事件
![TimeoutInterval = 2*TimeoutInterval](https://math.jianshu.com/math?formula=TimeoutInterval%20%3D%202*TimeoutInterval) (2) 超时事件

即通常情况下超时间隔大于平均往返时间，RTT波动越大，超时间隔的余量也应越大。
初始TimeoutInterval常设为1秒，出现超时后TimeoutInterval翻倍

### 快速重传

报文丢失时，因超时周期可能较长，通过超时机制触发的重传可能导致端到端时延过长。

**冗余ACK** 是发送方检测丢包的另一手段。冗余ACK即对同一个报文段的多个ACK。

**快速重传**
发送方收到三个冗余ACK，即收到同一个报文的四个ACK时，执行快速重传，即在超时事件发生之前重传丢失的报文段。
为什么是三次冗余ACK？因为分组重排（乱序）也会导致冗余ACK，三次冗余ACK从概率上或者说从实践经验上强烈地指示发送方很可能发生了丢包而非乱序。

### 收发双方行为

**发送方事件**

1. **接收上层数据**
2. **定时器超时**
3. **收到ACK**

**接收方ACK产生策略** [RFC 5681]
假定接收方期望下一个到达的报文段为i

- 若 报文段i到达，且i之前的所有报文都已被确认（发送了i-1的ACK） 则 延迟ACK。等待报文段i+1 500ms，若500ms后i+1未到达，发送i的ACK
- 若 报文段i到达，且i之前有报文未被确认（i-1的ACK未被发送） 则 立即发送单个累积ACK（i的ACK）,以确认两个按序报文段
- 若 报文段j到达，j>i,即检测出失序 则 立即发送一个冗余ACK（即发送i-1的ACK）以指示下一个期待的报文段为i
- 若 报文段i到达，且i能部分或完全填充之前失序接收的报文序列间的间隔， 则 立即发送i的ACK

## TCP差错恢复机制——回退N步与选择重传

- TCP使用累积确认技术，正确接收但失序的报文段不会被接收方逐个确认，对报文段i的确认代表i之前的所有报文都已正确接收。
- 基于累积确认，TCP发送方仅需维护已发送但未被确认的最小序号和下一个待发送字节的序号即可。
- 大多数TCP实现会将正确接收但失序的报文段缓存起来。当报文i的ACK超时后，TCP不会依照回退N步的策略将报文段i，i+1.....N都重传，而是只重传报文段i。
- TCP的差错恢复机制是回退N步与选择重传的结合。

## 流量控制

- 速度匹配服务，即匹配发送方的发送速率与接收方的接收速率。
  TCP连接的两侧有各自的缓冲区，若发送/接收速率不匹配，易造成缓冲区溢出。
- **流量控制与拥塞控制** 两者的措施都是抑制发送方，但两者目的不同。流量控制在接收方速率低于发送方速率时抑制发送方，拥塞控制在网络拥塞时抑制发送方。
- **接收窗口** 发送方维护的一个状态变量，用以实现流量控制。接收窗口给发送方关于接收方还有多少可用缓存空间的指示。
- 接收方在给发送方的报文中，包含关于自身剩余缓存大小的字段，即接收窗口字段。
- 发送方应当保证所有已发送未确认分组的总数据量不会超出接收窗口。
- **零接收窗口** 在接收窗口为0时，若完全抑制发送方，则即使将来接收方的缓存有空余，也无法通知发送方。故即使在接收窗口为0时，发送方也会发生带一个字节数据的报文段，以备接收方确认。

# TCP连接管理

本节考察TCP连接的建立与拆除。

## 连接建立

**三次握手**

1. **SYN报文段m1**
   客户端TCP向服务端TCP发送一个特殊TCP报文段m1，m1被称为SYN报文段；
   m1不含应用层数据；
   m1的首部中标志位SYN置为1；
   客户端还会选择一个随机序号client_isn，置于m1的序号字段中，作为发送方初始序号；
2. **SYNACK报文段m2**
   当m1到达服务端后，服务器为服务器侧的该TCP连接分配缓存和变量，并向客户TCP发送允许连接的报文段m2;
   m2不含应用层数据；
   m2的SYN位被置位1；
   m2首部的确认号字段被置为client_isn+1;
   服务器选择自己的初始序号server_isn，将之置于序号字段;
3. **确认与数据报文段m3**
   客户端收到m2后，为该TCP分配缓存和变量;
   客户向服务端发送报文段m3；
   m3对服务器的允许连接报文段m2进行了确认，即将server_isn+1置于确认字段;
   此时连接已经建立，故m3的SYN比特置为0;
   报文段m3中可携带有效负载;

三次握手之后，TCP连接上可用发送数据报文段。数据报文段的SYN比特都被置为0。

### SYN洪泛

- 注意在三次握手中，第一次握手发起方不会为TCP分配资源，第二次握手接收方会为TCP分配资源，第三次握手发起方会为TCP分配资源。
- 故而，发起方若只发送第一次握手，就可以在很少的代价下（发起方不必为TCP维护资源）让接收方付出较大的代价（接收方为TCP分配资源直至等待第三次握手超时）。
- **SYN cookie**
  SYN cookie技术可以很好地应对SYN洪泛攻击。对于部署了SYN cookie的操作系统，接收方在第二次握手时不会分配资源，而是把状态信息，TCP标识（双方IP，port），接收方秘密值一起hash加密后作为初始序号，放置到第二次握手的序号字段中。接收方只有在收到第三次握手信号并验证后才会为TCP分配资源。
  在这种情况下，要施时SYN洪泛的发起方必须消耗较多资源维护连接信息。

## 连接拆除

- 参与TCP连接的两者之任一都可以终止该连接。连接结束后，端系统中的相关资源将被释放。
- 终止连接时，终止发起方发送一个特殊的TCP报文段，该报文段首部行中的FIN标志位被置为1；
- 另一方接收到该报文段后，向发送方回送一个确认报文段，并向终止发起方发送自己的终止报文段，该报文段中FIN标志位为1；
- 最后，终止发起方对另一方的终止报文段进行确认；

## 套接字不匹配

考察端系统收到一个TCP报文段，而该报文段没有匹配套接字的情况，即没有服务端进程在监听相应端口的情况。
此时，主机向源发送一个特殊的重置报文段，该报文段将RST位置为1。

UDP套接字不匹配时，主机向源发送一个特殊的ICMP数据报。



0人点赞

计算机网络

# 计算机网络——传输层-拥塞控制原理

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.09.28 19:32:50字数 756阅读 17

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 拥塞

- 太多发送主机发送了太多数据或者发送速度太快，以至于网络无法处理

表现：

- 分组丢失（路由器缓存溢出）
- 分组延迟过大（在路由器缓存中排队）

## 拥塞代价

- **排队时延** 分组传输速率接近链路容量时，即使是在交换机缓存无穷大的情况下，分组承受极大的排队时延。
- **丢包重传** 交换机缓冲溢出导致丢包，发送方必须进行分组重传
- **冗余重传** 冗余副本，发送方在分组时延过大（但并未丢失）的情况下进行不必要的重传，导致交换机利用其链路带宽来转发不必要的副本。
- **劳而无功** 当一个分组被丢弃时，该分组路径上的上游路由器用于转发该分组的传输容量被浪费了

# 拥塞控制方法

## 端到端拥塞控制

- 网络层没有为运输层拥塞控制提供显示支持。对网络中存在的拥塞，端系统必须通过对网络行为（loss，delay，RTT）的观察来推断之。
- TCP采取这种方法

## 网络辅助的拥塞控制

- 网络层构件（路由器）向发送方提供关于网络中拥塞状态的显示反馈信息。

拥塞信息从网络层到发送方的反馈方式有二：

1. **直接反馈信息** 网络层路由器发送特殊分组告知发送方自身处在拥塞状态
2. **间接反馈信息** 路由器标记从发送方流向接收方的分组中的某个字段来指示拥塞状态。接收方收到带该标记的分组后，向发送方通知该网络拥塞信息。

# ATM ABR 拥塞控制

- ATM ABR 技术使用了基于网络辅助的拥塞控制
- ATM 采用虚电路机制下的分组交换。即通信路径上的每台交换机都维护虚电路状态。
- ATM提供弹性数据传输服务。网络轻载时，ABR服务会充分利用空闲带宽；网络拥塞时，ABR服务会将传输速率抑制为某预先确定的最小传输速率。
- ATM分组分两类，数据信元和资源管理信元。
- 资源管理信元用于在主机，交换机间传递网络拥塞相关信息。
- **间接信息反馈**
  发送方在一组数据信元中夹杂一个资源管理信元，路径上的交换机可以修改该资源管理信元，接收方收到该信元后可修改该信元并将之返回给发送方。
- **直接信息反馈**
  交换机可产生资源管理信元并直接将该信元发往发送方。

# 计算机网络——传输层-TCP拥塞控制

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.09.28 19:32:55字数 2,049阅读 18

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# TCP拥塞控制

- TCP使用端到端拥塞控制，因为IP层不向端系统提供显示的网络拥塞反馈。
- TCP令每一个发送方根据所感知到的网络拥塞程度来限制其能向连接发送流量的速率。

问题在于：

1. TCP发送方如何限制它向连接发送流量的速率？
2. TCP发送方如何感知它和目的地间的网络拥塞？
3. 当TCP发送方感知到网络拥塞时，采用何种算法来改变发送速率？

## TCP发送方如何限制它向连接发送流量的速率

**拥塞窗口(congestion window)**

- 发送方TCP的拥塞控制机制维护的一个状态变量。
- 它对TCP发送方能向网络中发送流量的速率进行了限制。
- 发送方中已发送且未被确认的数据量不会超过拥塞窗口（事实上，不会超过拥塞窗口和接受窗口的最小值）

## TCP发送方如何感知它和目的地间的网络拥塞情况

- **丢包事件** 超时事件或收到接收方的三个冗余ACK（一个初始ACK和其后的三个冗余ACK）
- **三个冗余ACK** 是轻度拥塞的表征
- **超时事件** 是重度拥塞的标准
- 发送方将丢包事件作为**网络拥塞的指示**。
- 发送方将对已发送分组的确认ACK作为**网络畅通的指示**。
- 潜在地，发送方还能通过**RTT的变化**来感知网络拥塞情况。

## TCP发送方如何确定合适的发送速率

- 丢包事件指示拥塞，此时TCP发送方应降低发送速率
- 确认报文指示网络畅通，拥塞窗口应当增大。确认到达的速率大，拥塞窗口的增量也应大。
- 带宽探测。TCP在认为网络畅通时，逐步增加速率，在认为网络拥塞时，回退速率，并在稍后继续增加速率以探测拥塞开始速率是否发生了变化

# TCP拥塞控制算法

- TCP拥塞控制算法包括强制的**慢启动**和**拥塞避免**机制，以及推荐的**快速恢复**机制。

## 慢启动

- 指数增
- TCP连接开始时，拥塞窗口的初值通常置为一个MSS，即最大报文段（有效载荷）长度。
- 故初始发生速率约为MSS/RTT，其值往往远小于可用带宽，TCP希望快速找到可用带宽数量。
- 在慢启动状态，拥塞控制窗口从一个MSS开始且每当传输的报文段被确认就增加一个MSS。
- 在慢启动阶段的一个周期(RTT)，发送i个报文（拥塞控制窗口为![i*MSS](https://math.jianshu.com/math?formula=i*MSS)），并收到i个确认，从而将拥塞控制窗口增加到![2i*MSS](https://math.jianshu.com/math?formula=2i*MSS)。故慢启动阶段发送速率以指数增长。

#### 何时结束慢启动阶段？

1. 拥塞控制窗口达到或超过慢启动阈值。
   这意味着继续指数增加发送速率很可能会导致拥塞。结束慢启动并进入拥塞避免模式。
2. 检测到3个冗余ACK。
   这意味着网络的轻度拥塞。
   执行快速重传并进入快速恢复状态。
3. 发生超时事件。
   这意味着网络的重度拥塞。
   重置拥塞控制窗口，并将慢启动阈值置为原拥塞控制窗口的一半。重新开始慢启动阶段。

#### 云服务快速响应——前端服务器&TCP分岔

- 内容提供商希望快速响应用户请求，而慢启动机制下服务器可能需要较长时间处理用户的小请求报文。
- 典型地，从客户端系统发起TCP到数据中心服务器的响应全部到达，需要4*RTT（建立TCP1个RTT，交付响应3个RTT），当客户端系统距离服务器较远时，时延较大。

**解决方案**

- 内容提供商部署CDN服务网络，部署邻近用户的前端服务器。
- 客户连接前端服务器时TCP慢启动，拥塞窗口小但是由于该服务器邻近用户，RTT小故速度快,耗时![4*RTT_{FE}](https://math.jianshu.com/math?formula=4*RTT_%7BFE%7D)。
- 不同客户的请求到达前端服务器后由TCP分岔技术，通过一条大窗口TCP连接向数据中心传递数据，耗时![RTT_{BE}](https://math.jianshu.com/math?formula=RTT_%7BBE%7D)。
- 总响应时间变为 ![4*RTT_{FE}+RTT_{BE}+处理时间](https://math.jianshu.com/math?formula=4*RTT_%7BFE%7D%2BRTT_%7BBE%7D%2B%E5%A4%84%E7%90%86%E6%97%B6%E9%97%B4)，其中![RTT_{FE}](https://math.jianshu.com/math?formula=RTT_%7BFE%7D)可忽略，故总时间约为一个RTT。

## 拥塞避免

- 加性增
- TCP进入拥塞避免状态意味着此时的拥塞窗口大约是上次发生拥塞时窗口值的一半，故不可像在慢启动阶段那样激进地在每个RTT将拥塞窗口翻番，而应采取保守策略，即在每个RTT只将拥塞窗口增加一个MSS。
- 具体方法通常是，对每个新的报文段确认，将拥塞窗口增加（MSS/原拥塞窗口值）byte。从而在一个往返周期内，拥塞窗口可增加一个MSS。
- 故在拥塞避免阶段，拥塞窗口线性增长。

#### 何时结束拥塞避免状态？

1. 三个冗余的ACK。
   这意味着网络的轻度拥塞。
   将拥塞窗口值置为当前值的一半，将慢启动阈值置为原拥塞窗口值的一半。进入快速恢复阶段。
2. 出现超时事件。
   这意味着网络的重度拥塞。
   拥塞窗口重置为一个MSS，慢启动阈值置为当前拥塞窗口值的一半，进入慢启动状态。

## 快速恢复

- 对于引起TCP进入快速恢复状态的缺失报文段，对收到的每个冗余ACK，拥塞窗口递增一个MSS。
- 当对缺失报文段的一个ACK到达时，TCP减小拥塞窗口并进入拥塞避免状态。
- 若出现超时事件，拥塞窗口重置为一个MSS，慢启动阈值置为当前拥塞窗口值的一半，进入慢启动状态。
- 早期TCP版本 Tahoe 在超时或3个冗余ACK后都进入慢启动阶段
- 较新的TCP版本 Reno 综合了快速恢复机制

## 拥塞控制回顾

- 忽略慢启动阶段，TCP是加性增，乘性减的，拥塞窗口-时间图呈锯齿状。
- TCP 有多种拥塞控制算法， linux允许管理员配置拥塞控制的版本。
- **Vegas算法**
  通过RTT，在分组发生丢失之前，检测网络拥塞状况。
  当检测到分组将要丢失时，线性地降低发生速率

## TCP吞吐量（速率）

- 假定TCP链接长期存活，且RTT，拥塞控制窗口峰值W（发生丢包时的值）恒定。
- 从而，速率在W/2RTT和W/RTT间震荡。有平均吞吐量为0.75W/RTT

## 高带宽路径下的TCP

链接平均吞吐量 = ![\frac{1.22*MSS}{RTT\sqrt{L}}](https://math.jianshu.com/math?formula=%5Cfrac%7B1.22*MSS%7D%7BRTT%5Csqrt%7BL%7D%7D)

# 公平性

- 理想地，TCP趋于在竞争的多条TCP连接间提供对一段瓶颈链路带宽的平等分享。这是TCP拥塞控制机制的属性。
- 实践中，TCP连接通常能获得非常不平等的链路带宽份额。
  当多条连接共享一个瓶颈链路时，具有较小RTT的连接能够在链路空闲时更快地抢到可用带宽，获得更高吞吐量。
- **UDP** UDP没有拥塞控制机制，不会扼制流量，从TCP视角看这是不公平的
- **并行TCP** 同一应用通过使用多条并行连接，可用占用较大比例的带宽份额。

# 计算机网络——网络层-概述

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.10.04 20:19:55字数 1,096阅读 14

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 概述

- 网络层提供主机到主机的通信服务；

## 因特网网络层组件

### 软件

1. IP协议
2. 路由选择
3. 因特网控制报文协议

### 硬件

- 因特网的每台主机，路由器实现网络层协议

#### 分组交换机

- 通用分组交换设备，根据分组首部字段中的值，从输入链路接口到输出链路接口转移分组。
- **链路层交换机** 基于链路层字段中的值做转发决定的分组交换机
- **路由器（router）** 基于网络层字段中的值做转发决定的分组交换机

## 网络层功能

- 网络层基本功能是讲分组从一台发送主机移动到一台接收主机。
- 进一步地，包括转发，路由，连接建立三种重要功能。

### 转发

- 涉及分组在单一路由器中从一条入链路到一条出链路的传输
- 当一个分组到达路由器的一条输入链路时，路由器必须将该分组移动到适当的输出链路；

**转发表**

- 每台路由器都具有一张转发表。路由器检查到达分组首部特定字段的值，在转发表中索引查询该值以确定将该分组移动到哪一输出链路。

### 路由选择

- 涉及一个网络的所有路由器如何经路由选择协议共同交互以决定分组从源到目的地的路径
- 当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由（路径）

**路由选择算法**

- 决定路由器中转发表的配置，转发表的配置决定了转发和路由选择间的关系。
- 路由选择算法可以是集中式的或分布式的；
- 路由器接收路由选择协议报文，该报文信息被用于配置路由器转发表；

### 连接建立

- 从源到目的地沿着所选择的路径，各个设备彼此握手。在数据分组开始传输之前建立状态
- 因特网网络层不提供连接建立功能
- ATM，帧中继，MPLS等网络体系结构提供连接建立功能

## 网络服务模型

- 定义分组在发送与接受端系统间的端到端运输特性

网络层可能提供的服务：

A)对某分组

- 确保交付

   

  确保分组最终将到达其目的地

  - **具有延时上界的确保交付** 在特定的端到端时延内确保交付

B)对分组流

- **有序分组交付** 确保分组以它们发送的顺序到达目的地
- **确保最小带宽** 模拟发送端和接受端间有一条特定带宽的专用物理传输链路时分组传输的行为。即只要发送主机以特定比特率传输比特，则分组不会丢失且每个分组会在预定的端到端时延内到达。
- **确保最大时延抖动** 确保发送方两相继分组间的时间间隔与接收方接受对应两分组间的时间间隔之差的绝对值小于特定值
- **安全性服务** 提供数据机密性，完整性，数据源鉴别等服务。发送端网络层将运输层交付的数据加密，而后传输，接受端网络层将收到的数据解码，而后交付运输层。

### 因特网网络层服务模型

- 尽力而为服务（best-effort service） 不做任何保证。
- *“根本无服务”满足“尽力而为服务”的定义。*

### 其它网络体系结构服务模型

#### ATM网络体系结构

- 提供多重服务模型，可以在相同网络中为不同的连接提供不同类别的服务。

##### 恒定比特率ATM网络服务，CBR；

- 模拟发送与接收主机间存在一条专用的，固定带宽的传输链路

##### 可用比特率ATM网络服务，ABR；

- 确保最小带宽且分组不会乱序



0人点赞

计算机网络

# 计算机网络——网络层-虚电路和数据报网络

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.10.08 18:56:52字数 1,472阅读 7

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 虚电路和数据报网络

- 类似于运输层为进程提供无连接服务或面向连接服务，网络层为两台主机提供无连接服务或面向连接服务。
- 目前，各主要计算机网络体系结构中，网络层提供且只提供面向连接服务或无连接服务二者之一。
- 网络层的连接服务与运输层的连接服务存在根本性差别，运输层的连接服务在位于网络边缘的端系统中实现，网络层的连接服务由网络边缘的端系统，网络核心的路由器共同实现。

# 连接服务——虚电路网络(virtual-circuit network )

- 在网络层提供连接服务的计算机网络
- 如ATM，帧中继等网络体系结构
- 虚电路概念源于电话界

- 虚电路是分组交换网络，每个分组的传输利用链路的全部带宽，源到目的路径经过的网络层设备共同完成虚电路功能

## 虚电路

- 网络层连接

**虚电路组成**

- 源和目的主机间的路径，即一系列链路，路由器，收发双方的端系统
- VC号，即沿着路径的每段链路的一个号码
- 沿着路径的每台路由器中的转发表表项

## 路由器支持

- 路由器转发表项类似于： 入接口|入VC号|出接口|出VC号
- 路由器必须为每条进行中的连接维护状态信息
- 创建新虚电路时，对路径上的路由器，增加相应表项
- 拆除虚电路时，对路径上的路由器，删除相应表项

## 虚电路阶段

1. **虚电路建立**
   发送方运输层与网络层联系，指定接收方地址，等待网络层建立虚电路；
   网络层决定发送方与接收方间的路径，并为路径上的每条链路决定一个VC号；
   网络层在路径上的每台路由器中增添一个转发表项；
   网络层可预留路径上的资源，如带宽；
2. **数据传输**
   虚电路上的分组在其首部携带一个vc号（而非目的地址）；
   分组vc号与其当前所在链路的vc号对应；
   路径上的每台中间路由器在某入接口上收到一个到达分组后，根据该分组的vc号，查询转发表，以确定该分组的出接口和出vc号，将该分组的vc号更新并移动分组到相应出接口。
3. **虚电路拆除**
   发送方或接收方通知网络层它希望终止该虚电路，拆除阶段启动；
   网络层通知另一侧的端系统会话结束；
   网络层更新路径上每台路由器的转发表以拆除虚电路；

注意：

- *相较于TCP三次握手，路径上每台路由器都参与且了解虚电路的建立，而TCP连接的建立只在端系统中进行*
- *在虚电路建立阶段，虚电路网络也需要路由（确定路径）。*

## 虚电路信令协议(signaling protocols)

**信令报文** 端系统向网络发送的指示虚电路启动/终止的报文，路由器间传递的用于建立/拆除虚电路的 报文
**信令协议** 定义如何交换信令报文的协议

# 无连接服务——数据报网络(datagram network )

- 在网络层提供无连接服务的计算机网络
- 如因特网等网络体系结构

- 端系统发送分组时，为分组加上指示目的地端系统地址的首部行并将该分组推入网络；

## 路由器支持

- 路由器使用分组的目的地址转发分组；
- 路由器的转发表将目的地址映射到输出链路接口；
- 具体地，转发表维护ip地址前缀到输出链路接口的映射；
  对到达分组的ip地址，路由器在转发表中进行前缀匹配，若有多个匹配项，则依据最长前缀匹配规则确定匹配；

- 路由器不维护连接信息，但维护转发状态信息;
- 转发状态信息变化的时间尺度相对慢于连接信息变化的时间尺度;
- 转发表通过路由选择算法更新，通常每1~5分钟更新一次转发表;

## 因特网与数据报网络

- 基于数据报网络体系的因特网服务模型使得服务保证最少（即没有保证），这对网络层施加了最小限度的需求；
- 这一体系使得因特网使用各种不同链路层技术较为容易；
- 新服务可通过端系统上的应用层协议快速部署实现；

# 数据报网络 VS 虚电路网络

## 数据报网络

简化网络，复杂“边缘”

- 计算机之间的数据交换
  “弹性”服务，没有严格时间需求
- 链路类型众多
  特点、性能各异，统一服务困难
- “智能”端系统 (计算机)
  可以自适应、性能控制、差错恢复

## 虚电路网络

简化“边缘”，复杂网络

- 电话网络演化而来
- 核心业务是实时对话
  严格的时间、可靠性需求，需要有保障的服务
  -“哑(dumb)” 端系统（非智能）
  电话机，传真机



0人点赞

计算机网络

# 计算机网络——网络层-路由器

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.10.05 22:18:57字数 1,537阅读 7

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 路由器原理

## 路由器转发平面

- 实现转发功能的逻辑结构；
- 由一台路由器的输入端口，输出端口，交换结构共同实现；
- 路由器转发平面总由硬件实现；
- 转发平面以纳米时间尺度运行；

## 路由器控制平面

- 实现路由器控制功能的逻辑结构；
- 执行路由选择协议，响应上线或下线的连接链路，执行网络管理功能；
- 路由器控制平面通常用软件实现，运行在路由选择处理器上（常为传统CPU）；
- 控制平面以毫秒或秒时间尺度运行；
- 网络范围的路由控制平面常常是分布式的，其不同部分执行在不同路由器上并通过彼此发送控制报文进行交互；

## 组成

- **输入端口**
  将一条输入物理链路与路由器相连接的物理层功能；
  执行与位于入链路远端的数据链路层交换的链路层功能；
  查询转发表以确定到达分组输出端口的查询功能；
- **交换结构**
  将路由器的输入端口与输出端口相连，是路由器内部的网络；
- **输出端口**
  存储从交换结构接收的分组；
  执行必要的链路层，物理层功能以在输出链路上传输分组；
- **路由选择处理器**
  执行路由选择协议；
  维护路由选择表；
  维护连接的状态信息；
  为路由器计算转发表；
  执行网络管理功能；
  控制分组从输入端口转发到路由选择处理器；

对双向链路，链路的输入端口，输出端口通常在同一线路卡（与交换结构相连的一块印刷电路卡）上成对出现。

### 输入端口

```mermaid
graph LR
A[线路端接] --> B[数据链路处理]
B-->C[查找,转发,排队]
C-.->D{交换结构}
```

**输入端口对分组的处理动作**

- 物理层，链路层处理
- 检查分组版本号，校验和，寿命字段
- 更新分组校验和，寿命字段
- 更新用于网络管理的计数器
- 查找分组对应的输出端口

**查找**
查找分组对应的输出端口。
在每个输入端口，通常有转发表的一个影子副本（转发表由路由选择处理器计算和更新并通过独立总线发送到每个输入端口）；
对达到分组中的目的地地址编码（ip），查找转发表中的一个最长前缀匹配；

分组通过查找确定其输出端口后，可进入交换结构；
交换结构可能被来自其它输入端口的分组占用，故分组回被交换结构阻塞，在输入端口处排队；

### 交换结构

将分组实际地从一个输入端口转发（交换）到一个输出端口

**交换方式**

1. 经内存交换
   - 早期简单路由器可由传统计算机实现。输入输出端口间的交换在CPU（路由选择处理器）的直接控制下完成。分组到达输入端口后，中断CPU以通知之，CPU将分组复制到内存，解析分组首部字段，决定将其复制到某个输出端口的缓存中。
   - 许多现代路由器通过内存交换。与早期简单路由器的差别在于，目的地址的查找和将分组存储进适当内存位置是由输入线路卡处理的。
2. **经总线交换**
   输入端口经一根共享总线将分组直接传送到输出端口，无需路由选择处理器的干预。
   输入端将分组送上交换结构时，为其加上一个内部标签，所有输出端口都会收到该分组，但只有标签与之对应的输出端口才会接受该分组。
3. 经互联网络交换
   - 纵横式交换网络
     使用纵横式的棋盘网络而非单一总线来交换分组。
     对N个输入端，N个输出端的路由器，有2N条线路，N^2个线路交点，交点可动态开关；
     对从输入端口A到输出端口B的分组，交换结构控制器通过闭合适当的线路交点以实现正确传送；
     纵横式网络能并行交换多个分组；
   - 多级交换网络
     较为复杂，可使来自不同输入端口的分组同时朝相同输出端口前行

### 输出端口

取出存放在输出端口内存中的分组并将其发送到输出链路。

```mermaid
graph LR
A{交换结构}-.->B[排队,缓存]
B-->C[数据链路处理]
C-->D[线路端接]
```

## 分组排队

在路由器输入端，输出端都有可能形成分组队列。
队列的位置和长度取决于流量负载，交换结构相对速率，线路速率；

**丢包**
队列满时不得不丢弃分组
*弃尾* 策略丢弃新到达的分组
此外还有一些更复杂的策略

主动队列管理会在缓存未满时就选择性地丢包，以提示发送方发生了拥塞

**缓存长度**
路由器缓存可吸收流量负载的波动；
确定缓存大小的经验方法是，缓存大小B = 平均往返时延RTT * 链路容量C
对大量TCP流N通过的链路，缓存大小B = 平均往返时延RTT * 链路容量C / TCP数的平方根N^0.5

**输出端分组调度**
对输出端队列，分组调度程序需在队列中选出一个分组来发送；
通常可用先来先服务原则；
更复杂的调度规则可用实现公平性，服务质量保证等目标；

# 计算机网络——网络层-IP协议

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.10.10 16:44:32字数 2,126阅读 5

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# IPv4数据报格式

数据报：网络层分组



![img](https://upload-images.jianshu.io/upload_images/19345082-05e056a2c3f70af9.png?imageMogr2/auto-orient/strip|imageView2/2/w/1171/format/webp)

IPv4数据报.png

**IPv4数据报关键字段**

- **版本号**
  4bit；
  声明数据报的IP协议版本；
  4:IPv4,6:IPv6
- **首部长度**
  4bit；
  单位为4byte，即该字段中的数值1代表4byte的长度
  IPv4数据报包含可变数量的选项，故须指定首部的实际长度；
  典型的，数据报不含可变选项，长度为20byte
- **服务类型**
  区分不同类型数据报;
  1998 年这个字段改名为区分服务；
  事实上，网络一般不提供区分服务，该字段往往不使用
- **数据报长度**
  16bit；
  以byte记的IP分组总长度（首部+有效载荷）
- **标识，标志，片偏移**
  与IP分片相关；
  新版本即IPv6不允许在路由器上对分组分片；
- **寿命（Time-To-Live,TTL）**
  确保数据报不会永远在网络中循环；
  数据报每经过一台路由器，TTL减一，TTL为0时，数据报被丢弃；
- **协议**
  指示IP数据报的有效载荷应当交付哪个特定的运输层协议；
  协议号绑定了网络层与运输层；
  可以是TCP，UDP,ICMP等
- **首部检验和**
  用于路由器对IP数据报中比特错误的检验；
  路由器通常丢弃检测出错误的数据报；
  逐跳计算，逐跳检验。数据报上有一些可变字段，如TTL，故路由器必须更新数据报的检验和字段；
  发送方计算检验和时，逻辑上将检验和字段置0，对整个IP分组计算检验和，并将检验和填入检验和字段；
  采用带回卷的反码计算校验和，这样便于检验
  注意IP层只对IP首部计算检验和
- **源和目的地的IP地址**
  各32bit
  标识收发双方 网络层接口 的ip地址
- **选项**
  选项字段允许扩展IP首部；
  选项字段是可选的，它使得IP首部长度不定，范围在1~40B之间；
  携带安全、源选路径、时间戳和路由记录等内容
  实际上很少被使用
  IPv6中已去掉了选项字段；
- **填充**
  确保首部长度是4byte的倍数
- **有效载荷**
  有效载荷可以是运输层报文段的数据，也可以是其它类型的数据，如ICMP报文；

# IP数据报分片

## 为何需要分片？

- 链路层协议所能承载的网络层分组长度不同。

**最大传送单元(Maximun Transmission Unit,MTU)**
一个链路层帧能承载的最大数据量

链路层协议的MTU严格地限制了IP数据报的长度。
问题在于发送方到接收方的路径上，每段链路可能使用不同的链路层协议，不同的链路层协议有不同的MTU。

## 分片

- 对路由器的一个到达分组，其大小大于相应输出链路的MTU时，路由器对其分片，即将之拆解成多个较小的IP数据报，用单独的链路层帧封装这些小IP数据报，称其为**片**

- 标识，标志，片偏移字段用于分片组织；

**标识**

- 同一ip数据报有相同而唯一的标识号，即同一数据报的多个片标识相同；
- IP协议维护一个计数器，每产生一个IP分组标识计数加一，作为该分组的标识；
- 不同IP分组可能有同样的标识，但标识号再结合收发双方ip地址可唯一确定ip分组；

**标志**

- 标志字段占3bit，包括一个保留位，一个DF (Don't Fragment) 位，一个MF (More Fragment) 位。
- DF =1：禁止分片；
  DF =0：允许分片
- MF =1：非最后一片；
  MF =0：最后一片(或未分片)

**偏移**

- 偏移字段指示片在原ip数据报中的偏移；
- 占13位
- 片偏移字段以8字节为单位

## 片组装

- 运输层希望收到完整的未分片的报文；
- 网络核心应当保持简单，片组装工作不应由路由器进行；
- 片的重组工作在端系统中进行；

- 在目的地主机，数据报的有效载荷仅当IP层已完全重构为初始IP数据报时，才会传递给目的地运输层；
- 若一个或多个片一直没有到达目的地，该不完整的数据报将被丢弃；

**IPv6废止了分片机制**

# IPv4编址

## 网络接口

- 主机/路由器与物理链路的连接

- 主机通常只有一个网络接口（事实上，通常也有多个不同类型的网络接口，如wifi接口，以太网接口）；
- 路由器必须有多个网络接口；

## IPv4地址

- 标识网络接口的编号
- 一个IP地址技术上是与一个接口关联的，而非与该接口所在的主机或路由器关联；
- IPv4地址4byte，32bit，故有约40亿个可能的IP地址；
- **点分十进制** 地址中的每个字节用它的十进制形式书写，字节间用句点(.)分隔。
- 全球因特网中每台路由器和主机上的每个接口，都必须有一个全球唯一的IP地址（除非使用了NAT技术）

## 子网

- 在网络拓扑结构的图模型中，将路由器的对应顶点按接口拆分，所得到的新图中，每一个连通分支就是一个子网；
- 不跨越路由器（第三及以上层网络设备）可以彼此物理联通的接口 组成一个子网

**子网掩码**
a.b.c.d/x；
子网地址的记法，该记法表示接入子网的所有接口的ip地址前x位都应与a.b.c.d的前x位一致；

## 因特网地址分配策略

### 分类编址方案



![img](https://upload-images.jianshu.io/upload_images/19345082-92ce33c311dd9ced.png?imageMogr2/auto-orient/strip|imageView2/2/w/1149/format/webp)

ip地址分类.png

- CIDR被采用前的早期方案；
- 子网主要被分为A,B,C三类，其子网地址长度分别为8，16，24比特；
- D类地址用作广播地址；
- E类地址保留；
- 该方案由于子网大小与组织规模不能良匹配，造成大量地址浪费；

#### 特殊IP



![img](https://upload-images.jianshu.io/upload_images/19345082-ad0f98c66c959e25.png?imageMogr2/auto-orient/strip|imageView2/2/w/1109/format/webp)

特殊IP.png

#### 私有IP



![img](https://upload-images.jianshu.io/upload_images/19345082-55823b6f1f4016b2.png?imageMogr2/auto-orient/strip|imageView2/2/w/1059/format/webp)

私有IP.png

### 无类别域间路由选择（Classless Interdomain Routing,CIDR）

**子网寻址**
a.b.c.d/x
32bit的地址划分为两部分：

1. a.b.c.d/x的前x位构成了IP地址的网络部分，称作该地址的前缀；一个组织通常被分配一块连续的地址，即地址前缀相同；
2. a.b.c.d/x的后32-x位用于区分该组织的内部设备；

## 获取地址块

**因特网名字和编号分配机构(Internet Corporation for Assigned Names and Numbers,ICANN)**

- 非营利性组织，基于[RFC 2050]管理；
- 负责IP地址分配；
- 管理DNS根服务器；
- 分配域名与解决域名纷争；

**ICANN地址支持组织**

- ICANN向区域性因特网注册机构分配地址，区域性因特网注册机构和ICANN一起组成了ICANN地址支持组织，处理本地域内的地址分配与管理；

**ISP获取地址块**
ISP向ICANN地址支持组织申请地址块；

**组织获取地址块**

- 为获得用于某组织的子网，网络管理员与其ISP联系；
- ISP会从其所拥有的大地址块中，提供一个小地址块；

### 获取主机与路由器地址

- 一个组织获取了一个地址块后，需要为组织内的主机与路由器接口逐个分配IP地址；

#### 路由器IP

系统管理员常通过远程网络管理工具手工配置路由器中各接口的IP地址

#### 主机IP

- 主机地址可手动配置；
- 但目前，通常通过DHCP动态配置

# 计算机网络——网络层-网络地址转换

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.10.13 18:21:41字数 1,015阅读 8

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 网络地址转换(Network Address Translation,NAT)

- 对某子网（如家庭，小型办公室），ISP已为其分配一组连续的IP地址。NAT技术使得该子网可以在有限的IP地址下扩展因特网设备。
- NAT使能路由器接口可分为公网接口和子网接口，公网接口连接因特网，子网接口是小型网络的一部分；

[RFC 1918] （[https://tools.ietf.org/html/rfc1918](https://links.jianshu.com/go?to=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc1918)） 保留了三块特殊的地址空间：

- 10.0.0.0/8 - 10.255.255.255 (10/8 prefix)
- 172.16.0.0/12 - 172.31.255.255 (172.16/12 prefix)
- 192.168.0.0/16 - 192.168.255.255 (192.168/16 prefix)
  这些地址空间用于专用网络，如家庭网络；
  在小型网络，即上述子网中，使用特殊地址空间编码，在公网，使用一般地址编码；
  在小型网络内部，可以通过特殊地址空间内的地址区分各个网络设备；
  在因特网范围内，以特殊地址空间地址编制的设备，其IP是不唯一的；
  在小型网络内部，可之间通过内部IP区分设备，但在因特网上通讯，须使用NAT使能路由器的公网IP。

- 在外部视角下，NAT使能路由器类似一个具有单一IP地址的单一设备；
- NAT使能路由器对外界隐藏了家庭网络的细节；
- NAT使能路由器的公网地址通常是通过DHCP获得的；
- NAT使能路由器从ISP的DHCP获得公网地址，而后路由器运行一个DHCP服务器，为该路由器控制的小型网络中的端系统提供地址；

## NAT转换表

- 对外界，NAT路由器控制下的网络有如一个设备，当数据到达NAT路由器时，路由器需将之分发到正确的设备；
- NAT通过转换表实现地址转换；
- NAT转换表是 端口号 到 内部IP x 实际端口号 的映射;

## NAT工作原理

- 假定NAT内部网络上有设备在 (ip A,port a) 上对 公网端系统 (ip B,port b)发送报文，其中ip A 是内网地址，ip B是公网地址;
- 假定NAT路由器的公网地址是 ip N；
  则，NAT路由器截获内网发往外围的报文，分配一个port nA，用(ip N,port nA)替换原报文中的源地址部分，同时，添加相应NAT转换表项；

## NAT技术缺陷

NAT是解决IP地址短缺的权宜之计，有诸多问题；

1. 端口号用于进程编址，而不应用于主机编址；NAT给运行在内网上的服务器造成了问题，因为客户无法知晓服务器的实际端口；
2. 路由器仅应当出来网络层及以下的分组；
3. 根据端到端原则，主机彼此应直接相互对话，节点介入修改IP地址与端口号违背了这一原则；
4. 应使用IPv6解决IP地址短缺问题，而非使用NAT做权宜；

## NAT穿越

- NAT妨碍P2P应用，因为NAT下的对等方无法作为服务器与其它对等方建立TCP连接，P2P需要通过中继等技术实现NAT穿越；

*无论如何，NAT已是因特网的一个重要组件。*

### 通用即插即用(UPnP)

- 可用于实现NAT穿越的技术；
- 允许主机发现并配置邻近NAT的协议；
- UPnP要求主机和NAT都是UPnP兼容的；
- 在UPnP协议下，主机上的进程可以在一定程度上自定义NAT映射，即进程可以定义并了解套接字被映射到了哪个（ip,port）序对；

# 因特网控制报文协议(Internet Control MessageProtocol，ICMP)

- 用于主机和路由器间沟通网络层信息；
- ICMP位于IP之上，ICMP分组由IP分组承载，主机收到一个指明上层协议为ICMP的IP数据报时，它分解出数据报的有效载荷并交付给ICMP；

## 功能

ICMP支持主机或路由器：

- 差错(或异常)报告
- 网络探询

两类ICMP 报文:

1. 差错报告报文(5种)
   - 目的不可达
   - 源抑制(Source Quench)
   - 超时/超期
   - 参数问题
   - 重定向 (Redirect)
2. 网络探询报文(2组)
   - 回声(Echo)请求与应答报文(Reply)
   - 时间戳请求与应答报文

## ICMP报文

- **类型字段**
- **编码字段**
-  **源字段** 引起该ICMP报文首次生成的IP数据报的首部和前8字节；



![img](https:////upload-images.jianshu.io/upload_images/19345082-0bb86923a2c87bae.png?imageMogr2/auto-orient/strip|imageView2/2/w/950/format/webp)

ICMP报文.png

## 例外

### 几种不发送 ICMP差错报告报文的特殊情况

1. 对ICMP差错报告报文不再发送 ICMP差错报告报文
2. 除第1个IP数据报分片外，对所有后续分片均不发送ICMP差错
    报告报文
3. 对所有多播IP数据报均不发送 ICMP差错报告报文
4. 对具有特殊地址（如127.0.0.0 或 0.0.0.0）的IP数据报不发送
    ICMP 差错报告报文

### 几种 ICMP 报文已不再使用

1. 信息请求与应答报文
2. 子网掩码请求和应答报文
3. 路由器询问和通告报文

## ICMP应用

### Traceroute

- 源主机向目的主机发送一系列UDP数据报
- 第i组IP数据报TTL =i,i = 1,2,3……
- 目的端口号为不可能使用的端口号

- 当第n组数据报(TTL=n)到达第n个路由器时： 
  - 路由器丢弃数据报
  - 向源主机发送ICMP报文(type=11, code=0)
  - ICMP报文携带路由器名称和IP地址信息

- 当ICMP报文返回到源主机时，记录RTT

- 停止 
  - UDP数据报最终到达目的主机
  - 目的主机返回“目的端口不可达”ICMP报文 (type=3,code=3)
  - 源主机停止

### Ping

- ping程序发送一个类型8，编码0的ICMP报文到指定主机；
- 目的主机发回一个类型0，编码0的ICMP回显回答；

### 源抑制报文

- 最初用于执行拥塞控制的ICMP报文；
- 实践中很少使用；
- 拥塞路由器向主机发送一个源抑制报文以强制该主机减小发送速率；

作者：疼呃

链接：https://www.jianshu.com/p/457649b4700f

来源：简书

著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

# 计算机网络——网络层-IPv6

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.10.13 19:27:41字数 1,362阅读 5

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# IPv6

- 开发IPv6的主要动机在于：32bit的IPv4地址空间即将用尽；事实上，顶层的IANA地址池已在2011分配完毕。
- IPv6同时还加强了IPv4的其它方面，如改进首部格式以快速处理/转发数据报，支持QoS
- *最初预想被作为IPv5的ST-2协议被废弃了*

## IPv6数据报格式

### 重要变化

- **地址空间扩大**
  地址长度扩展到128bit；
  除单播地址，多播地址，IPv6引入了任播地址，即可被交付给一组主机中的任意一个的地址；
- **简化的首部**
  40字节的定长首部；
  许多IPv4字段被舍弃或作为可选项，选项通过新机制编码；
- **流标签与优先级**
  流标签给属于特殊流的分组打上标签，这些特殊流是发送方要求进行特殊处理的流，如一种非默认服务质量或需要实时服务的流。
- **分片机制**
  IPv6不允许在中间路由器上进行分片与重新组装，分片与重组只能在收发双方端系统上进行；
  若路由器收到的IPv6数据报过大而不能转发到出链路，路由器只需丢弃该数据报并向发送方返回一个指示分组过大的ICMP差错报文即可。
- **删去首部检验和**
  因特网运输层和链路层已经执行了检验功能，网络层的该功能可去除以减少每跳处理；
- **选项**
  选项字段不再是标准IP首部，但它可以通过IP首部中，下一个首部字段实现；
  具体地，TCP,UDP协议的首部可以是“下一个首部”，而选项字段也可以是“下一个首部”；
- **ICMPv6**
  新版ICMP
  附加报文类型，e.g. “Packet Too Big”
  多播组管理功能

### IPv6字段



![img](https://upload-images.jianshu.io/upload_images/19345082-2188fe0165931d05.png?imageMogr2/auto-orient/strip|imageView2/2/w/1189/format/webp)

IPv6字段.png

- **版本**
  4bit，IPv6版本字段值为6；
- **流量类型（优先级）**
  8bit,标识数据报的优先级
- **流标签**
  20bit,标识同一流中的数据报
- **有效载荷长度**
  16bit,
- **下一个首部**
  标识下一个选项首部或上层协议首部，即标识有效载荷应当交付给哪个上层协议；
- **跳限制**
  转发数据报的每台路由器对该字段内容减一，跳限制计数达到0时，该数据报将被丢弃；
- **源地址**
  128bit
- **目的地地址**
  128bit
- **有效载荷**

### IPv6地址表示形式

- 一般形式: 1080:0:FF:0:8:800:200C:417A
- 压缩形式: FF01:0:0:0:0:0:0:43
- IPv4-嵌入形式: 0:0:0:0:0:FFFF:13.1.68.3 或 ::FFFF:13.1.68.3
- 地址前缀: 2002:43c:476b::/48(注: IPv6不再使用掩码!)
- URLs: http://[3FFE::1:800:200C:417A]:8000

### IPv6基本地址类型



![img](https://upload-images.jianshu.io/upload_images/19345082-1cb23c2296703474.png?imageMogr2/auto-orient/strip|imageView2/2/w/835/format/webp)

IPv6基本地址类型.png

### IPv4到IPv6的迁移

#### 标志日

- 在指定的时间点，关闭因特网所有机器并升级IPv4到IPv6;
- 该方法不可行；

#### 双栈

##### Pv6/IPv4首部转换

- 使用IPv6/IPv4节点，该节点具有收发IPv4,IPv6两种数据报的能力；
- 双栈节点必须具有IPv6,IPv4两种地址；
- 双栈节点应具有确定另一个节点是否是IPv6使能节点的能力，该问题可通过DNS解决，当且仅当发出DNS请求的节点和目标节点都IPv6使能时，DNS才返回IPv6地址；
- 即分组在传播过程中，允许IPv6到IPv4的降级转换，讲IPv6首部转换为IPv4首部，转换过程中会丢失一些IPv6初始信息，故只能降级不能升级

##### 隧道（tunneling）

- **隧道** 假定两IPv6节点要使用IPv6数据报交互，但两者经由IPv4节点互联，则称这两个IPv6节点间的IPv4节点之集为一个隧道。
- 借助于隧道，发送端的IPv6节点将整个IPv6数据报作为有效载荷装入IPv4数据报，隧道接收端的IPv6节点收到该IPv4数据报并能发现该数据报含有一个完整的IPv6数据报，故接受节点可提取IPv6数据报；
- 分组在进入隧道前降级，离开隧道时升级。由于隧道方案的转换是生成新IPv4首部并将IPv6首部封装到IPv4有效载荷内，故降级的IPv6报文仍可恢复
- *网络层的技术迁移是困难的，但应用层中新协议的快速部署是容易的；*

## IP安全性

- IPv4的设计是在因特网主要用于互相信任的联网研究人员之间的时代，没有提供任何安全服务；

### 提供安全性服务的新型网络层协议

**IPsec**

- 流行的安全网络层协议，在虚拟专用网（VPN）中广泛部署；
- IPsec被设计为与IPv4和IPv6向后兼容，故使用IPsec时无需替换因特网中所有的主机和路由器中的协议栈；





0人点赞



计算机网络

# IP安全性

- IPv4的设计是在因特网主要用于互相信任的联网研究人员之间的时代，没有提供任何安全服务；

## 提供安全性服务的新型网络层协议

**IPsec**

- 流行的安全网络层协议，在虚拟专用网（VPN）中广泛部署；
- IPsec被设计为与IPv4和IPv6向后兼容，故使用IPsec时无需替换因特网中所有的主机和路由器中的协议栈；



# 路由选择算法

## 基本概念

**路由**  确定发送方到接收方通过路由器网络的好路径；

**源路由器** 源主机的第一跳路由器
 **目的路由器** 目的主机的第一跳路由器

## 路由选择算法

- 给定一组路由器及连接路由器的链路组成的图，寻找从源路由器到目的路由器的最优路径；
- 最优路径通常指具有最低费用的路径；
- 路径费用反映路径的物理长度，链路速度，金融费用等因素；
- 实际路由选择算法还考虑策略问题，即存在组织A的路由器可能拒绝转发组织B的路由器等情况；
- 抽象的路由选择算法在一个带权有向图中，寻找给定节点对间的带权最短路径；

## 路由选择算法分类

### 分类一 集中式&分布式

-  **全局式路由选择算法**
   路由器用完整的全局性网络信息计算源到目的地的带权最短路径；
   全局式算法要求在真正开始计算前，每个路由器都获取全局的网络信息；
   实践中，全局式算法常被称作*链路状态算法* 
-  **分布式路由选择算法**
   路由器以分布式算法迭代地计算出源到目的地的带权最短路径；
   没有节点拥有全局的完整网络信息；
   每个节点仅有其邻接节点发来的信息和到邻接节点的链路信息即可工作；
   每个节点迭代计算并与其邻接节点交换信息，逐渐计算出到达某目的节点或一组目的节点的带权最短路径；
   分布式路由选择算法的实例是*距离向量算法*；

### 分类二 静态&动态

-  **静态路由选择算法**
   路由随时间缓慢变化，通常是通过人工干预更新的；
   人工配置的路由出于对某些因素的考量，往往优先级较高；
-  **动态路由选择算法**
   能够在网络流量负载或拓扑结构变化时自动地改变路径；
   通常定期更新，路由更新快，及时响应链路费用或网络拓扑变化；

### 分类三 负载敏感&负载不敏感

-  **负载敏感算法**
   链路权重动态变化——反映出底层链路的当前拥塞水平；
   早期路由选择算法是负载敏感的，故而遇到了很多难题；
-  **负载迟钝算法**
   链路费用不明显反映其当前或近期的拥塞水平；
   当今因特网路由选择算法是负载迟钝的；

##### 路径震荡问题

- 路径震荡问题存在于所有根据拥塞测度链路权重的路由选择算法中；
- 即状态t0下算法选择了路径1，使得该路径拥塞；这导致状态t1下算法选择路径2，使得路径2拥塞；这又使得算法在t2下选择路径1，最终导致反复震荡；
- 解决方案是确保路由器运行路由选择算法的时机不同步；





# 链路状态(Link State,LS)路由选择算法

- 全局式的路由选择算法；

## 链路状态广播算法

- 为获取全局网络信息，实践中要求每个节点向网络中所有其它节点广播链路状态分组；
- 节点广播的结果是，所有节点都具有了该网络等同的完整的视图；

## 链路状态路由选择算法

- 具体的链路状态路由选择算法可选用Dijkstra算法等**单源最短路径算法**；
- 每个节点都在其上运行单源最短路径算法，以获取到达每个目的地的下一跳路由节点，从而构造转发表；

### Dijkstra算法

c(x,y): 结点x到结点y链路费用；如果x和y不直接相连，则=∞
 D(v): 从源到目的v的当前路径费用值
 p(v): 沿从源到v的当前路径，v的前序结点

每轮迭代，从最短路径未确定的节点集合中，选取一个路径最短的节点，到该节点的当前最短路径就是到该节点的最短路径，将之加入最短路径已确定节点集合，并更新到该节点邻接节点的当前最短路径；

k次迭代后，得到到达k个目的结点的最短路径

#### 算法复杂性

对n个节点

时间复杂度![O(n^2)](https://math.jianshu.com/math?formula=O(n%5E2))

更高效的实现 ![O(nlogn)](https://math.jianshu.com/math?formula=O(nlogn))

### 链路状态路由算法的问题

存在震荡(oscillations)可能

在状态a下，算法判定转换到状态b费用更底，
 在状态b下，算法判定转换到状态a费用更底；

这是由于由于算法选择的路由会影响链路拥塞程度，链路拥塞程度会影响链路权重，链路权重又会影响算法选择的路由；

# 路由选择信息协议(Routing Information Protocol,RIP)

- 被广泛用于因特网AS内部路由选择；
- 于1982年随BSD-UNIX操作系统发布；
- 常被设置于下层ISP和企业网中;
- RIP协议是一种距离向量算法；

## RIP响应报文

- 又称RIP通告；
- 在邻接路由器间交换路由选择信息（距离向量）的报文；
- 约30秒互相交换一次；
- 报文包括该AS内最多25个目的子网的列表和发送方到其中每个子网的距离（估计费用）；

## 路由选择表

- 即RIP表；
- 每台路由器维护自身的路由选择表；
   在路由器上，RIP路由表利用一个称作route-d 的应用层守护进程进行管理；
- 包括该路由器的距离向量和该路由器的转发表；
- 表中每一项有三个字段，分别是目的子网，沿最短路径的下一跳路由器标识，沿最短路径到目的子网的跳数；
- 原则上，AS内的每个子网都在该转发表中有一个表项，事实上，可以用路由聚合技术聚会表项（例如，a.b.c.x和a.b.c.y可以聚和为a.b.c前缀）

## RIP实现细节

- RIP协议使用距离向量算法；
- RIP使用跳数作为费用测度，即每条链路的费用视为1；
   **跳** 沿着源路由器到目的子网的最短路径所经过的子网数量（包括目的子网）；
- 一条路径的最大费用被限制为15，故RIP的使用限制在网络直径不超过15跳的自洽系统内；
- RIP路由器约每30秒交换一次报文，若某路由器超过180秒没有从某邻居收到报文，则会认为该邻居不再可达（死机，链路中断），路由器会相应更新本地路由选择表并通知其它邻居该信息；
- 路由器可通过RIP请求报文，请求其邻居到指定地点的费用；
- 路由器在端口520通过UDP发送RIP请求与响应报文，即RIP使用位于网络层协议IP之上的运输层协议UDP来实现网络层功能；
- 针对环路问题，RIP使用了毒性逆转（在通告中包括代价和下一跳路由）和最大度量（最大有效费用15跳）



# 开放最短路优先(Open Shortest Path First,OSPF)

- 被广泛用于因特网AS内部路由选择；
- 常被设置于上层ISP中；
- OSPF和协议IS-IS密切相关，极其相似；
- 其功能比RIP更强大，被设想为RIP的后继者；
- 是一种链路状态路由算法
- Open 意指该协议规范公众可用；

## 算法概述

- OSPF的核心是一个使用洪泛链路状态信息的链路状态协议和一个Dijkstra最低费用路径算法；
- 每台路由器构建一幅关于整个自洽系统的完整拓扑图；
- 路由器在本地运行Dijkstra算法，确定一个以自身为根节点的到达所有子网的最短路径树；
- 各条链路的费用由网络管理员配置；

- 路由器向自洽系统内的所有其它路由器广播路由选择信息；
- 每当链路状态变化时，路由器广播链路状态信息；
- 每隔一定时间（如30分钟），路由器广播链路状态信息；

- OSPF报文直接由IP报文承载，其IP报文的上层协议字段置为89，OSPF必须自己实现可靠传输，状态广播等功能；

**链路权重设置的实践原则**

- 权值可以全部置为1以实现最少跳数路由选择；
- 权值可按链路容量的反比设置；

## OSPF优点

1.  **安全** 可鉴别OSPF路由器间的交换；鉴别技术使得仅有受信任的路由器能参与一个AS内的OSPF协议，故而可防止入侵者将恶意信息注入路由器转发表内；
2.  **多条可用路径** 当到达目的地的多条路径费用相同时，OSPF允许使用多条路径；
3.  **对单播与多播路由选择的综合支持** 多播OSPF提供对OSPF的简单扩展以便提供多播路由选择；
4.  **支持在单个路由选择域内的层次结构**  OSPF具有按层次结构构造一个自洽系统的能力；
5.  **ToS支持**  对于每条链路，可以针对不同的TOS设置多个不同的费用度量。即可区分不同要求的流量，为低要求流量和高要求流量选择不同的路由

## OSPF层次路由选择实现

- 一个OSPF自洽系统可配置为多个区域，每个区域运行自己的OSPF链路状态路由选择算法，一个区域内的每台路由器向该区域内的所有其它路由器广播其链路状态；
- 一个区域内，一台或多台区域边界路由器为流向该区域以外的分组提供路由选择；
- 一个AS内仅有一个OSPF区域被配置为主干区域，主干区域为AS内其它区域间的流量提供路由选择；
- 主干区域总包含AS内所有的区域边界路由器；
- 主干区域还包括若干AS边界路由器，即AS网关路由器，与其它AS连接
- AS内的区域间路由选择，首先路由分组到一个区域边界路由器，再通过主干路由到位于目的区域的区域边界路由器，而后再利用到最终目的地；



# 边界网关协议(Broder Gateway Protocol,BGP)

- BGP4是当前因特网中域间路由选择的事实标准；

## BGP服务

BGP为每个AS提供以下服务：

1. 从相邻AS处获得子网可达性信息；
2. 向本AS内部的所有路由器传播可达性信息；
3. 基于可达性信息和AS策略，确定到达子网的优路由；

- BGP使得每个子网向因特网的其它部分通过自身的存在 ，即确保因特网中的所有AS了解该子网的存在即如何到达该子网；
- BGP使得每个AS了解经过其相邻AS可达的目的地；
- 目的地不是主机IP，而是CDIR（无类别域间路由选择）化的前缀；
- 每个前缀代表一个子网或一个子网的集合；
- BGP通过IP地址聚合，最长前缀匹配等技术生成，解析前缀；

## BGP基本概念

**BGP会话**

- 用于BGP的TCP连接，路由器对使用179端口的半永久TCP连接以交换路由选择信息；
- BGP会话是TCP连接，未必与实际的物理链路对应；

**BGP对等方** 位于一个BGP会话两端的两台路由器；
 **外部BGP会话(eBGP)** 跨越两个AS的BGP会话；
 **内部BGP会话(iBGP)** 同一AS内两路由器间的BGP会话；

## 路径属性及BGP路由

**自洽系统号(Autonomous System Number,ASN)**

- BGP中，自洽系统由全局唯一的自洽系统号标识(桩AS无ASN)；
- AS号由ICANN地区注册机构分配；

**桩AS**

- 仅承载源地址或目的地址为本AS的流量，通常无ASN；
- 即不承载中转流量的AS，这样的AS往往是客户AS；

**路由**

- 路由是带有BGP属性的IP前缀；
- BGP对等方通过BGP会话彼此通告路由；

**路由属性**

-  **AS-PATH**
   该属性包含前缀的通告已经通过的AS;
   当前缀传送到一个AS时，该AS将它的ASN添加到AS-PATH属性中；
   AS-PATH属性可以检测和防止循环通告；
   一台路由器若发现他的AS被包括在AS-PATH中，则它会拒绝该通告；
-  **NEXT-HOP**
   一个开始某AS-PATH的路由器接口，即下一跳AS对应网关路由器的相应接口；
   路由器使用该属性配置转发表；

**输入策略**
 当网关路由器收到一条路由时，根据输入策略决定接收或过滤该路由；

**BGP路由选择**
 BGP使用eBGP和iBGP发布路由；
 某台路由器可能知道到达某一前缀的多条路由，路由器必须在可能的路由中选择一条；
 **消除规则**
 *输入：到同一前缀的多条路由*
 *输出：一条路由*

1. 本地偏好值，该值由AS的网络管理员设置；被配置了本地偏好的路由器，会选择本地偏好值最大的路由；若有多个最大值，进入下一步；
2. 选择具有最短AS-PATH的路由；若有多个最短AS-PATH路由，进入下一步；
3. 选择具有最靠近NEXT-HOP路由器的路由（即热土豆路由选择）；最靠近指最低费用；若有多个最靠近路由器，进入下一步；
4. 使用BGP标识符选择路由；

## 路由选择策略

- AS网络可分为主干提供商网络和客户桩网络

- 客户桩网络至少与一个提供商网络相连以获得因特网连接
- 客户桩网络也可以多宿，即同时与多个提供商网络连接
- 多宿的客户桩网络不会转发过路流量，亦即所有通告客户桩网络的流量或者发送源该网络，或者目的地是该网络
- 亦即，客户桩网络不会向邻居AS转发到其它网络的BGP通告

- 主干提供商网络与其它提供商网络和它的客户网络相连
- 提供商网络会为它的客户转发BGP通告
- 提供商网络之间如何转发BGP通告并没有统一的强制性规定
   事实上的商业法则是，任何穿越某ISP主干网的流量必须是其源或目的地位于该ISP的某个客户网络的流量；否则，这些流量就免费通过该ISP网络

## 单播，广播，多播 路由选择

- 单播路由选择
   点对点通信
- 广播路由选择
   从源节点向网络中所有其它节点交付分组
- 多播路由选择
   从源节点向网络中一组特定的其它节点交付分组

# 广播路由选择

- 从源节点向网络中所有其它节点交付分组

## N次单播

- 通过对网络中所有其它节点单播来实现广播

### 问题

-  **低效**
   考虑路径ABC,ABD；链路AB上会有多个冗余的广播分组
-  **要求预知接收方地址**
   在广播的应用场景下，接收方地址很可能无法预知
-  **依赖单播**
   循环依赖。一些单播路由选择算法（如链路状态路由选择协议）依赖广播的功能。

## 无控制洪泛

- 源节点向所有邻居发送广播分组；
- 某节点结束到来自邻居A的广播分组后，向它的所有其它邻居（除A外）发送广播分组；

### 问题

-  **无限循环**
   若图存在圈，则广播分组会在圈上无限循环
-  **广播风暴**
   一个节点与多个节点连接时，将产生多个副本；
   每个副本在存在多个邻居的节点处又会分裂出多个副本，最终导致网络中充斥大量冗余分组；

## 受控洪泛——序号控制洪泛

- 源节点将其地址（或其它标识符）及广播序号放入广播分组；并向所有邻居发送广播分组
- 每个节点维护它所处理过的广播分组的(源地址，广播序号)序对的列表，对新接收的广播分组，节点检查该分组在列表中是否有对应项，若有，则丢弃之；若无，则向其所有其它邻居转发该分组

*Gnutella应用层协议使用了序号控制洪泛技术*

## 受控洪泛——反向路径转发（Reverse Path Forwarding,RPF）

- 当某节点A收到具有源地址B的广播分组时，仅当该分组到达的链路恰好在A到B的单播最短路径上时，节点A才向它的所有其它邻居转发该分组；
- 节点A不需要了解A到B的完整单播最短路径，A只需知道A到B单播最短路径上的下一跳节点即可完成判断

## 生成树广播

- 首先构造网络的一颗生成树；
- 当任一一个源节点要发送广播时，它向所有生成树中的邻居发送分组；
- 接收广播分组的节点也向生成树中的其它邻居转发分组；
- 节点A无需了解整颗生成树，只需知道生成树中A的邻居即可；

### 优点

- 每个节点仅接受广播分组的一个副本，完全避免了冗余分组；

### 分布式生成树算法——基于中心点的方法

- 定义一个中心节点C
- 其它节点向中心节点单播表示加入树的报文
- 加入树报文使用单播路由选择向中心节点转发，直至该报文到达一个属于树的节点
- 加入树报文所经过的路径定义了发起该报文的节点到中心节点间的生成树分支

# 实际中的广播算法

- 广播算法被用于应用层和网络层
- 应用层协议Gnutella使用某种形式的序号控制洪泛
- 路由选择算法OSPF和IS-IS使用某种序号控制洪泛来广播链路状态通过

# 多播

- 多播分组被交付给网络中所有节点的一个子集

*至今，IP多播尚未得到大规模应用*

- 因特网多播
- 多播数据报使用间接地址编址，即用一个D类多播地址标识一组接收方，寻址到该D类多播地址的分组被交付给所有与该多播地址关联的接收方；
- 与一个D类地址关联的接收方小组被称为一个多播组；

## 因特网组管理协议（IGMP）

- IGMP运行在主机和边缘路由器（主机的第一跳路由器）上
- IGMP使得主机能够通知第一跳路由器，该主机上的某进程想加入某特定多播组；

**IGMP报文**

- IGMP包括membership_query,membership_report,leave_gruop三类报文
- IGMP报文由IP分组承载，对应IP分组的上层协议字段为2

- **软状态协议**
   状态若未被显式更新，则通过超时事件被删除；
- IGMP协议是软状态协议

## 多播路由选择算法

- 协调遍布因特网的多播路由器，使得多播数据报能够路由到最终目的地；
- 构造多播路由选择树，使得该树连接所有具有属于该多播组的相连主机的路由器；

### 使用组共享树的多播路由选择

- 组内所有发送方共享一颗多播树
- 使用基于中心的方法构造多播路由选择树；
- 一个关键是 树中心的选择过程

### 使用基于源的树的多播路由选择

- 为组内的每个源构建一颗多播树
- 实践中，使用为源节点s使用反向路径转发（RPF）算法构造多播树
- 不同于广播中的RPF，由于许多节点不需要多播分组，多播RPF需要进行剪枝以减少无用报文的转发；
- 一台接受到多播分组的边缘路由器，若它无加入该组的相关主机，则它向上游路由器发送一个剪枝报文；
- 若一台非边缘路由器从它的每个下游路由器收到剪枝报文，则他向上游转发一个剪枝报文；



# 计算机网络——链路层-概述

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.10.27 15:31:03字数 688阅读 2

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 概述

**节点** 运行链路层协议的任何设备，如主机，路由器，交换机，WiFi接入点；
**链路** 沿通信路径链接相邻节点的通信信道；

## 链路层信道

- **广播信道** 多台主机连入同一广播信道，需要媒体访问协议(或中心控制器)协调帧传输；如有线局域网，卫星网，混合光纤同轴的接入网；
- **点对点信道** 链路两端分别仅有一个发送方，一个接收方；点对点链路的访问较为简单，可通过点到点(PPP)等协议协调；

## 链路层服务

- **基本服务**
  将数据报通过单一链路从一个节点移动到相邻节点；
- **成帧**
  在每个网络层数据报经链路传送之前，几乎所有链路层协议都要将其用链路层帧封装；
  帧由一个数据字段和若干首部字段组成，具体结构取决于链路层协议；
- **链路接入**
  媒体访问控制协议规定了帧在链路上的传输规则；
  媒体访问控制协议在广播信道中较复杂，点对点信道中较简单；
- **可靠交付**
  保证无差错地经链路层移动每个网络层数据报；
  链路层可靠交付服务常用于易产生高差错率的链路，如无线链路；
  对低差错率的链路，链路层可靠交付被认为是不必要的开销，有线链路层协议通常不提供可靠交付服务；
- **差错检验和纠正**
  没必要转发差错帧，故许多链路层协议提供差错检验；
  链路层差错检验通常比网络层和运输层更复杂，由硬件实现；
  差错纠正使得接收方能够发现并纠正比特错误；

## 链路层实现位置

- 路由器中，链路层实现在线路卡上；

- 主机中，链路层主体实现在网络适配器（网络接口卡）上；
- 网络适配器的核心是链路层控制器，该控制器通常是实现了成帧，链路接入，差错检验等多种链路层服务的专用芯片；
- 早期网卡大多是物理上独立的芯片卡，当前网卡大多被集成到主板上；
- 链路层的部分功能由运行在cpu上的主机软件实现；

- 链路层是协议栈中软件与硬件交接的地方；



0人点赞

计算机网络

# 差错检测和纠正

## 比特级差错检测和纠正

- 对从一个节点发送到另一个物理上邻接节点的链路层帧，提供比特错误的检测和纠正；

- 发送方对数据比特序列D，附加检测和纠正比特序列EDC；
- 接收方根据接收的数据比特序列D'和检测和纠正比特序列EDC'判断并纠正比特错误；
- 即使采用差错检测技术，仍旧可能存在未检出比特差错；

**前向纠错(Forward Error Correction,FEC)**

- 接收方检测和纠正差错的能力；

## 奇偶校验

- 对d比特的数据序列D，附加1位校验比特；

-  **偶校验方案**
   发送方选择校验位的值使得d+1位比特序列中1的个数为偶数；
   接收方检测d+1位比特序列中的1个数是否为偶数，非偶数则认为出错；
-  **奇校验方案**
   发送方选择校验位的值使得d+1位比特序列中1的个数为奇数；
   接收方检测d+1位比特序列中的1个数是否为奇数，非奇数则认为出错；

- 奇偶校验可检出所有奇数个比特差错的情况；
- 若单个比特差错的概率低，且各个比特的差错事件独立，则奇偶校验是可接受的；
- 事实上，差错经常以突发的方式聚集，即各个比特的差错事件是不独立的；

### 二维奇偶校验

- 将d位数据序列划分为i行j列矩阵，对每行每列计算奇偶校验值，共i+j+1个奇偶校验比特；

- 对单比特差错，二维奇偶校验可定位出错的行列并纠正之；
   事实上，发生在不相关行列上的多个单比特差错也可纠正；
- 二维奇偶校验可以检测同一分组中两个比特差错的任意组合；

## 检验和技术(checksum)

- 将d比特的数据序列视为多个k比特整数构成的序列
- 基本方法是将序列中的多个k比特整数相加，并用总和作为差错检验比特；

- 常用于运输层

### 因特网检验和

- 将数据序列视为16比特的整数序列并求和，将和的反码作为因特网检验和；
- 接收方将整个数据序列（原数据和检验和）视为16比特整数序列并求和取反码，若结果全1则认为无差错；
- TCP和UDP中，对所有字段（分组头和分组载荷）计算检验和
   XTP协议对首部和整个分组（分组头和分组载荷）分别计算检验和

### 检验和技术特点

- 检验和的分组开销小，处理速度快
   差错保护能力相对弱（相对CRC弱）
- 运输层差错检验用软件实现，故偏好检验和这样简单且快速的差错检测方案；

## 循环冗余检测(Cyclic Redundancy Check,CRC)

- 常用于链路层

- 也称多项式编码，将发送的比特串视为系数为0，1的多项式；
- 收发双方协商r+1比特模式，称为生成多项式G；
- 对d比特数据序列D，发送方选择r比特附加数据R，得到d+r比特模式，且该d+r位模式在模2算术下能被G整除；
- 接收方用G除接收到的d+r位序列，若余数为0则认为数据无误；

### CRC计算

- 采用模2算术，加法不进位，减法不借位，加减等同于亦或；
   乘除同常规的二进制算法，可用移位实现；
- 余数R的计算：
   ![R = D*2^r mod G](https://math.jianshu.com/math?formula=R%20%3D%20D*2%5Er%20mod%20G) 
- 生成多项式G由相关标准定义，包括8，12，16，32位的G；
   链路层协议往往采用CRC-32，使用32位的G

### CRC特点

- 能检测小于r+1位的比特差错；
- 适当假设下，以概率![1-0.5^r](https://math.jianshu.com/math?formula=1-0.5%5Er)检测到大于r+1位的差错；
- 能检测任何奇数个比特差错；



# 计算机网络——链路层-多路访问链路和协议

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.10.27 21:05:36字数 2,466阅读 2

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 多路访问链路和协议

**点对点链路**

- 链路上只有一个发送方和一个接收方

**广播链路**

- 多个发送和接受节点连接到相同，单一，共享的广播信道；
- 任一节点传输一个帧时，信道广播该帧，其它每个节点都收到帧的一个副本；
- 节点同时具有发送帧和接受帧的能力；

**多路访问问题**

- 研究如何协调多个发送节点和接收节点对一个共享广播信道的访问；

**碰撞**

- 多个节点同时传输帧，所有节点同时接收多个帧；
- 碰撞发生时，通常没有任何一个节点能有效地获得任何传输的帧；

## 多路访问协议

- 规范节点在共享广播信道上传输行为的协议；

**类别**

- 信道划分协议，随机接入协议，轮流协议；

**理想特性**

- 对速率为R bps的广播信道：
  1. 仅有一个节点发送数据时，该节点吞吐量 R bps；
  2. 当M个节点发送数据时，每个节点在某段适当定义的时间内有R/M的平均传输速率；
  3. 协议是分散的，不会因为某个主节点的故障而导致整个系统的崩溃；
  4. 协议是简单的，实现不昂贵；

## 信道划分协议

- 将信道资源分片，每个节点获得![\frac{1}{N}](https://math.jianshu.com/math?formula=%5Cfrac%7B1%7D%7BN%7D)的信道资源

**优点** 消除碰撞，公平；
**缺点** 即使信道空闲，节点也有![\frac{R}{N}](https://math.jianshu.com/math?formula=%5Cfrac%7BR%7D%7BN%7D)的速率上限；

### 时分多路复用(TDM)

- 对支持N个节点通信的协议，将时间划分为时间帧，每个时间帧划分为N个时隙，把每个时隙分配给每个节点；

### 频分多路复用(FDM)

- 将信道划分为等带宽的不同频段，把每个频段分配给每个节点；

### 码分多址(CDMA)

- 对每个节点分配一种不同的编码；
- 每个节点用它唯一的编码来对它发送的数据编码；
- 对精心选择的编码，CDMA网络具有良好的特性：*不同的节点能够同时传输，且它们各自相应的接收方能够正确接收发送方编码的比特数据，即使存在其它节点的干扰传输；*
- 码分多址分配的是码片资源，按码分多址的编码方式每个有效数据比特都会被编码为多个信道数据比特，每个节点实际上也只能获得![\frac{1}{N}](https://math.jianshu.com/math?formula=%5Cfrac%7B1%7D%7BN%7D)的信道资源；

- CDMA技术使用广泛，如蜂窝电话；

## 随机接入协议

- 一个传输节点总以信道的全部速率发送；
- 当有碰撞时，涉及碰撞的每个节点反复地重发它的帧，直至该帧无碰撞地发送；
- 当节点经历一次碰撞后，它等待一个随机时延后重发帧；

*以太网是一种流行的CSMA协议*

### 时隙ALOHA协议

- 最简单的随机接入协议；

#### 假设

- 所有帧由L比特构成；
- 时间被划分为L/R秒的时隙，即一个时隙等于传输一帧的时间；
- 节点只在时隙起点开始传输帧；
- 节点同步，每个节点都知道时隙何时开始；
- 若一个时隙中存在帧碰撞，则所有节点都能在该时隙结束前检测到该碰撞事件；

#### 节点操作

1. 若节点有一个新帧待发送，它等到下一个时隙开始并在该时隙传输整个帧；
2. 若无碰撞，该节点成功传输帧；
3. 若有碰撞，该节点能在时隙结束前检测到碰撞；该节点以概率p在后续的每个时隙中重传该帧，直至该帧被成功传输；

#### 时隙ALOHA效率

- 有碰撞或所有节点都因概率传输而等待的时隙是被浪费的；
- **成功时隙** 恰有一个节点传输数据的时隙；
- **效率** 当有大量节点要传输大量帧时，长期运行中成功时隙的份额；

- 理论分析可确定，当有大量节点要传输大量帧时，效率![\frac{1}{e}](https://math.jianshu.com/math?formula=%5Cfrac%7B1%7D%7Be%7D),即仅有37%的时隙做有效工作；
- 同时，有![\frac{1}{e}](https://math.jianshu.com/math?formula=%5Cfrac%7B1%7D%7Be%7D)的空闲时隙，![1-\frac{2}{e}](https://math.jianshu.com/math?formula=1-%5Cfrac%7B2%7D%7Be%7D)的碰撞时隙；

### ALOHA协议

- 纯ALOHA协议不要求节点同步传输，即在逻辑上，没有一个公共的，周知的逻辑时隙时钟；
- 当节点从上层收到一个新的待传输帧，节点立即广播该帧；
- 若一个传输的帧发生了碰撞，节点每经过一个帧传输时长就以概率p重传帧；

- 理论分析可确定，当有大量节点要传输大量帧时，效率为![\frac{1}{2e}](https://math.jianshu.com/math?formula=%5Cfrac%7B1%7D%7B2e%7D),即为时隙ALOHA协议的一半；

### 载波侦听多路访问(CSMA)

- ALOHA协议的特点在于，一个节点的传输决定独立于连接到该信道上的其它节点；
  特别是，一个节点不关心它开始传输时是否有其它节点正在信道上传输；
  而且，即使有其它节点干扰它的传输，节点也不会停止传输当前帧；

#### 载波侦听

- 节点在传输前侦听信道，若信道忙，节点等待直至检测到在一小段连续的信道空闲时间再开始传输；
- 即使所有节点都采用了载波侦听技术，由于端到端信道传播时延（空间差造成的时间差），碰撞仍是可能的，即某节点通过侦听，事实上只能确认在一段极小时延前，信道上没有节点正在传播数据；

### 具有碰撞检测的载波侦听多路访问(CSMA/CD)

#### 碰撞检测(collision detection)

- 节点在传输帧的同时也监听信道，若监听到碰撞，则停止传输，并在重新开始传输前等待一段随机时间；

- 若无碰撞检测，即使出现了碰撞节点也会完全传输已发送了碰撞的无用帧；
- 碰撞检测可以使节点在碰撞发生后的一个很短的时延里结束不必要的传输；
- 事实上，所有多路访问协议都有某种形式的碰撞检测，因为协议必须判断一个帧的传输是否成功；此处的碰撞检测是指近乎实时的碰撞检测；

#### 节点行为

1. 网络适配器从网络层获得一个数据报，准备链路层帧，将之放入帧适配器缓存中；
2. 若帧适配器侦听到信道空闲，则它开始传输帧；若适配器侦听到信道忙，则适配器等待直到信道空闲；
3. 传输过程中，适配器监听信道；若无碰撞，该帧顺利传输；若发生了碰撞，立即中止传输；
4. 中止传输后，适配器等待一个随机时间量，而后返回步骤2；

#### 随机时间间隔

- 碰撞发生后节点会等待一个随机时间间隔以防再次碰撞；
- 问题在于时间间隔的选取；
- 理想间隔应当满足：碰撞节点数较少时，时间间隔短；碰撞节点数较多时，时间间隔长；

**二进制指数后退算法**

- 在帧经历了连续n次碰撞后，节点随机从集合{0,2,4....2^(n-1)}中选取一个K值作为时间间隔；
- 实践中，限制n的最大值为10，即超过10次碰撞后，n的值被锁定为10，且一旦碰撞此时超过某特定值（16），则协议停止尝试并向上层通告错误；

#### CSMA/CD 效率

- 当有大量节点要发送大量帧时，帧在信道中无碰撞传输的时间在长期运行中所占的份额；

![效率 = \frac{1}{1+\frac{5d_{prop}}{d_{trans}}}](https://math.jianshu.com/math?formula=%E6%95%88%E7%8E%87%20%3D%20%5Cfrac%7B1%7D%7B1%2B%5Cfrac%7B5d_%7Bprop%7D%7D%7Bd_%7Btrans%7D%7D%7D)

![d_{prop}](https://math.jianshu.com/math?formula=d_%7Bprop%7D) 信号在任意两节点间传播所需的最大时间
![d_{trans}](https://math.jianshu.com/math?formula=d_%7Btrans%7D) 传输一个最大长度以太网帧的时间

## 轮流协议

- 信道划分协议公平无碰撞但在活跃节点少时低效；
- 随机访问协议在活跃节点少时高效但存在碰撞浪费；
- 轮流协议试题综合以上二者的特点；

### 轮询协议

- 指定一个主节点，主节点轮询每个节点；
- 主节点依次通知每个节点它被允许的传输量，在该节点传输完毕后（传完最大传输量或无更多待传输数据），主节点再通知下一个节点；

- 引入了轮询时延，即主节点通知从节点的时延；
- 主节点故障会导致信道崩溃；

### 令牌传递协议

- **令牌** 小特殊帧，以某种次序在所有节点间传播；
- 当节点收到令牌时，当且仅当它有数据要传输时，它才持有该令牌并传输一个最大限制内的数据而后将令牌传递给下一个节点；否则，它立即向下一个节点传输令牌；

- 一个节点的故障（如不肯释放令牌）可能导致信道崩溃；

# 计算机网络——链路层-交换局域网

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.10.27 22:27:39字数 1,188阅读 3

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 交换局域网

## 链路层寻址和ARP

### MAC地址

- 又称LAN地址，物理地址；
- 主机，路由器具有链路层地址。事实上，主机或路由器上的网络适配器具有链路层地址；
- 具有多个网卡的主机或路由器将具有多个链路层地址（同时也具有多个网络层地址，即IP）；
- 链路层交换机的接口不具有链路层地址；(网络层交换机即路由器的接口具有网络层地址即IP)

- 对大多数局域网，MAC地址长度为6字节，常用十六进制数表示,，用“-”分隔每个字节；
- MAC被设计为永久的，但用软件改变一块网络适配器的MAD地址是可能的；
- 网络适配器的MAC地址是唯一的；
- IEEE管理MAC地址空间，网络适配器厂商在生产适配器之前，需向其象征性地支付费用以获得一块地址空间，该地址空间的前24Bit固定；后24bit由厂商为自己的适配器分配；
- 适配器的MAC地址具有扁平结构而非层次结构；

- 发送帧时，网卡目的网卡的MAC地址插入帧中，并将该帧发生到局域网；
- 接收帧时，网卡检查收到的帧的目的MAC地址是否与自身匹配，若不匹配则丢弃；
- **MAC广播地址** 特殊目的MAC地址，表明该帧发给局域网内的所有网卡。6字节MAC局域网中，广播地址为FF-FF-FF-FF-FF-FF；

**主机和路由器网卡双地址**
网卡同时具有IP地址和MAC地址，为什么？

1. 局域网为任意的网络层协议而设计，并非仅限于IP协议和因特网；
2. 使用可变的网络层地址会造成麻烦；
3. 若不使用任何链路层地址，而将链路层帧的数据直接交付给网络层，由网络层负责匹配，这样做会给上层带来较大负担（对每个帧都要中断网络层）；

### 地址解析协议(Address Resolution Protocol,ARP)

#### ARP服务

- 因特网通过地址解析协议实现网络层地址(IP)和链路层地址(MAC)间的转换；
- 端系统的ARP模块将其所在局域网上的任一IP地址作为输入，将相应MAC地址作为输出；
- ARP为同一个子网上的主机和路由器解析IP地址；
- ARP协议跨越网络层和链路层边界；
- ARP协议即插即用，通过ARP解析自动建立，无需管理员配置；

#### ARP表

- 每台主机或路由器在内存中存放一张ARP表，该表包含IP地址到MAC地址的映射；
- 表项包含IP地址，MAC地址，寿命TTL（过期时间，时长常为20分钟）三个字段；
- ARP表事实上是一个缓存，它缓存了ARP解析的数据；

#### ARP解析

假定要主机A要查询IP Ib 的MAC

1. 检查ARP表中有无 IP Ib 的表项，若有，返回相应地址；若无，进入2；
2. 向网卡传递一个ARP查询分组，该分组的源包括主机A的IP和MAC，该分组的目的地包括IP Ib和MAC广播地址；
3. ARP查询分组在子网中传播，被每个其它网卡接收；
4. 每个网卡接收该查询分组并将数据交付各自的ARP模块，ARP模块检查查询分组中的目标IP，若目标IP不匹配则丢弃，若匹配，则向查询主机发送一个ARP响应分组，通过自身的MAC；
5. 主机A收到ARP响应，更新ARP表；

#### 跨子网数据报

- 当向其它子网发送数据报时，发送主机不可能知晓最终目的地的MAC地址，因为ARP协议只解析同一子网内的IP；
- 事实上，发送主机设置数据报的目标IP是最终目的主机，但目标MAC却是同一子网内的第一跳路由器在该子网一侧的网卡的MAC，该MAC也是通告ARP获得；
- 路由器接收到来自子网A的数据报后，为之设置恰当的源和目的MAC地址并转发到另一个子网中的接口；

# 计算机网络——链路层-以太网

![img](http://cdn2.jianshu.io/assets/default_avatar/5-33d2da32c552b8be9a0548c7a4576607.jpg)

[疼呃](https://www.jianshu.com/u/ce2a519c710d)关注

2019.10.27 22:28:18字数 661阅读 7

[计算机网络系列博文——目录](https://www.jianshu.com/p/0013295ca4b4)

# 以太网

- 流行的有线局域网技术；

## 以太网服务

- 无连接服务
- 不可靠服务，直接丢弃存在差错的帧

## 以太网设备

- **转发器** 物理层设备，作用于每个比特。在输入端接收信号并在输出端再生信号，使得信号能传递更长距离；
- **集线器** 物理层设备，作用于每个比特。将到达接口的每个bit放大后向所有其它接口传输出去；
- **交换机** 链路层设备，作用于链路层帧。是链路层的存储转发交换机；

## 以太网帧结构

- **数据字段**
  46~1500 byte
  最大传输单元(MTU)为1500byte；
  最小数据大小46byte，若不够需填充；
  为什么有最小限制？因为广播媒体上运行的协议要确保能在一个帧传输完前监听到来自链路另一侧的干扰信号；
- **目的地址**
  6 byte
  目的网卡的MAC地址
- **源地址**
  6 byte
  源网卡的MAC地址
- **类型字段**
  2 byte
  指示所承载数据应当交付给何种网络层协议
- **CRC**
  4 byte
  循环冗余检测字段，做差错校验
- **前同步码**
  8 byte
  固定：10(31)11，即31个10后接一个11，或者说，7字节的10101010后接1字节的10101011；
  唤醒接收适配器，同步收发双方的时钟，通知数据帧的到来

## 以太网技术

- 以太网包括一系列现已被IEEE工作组标准化了的技术族；
- 以太网是链路层也是物理层规范；

示例：

- 某以太网技术标准的缩写 10GBASE-T
- 10G表示该标准的速率为10G；
- BASE表示基带以太网，即该物理媒体仅承载以太网流量；
- T表示物理媒体为双绞铜线；

### 以太网技术演变

1. 二十世纪80年代，以太网使用总线拓扑，是广播局域网；
2. 20世纪90年代后期，以太网使用基于集线器的星形拓扑，是广播局域网；
3. 21世纪早期，以太网使用基于交换机的星形拓扑；

- 早期基于总线拓扑或星形拓扑的以太网使用广播信道，而后基于交换机的以太网可用使用点对点信道；
- 基于交换机的以太网中不会有碰撞，没必要使用MAC协议；

# 链路层交换机

- 接收链路层帧并将之转发到相应出链路；
- 交换机对子网中的主机和路由器是透明的，即主机和路由器不必要了解交换机
   的存在；

-  **过滤** 决定是否应丢弃帧
-  **转发** 决定接收的帧应当被导向哪个接口，并将帧移动到该接口

## 交换机表

- 实现过滤和转发功能；
- 交换机表包含对应于某局域网上某些主机和路由器的表项；
- 表项包含MAC地址字段，通向该地址的交换机接口字段，表项放置在表中的时间字段；

## 交换机行为

设若从交换机接口x到达一个目的地为MAC A的帧

- 若无A对应的表项，交换机广播该帧；即向接口x以外的所有接口输出该帧；
- 若A对应的表项将A映射到接口x，交换机丢弃该帧；
- 若A对应的表项将A映射到接口y，交换机将该帧放入y的输出缓存以待输出；

## 交换机自学习

交换机表自动，动态，自治地建立，无需网络管理员或配置协议的干预；

**自学习过程**

1. 交换机表初始为空；
2. 设在t时刻x接口上收到了一个源MAC为a的帧，则交换机设置（添加或更新）一个以t为初始时间字段，x为接口字段，a为MAC地址字段的表项；故而，若局域网中的节点发送了帧，交换机便会自动地记录下相应信息；
3. 若在老化期内，交换机一直没接收到某个已有表项所对应的帧，交换机将清除该表项；

- 交换机即插即用双全工；

## 交换机性质

-  **消除碰撞** 交换机缓存帧且决不会在网段上同时传输多个帧，故不可能发生碰撞；
-  **异质链路** 交换机将链路彼此隔离，故局域网可以使用不同速率乃至不同媒介的链路。易于实现新旧设备的混用；
-  **管理** 安全性更强，网络管理更方便。交换机可以智能检测某些问题并断开异常链路，同时交换机也能收集网络流量信息以便调试管理；

## 交换机与路由器

**交换机**

- 交换机即插即用
- 交换网络的活跃拓扑被限制为一颗生成树，因为冗余路径会导致广播帧的循环；
- 大型交换网络要求在主机和路由器中维护大ARP表
- 交换机对于广播风暴不提供保护措施

**路由器**

- 路由器需人工配置（IP等）
- 路由网络拓扑结构灵活，允许冗余路径；
- 路由器提供更健壮地流量隔离和对广播风暴的控制；





# 链路虚拟化

- 链路是连接两台通信主机间的信道；
- 信道可以是一条物理链路，也可以是无线电频谱，交换以太网，乃至更复杂的电话网络等；
- 即逻辑上简单的一条链路层链路，物理上可能是相当复杂的实体网络；

## 多协议标签交换网络(MPLS)

- 分组交换的虚电路网络，可以作为为因特网IP设备提供服务的链路层技术；
- 产业界将虚电路技术综合进了数据报网络以改善IP路由器的转发速度；
- 对于基于固定长度标签和虚电路的技术，在不放弃基于目的地IP数据报转发的基础设施的前提下，当可能时通过选择性地标识数据报并允许路由器基于固定长度的标签而非IP地址转发数据报以增强其功能；
- MPLS基于标签执行交换而不必考虑分组的IP地址；
- 优点在于交换速度的潜在增加和流量管理能力；
- MPLS的流量管理能力使得网络运行者能超越IP路由选择，迫使流量沿特定路径移动；
- MPLS已被用于实现虚拟专用网(VPN)；



# 数据中心网络

- 本节介绍用于云应用的数据中心网络；

- 数据中心的主机称作刀片，通常是含CPU，内存，磁盘的商用主机；
- 主机被堆叠在机架上，每个机架一般有20~40台刀片；
- 每个机架顶部有一台机架顶部交换机，其与该机架主机相连，并与数据中心的其它交换机相连；

- 数据中心网络包括内部主机间的流量和外部客户与内部主机间的流量；










  