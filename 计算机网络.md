# 一、概述

- 局域网：局域网（`Local Area Network，LAN`）是指在某一区域内由多台计算机互联成的计算机组。覆盖范围小，自己花钱买设备，宽带是固定的，自己维护。
- **Internet**：由众多`ISP`（网络运营商）构成，有自己的机房，对网民提供访问`Internet`连接。
- 广域网：距离比较远（这里不一定是指实际距离，而是指链路的距离），花钱买带宽，无须自己维护设备。

## 1.1 网络传输





![img](https:////upload-images.jianshu.io/upload_images/1925650-d23c3489ccb5047d.png?imageMogr2/auto-orient/strip|imageView2/2/w/952/format/webp)

1

说明：

这里我们通过一个例子来描述数据是如何在网络中进行传输的。这里左边的局域网表示学校，而右边表示公司的局域网，中间表示互联网。其中

```
m
```

表示

```
mac
```

地址。



- 这里学校里的计算机（上面那台）想要访问公司的局域网，其地址为`www.baidu.com`，首先此计算机需要知道此域名和哪个`IP`地址相对应，于是要将此域名发送到`DNS`（维护域名和`IP`地址的映射关系）中去解析。这里解析完之后知道对应地址为`13.0.0.2`。于是要向此地址发送请求。
- 发送请求时要封装一个数据包，其中包含内容为：

|1|2|3|4|5|
 |------------|
 |实际数据|源地址`15.0.0.2`|目标地址`13.0.0.2`|`m4`|`m5`|
 之所以需要物理地址，就是因为网卡在将数据发送出去的时候需要知道发送到路由器`G`，而不是下面那台电脑。这里需要注意，如果前面三段合起来称为**数据包**，加上后面的两个物理地址称为**数据帧**。

- 几个概念
   **子网掩码**：如`255.0.0.0`，这里表示IP地址的第一段为网络段，而后面三段表示主机段，网路段就是用来和互联网中其他局域网或主机交互的地址信息，而主机段就是局域网内部对各主机的一种编号。
   **网关**：这里可以看到学校局域网的网关是`15.0.0.1`，起始就是表示一个局域网和外界交互的关口。这里就是路由器的`IP`地址。
   **物理地址**：其实就是一个对硬件的标识，每台机器都不一样，是一个`48`位二进制编号，在上面我们已经解释了他的作用。
- 上面我们说了，现在请求已经到达了路由器`G`了，那么`G`必须先将请求发送给`A`，于是这里我们需要重写后面两个物理地址，发送的内容就变为：

|1|2|3|4|5|
 |------------|
 |实际数据|源地址`15.0.0.2`|目标地址`13.0.0.2`|`m7`|`m8`|
 虽然物理地址变了，但是前面的数据包是没变的 。就这样依次发送到需要的主机上。

- 公司中主机在响应数据的时候可能网页数据较大，此时需要将一个网页分成多块进行发送，并对各块进行编号，依次放入网卡的缓存中进行发送，每块数据在发送过程中，缓存是不能将这块数据删除的，只有当这块数据发送到指定主机，主机返回确认信息之后才能删除，这样依次将数据响应给学校主机。

## 1.2 OSI参考模型

- 应用层：所有能产生网络流量的程序
- 表示层：在传输之前是否进行加密或压缩处理成二进制`ASCII`编码，比如出现乱码页式表示层出现了问题
- 会话层：查木马(`netstat –n`)（即打开的窗口上显示对应的网页内容，也就是客户端和服务端建立了会话）
- 传输层：可靠传输，流量控制，不可靠传输
- 网络层：负责选择最佳路径 ，规划`IP`地址
- 数据链路层：定义帧的开始和结束，透明传输，差错校验
- 物理层：接口标准 、电器标准 、如何在物理链路上传输更快的速度

## 1.3 OSI参考模型对网络排错的指导

一般排错需要从底层往上进行故障排查：

- 物理层：比如查看网线有没有接上，接上与没有接上的区别如下：

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-324892a9e2cf42ea.png?imageMogr2/auto-orient/strip|imageView2/2/w/506/format/webp)

  2

  可以看到左边就表示没有接上，而右边表示连接上了。但是有时候显示连接上了，但是网络还是不通，此时我们需要查看网络连接：

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-48675751151a76a5.png?imageMogr2/auto-orient/strip|imageView2/2/w/414/format/webp)

  3

   如上，如果已发送的字节有，而已接收却没有字节，这可能表示水晶头有问题了。

- 数据链路层：比如在一个局域网中可以上网，但是在另一个局域网中却不能上网，此时有可能是在前一个局域网中物理地址冲突，因为物理地址是可以改的，这就是数据链路层的问题。再比如有时候欠费也是数据链路层被断开了。还有两个互相连接的网卡的带宽是进行协商的，但是如果将某张网卡的带宽强制设置成某个数，那么有可能导致带宽不一致，最后导致网络不通。

- 网络层：比如设置的`IP`与路由器不是在一个网段，或者网关设置错误（导致计算机没有连接外部网络的关口），还有路由器如果没有配置到达目标地址的信息页式网络层故障。

- 应用层：这里我们将网络层向上都归属为应用层故障。网络不通不一定是网络问题，有可能是应用程序的问题，比如浏览器是不是设置了代理等等原因。

## 1.4 TCP/IP协议和OSI参考模型





![img](https:////upload-images.jianshu.io/upload_images/1925650-fd485ab816c64693.png?imageMogr2/auto-orient/strip|imageView2/2/w/654/format/webp)

4

说明：

这里

```
TCP/IP
```

协议是将

```
OSI
```

参考模型进行了简化，但是有时候一层中也是分层的，比如网路层中的

```
ARP
```

就是为

```
IP
```

协议服务，而

```
IP
```

协议就是为

```
ICMP、IGMP
```

服务的。数据在使用此协议进行传输的时候首先要进行封装，过程如下：



![img](https:////upload-images.jianshu.io/upload_images/1925650-f0b115bc3613b851.png?imageMogr2/auto-orient/strip|imageView2/2/w/697/format/webp)

5



![img](https:////upload-images.jianshu.io/upload_images/1925650-4d747232163d1a5d.png?imageMogr2/auto-orient/strip|imageView2/2/w/831/format/webp)

6



## 1.5 计算机网络的性能

- 1、速率：连接在计算机网络上的主机在数字信道上传送数据位数的速率，也称为`data rate`或`bit rate`。单位为`b/s，kb/s`等。这里要注意我们经常听到的带宽为`4M`，其使用的单位就是比特率，但是我们在`360`加速球上看到的速率是使用的`byte rate`，也就是说如果带宽是`4M`，而在加速球上看到的是`400k/s`，那么就差不多是对的了，需要除以`8`。

- 2、带宽：数据通信领域中，数字信道所能传送的最高数据率。单位为`b/s，kb/s`等。

- 3、吞吐量：即在单位时间内通过某个网络的总的数据量；单位为`b/s，kb/s`等。这里包括接收和发送的总数据量。

- 4、时延
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-4911442666f7d077.png?imageMogr2/auto-orient/strip|imageView2/2/w/585/format/webp)

  7

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-95b715a39cafab55.png?imageMogr2/auto-orient/strip|imageView2/2/w/595/format/webp)

  8

  说明：

  发送时延是指从数据块的第一个比特开始发送算起，到最后一个比特发送完毕所需的时间，传播时延是指在网路上传播所需时间，排队时延和处理时延是指路由器对数据的一些处理所占用的时间。我们平常说的带宽提高指的不是传播速度快了，因为这和介质有关，这里是指发送时延降低了。

  

- 5、时延带宽积
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-4fde59943b7a393b.png?imageMogr2/auto-orient/strip|imageView2/2/w/488/format/webp)

  9

  说明：

  实际意义就是指有多少数据在链路中传播。

  

- 6、往返时间`RTT（Round-Trip Time）`：从发送方发送数据开始到发送方收到接收方确认。使用`ping`命令进行测试。

- 7、利用率

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-32c2bff923f7c0fc.png?imageMogr2/auto-orient/strip|imageView2/2/w/832/format/webp)

  10





# 物理层

## 2.1 物理层的基本感念

物理层解决如何在连接各种计算机的传输 媒体上传输数据比特流，而不是指具体的传输媒体。物理层的主要任务描述为：确定传输媒体的接口的一些特性，即

- 机械特性：例接口形状，大小，引线数目
- 电气特性：例规定电压范围（`+5`到`-5`）
- 功能特性：例规定`-5v`表示`0`，`+5v`表示`1` 
- 过程特性：也称规程特性，规定建立连接时各个相关部件的工作步骤。

## 2.2 数据通信的基础知识

- **典型的数据通信模型**
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-39839b341916af0d.png?imageMogr2/auto-orient/strip|imageView2/2/w/741/format/webp)

  1

  说明：

  这是典型的数据通信模型，而局域网中的两台电脑就直接发出数字信号，接收数字信号。

  

- **相关术语**
   1、通信的目的是传送消息
   2、数据：运送消息的实体
   3、信号：数据的电气或电磁表现
   4、模拟信号：代表消息的参数的取值是连续的
   5、数字信号：代表消息的参数的取值是离散的
   6、码元：在使用时间域的波形表示数字信号时，则代表不同离散值的基本波形就称为码元。其实就是表示`0`或`1`的波形。在数字通信中常用时间间隔相同的符号来表示一个二进制数字，这样的时间间隔内的信号称为二进制码元。而这个间隔被称为码元长度。`1`码元可以携带`nbit`的信息量。这里之所以是`nbit`是因为有时候可能我们信号的取值不是只有`-5v`和`+5v`两种取值，而可能有`000、001、...、111`等七种不同的取值，而这里的`000`就是一个码元，而它可以表示`3bit`的信息量。

- **有关信道的几个基本概念**
   1、信道一般表示向一个方向传送信息的媒体。所以咱们说平常的通信线路往往包含一条发送信息的信道和一条接收信息的信道。
   2、单向通信（单工通信）：只能有一个方向的通信而没有反方向的交互，比如有线电视。
   3、双向交替通信（半双工通信）：通信的双方都可以发送信息，但不能双方同时发送（当然也就不能同时接收），比如对讲机。
   4、双向同时通信（全双工通信）：通信的双方可以同时发送和接收信息。

- **基带（baseband）信号和带通（band pass）信号**
   1、基带信号（基本频带信号）：来自信源的信号。像计算机输出的代表各种文字或图像文件的数据信号都属于基带信号。基带信号就是发出的直接表达了要传输的信息的信号，比如我们说话的声波就是基带信号。
   2、带通信号：把基带信号经过载波调制后，把信号的频率方位搬移到较高的频段，以便在信道中传输（即仅在一段频率范围内够通过信道）。
   因此在传输距离较近时，计算机网络都采用基带传输方式，由于在近距离范围内基带信号的衰减不大，从而信号内容不会发生变化。因此在传输距离较近时，计算机网络都采用基带传输方式。如从计算机到监视器、打印机等外设的信号就是基带传输的。

- **几种基本的调制方法**
   调幅(`AM`)：载波的振幅随基带数字信号而变化。
   调频(`FM`)：载波的频率随基带数字信号而变化。
   调相(`PM`) ：载波的初始相位随基带数字信号而变化。正弦波、余弦波 交替。
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-65f6d55bcb1acebe.png?imageMogr2/auto-orient/strip|imageView2/2/w/651/format/webp)

  2

  

- **常用编码**
   1、单极性不归零码：只使用一个电压值，用高电平表示`1`，没电压表示`0`。
   2、双极性不归零码：用正电平和负电平分别表示二进制数据的`1`和`0`，正负幅值相等。
   3、单极性归零码：以高电平和零电平分别表示二进制`1`和`0`，而且在发送码`1`时高电平在整个码元期间`T`只持续一段时间`τ`，其余时间返回零电平。
   4、双极性归零码：正负零三个电平，信号本身携带同步信息。
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-acbc9fe8fd3f330e.png?imageMogr2/auto-orient/strip|imageView2/2/w/633/format/webp)

  3

   5、曼彻斯特编码

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-24223a82f8a24dfa.png?imageMogr2/auto-orient/strip|imageView2/2/w/595/format/webp)

  4

  说明：

  前面的编码中信号

  ```
  0
  ```

  与没有信号都表示为

  ```
  0
  ```

  ，而这里就能区分开来。

   6、差分曼彻斯特编码

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-6dd2178d651ee08f.png?imageMogr2/auto-orient/strip|imageView2/2/w/533/format/webp)

  5

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-59c18639b7087614.png?imageMogr2/auto-orient/strip|imageView2/2/w/586/format/webp)

  6

  

- **信道的极限容量**
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-8fd6b7be8473d6fb.png?imageMogr2/auto-orient/strip|imageView2/2/w/618/format/webp)

  7

   奈氏准则：

  ```
  1924
  ```

  年，奈奎斯特就推导出了著名的奈氏准则。他给出了在假定的理想条件下，为了避免码间串扰，码元的传输速率的上限值。在任何信道中，码元传输的速率是有上限的，否则就会出现码间串扰，使接收端对码元的识别称为不可能。如果信道的频带越宽，也就是能够通过的信号高频分量越多，那么就可以用更高的速率传送码元而不出现码间串扰。

  

- **波特与比特的区别**
   波特 在调制解调器中经常用到波特这个概念，比特是信息量 。如果一个码元含有`3 bit`信息量`1波特 = 3 bit/s`

- **信噪比**
   香农用信息论的理论推导出了带宽受限且有高斯白噪声干扰的信道的极限、无差错的信息传输速率。信道的极限信息传输速率`C`可表达为：
   `C = W log2(1+S/N) b/s`，其中`W`为信道的带宽（单位为`Hz`）；`S`为信道内所传信号的平均功率；`N`为信道内部的高斯噪声功率。
   香农公式表明：
   1、信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高。
   2、只要信息传输速率低于信道的极限信息传输速率，就一定可以找到某种办法来实现无差错的传输。
   3、若信道带宽 `W` 或信噪比 `S/N` 没有上限（当然实际信道不可能是这样的），则信道的极限信息传输速率 `C` 也就没有上限。
   4、实际信道上能够达到的信息传输速率要比香农的极限传输速率低不少。

- **奈氏准则和香农公式的应用范围**
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-6bbd0e56ba047621.png?imageMogr2/auto-orient/strip|imageView2/2/w/682/format/webp)

  8

  

## 2.3 物理层下面的传输媒体

- **导向传输媒体**
   导向传输媒体中，电磁波沿着固体媒体传播。
   1、双绞线
   屏蔽双绞线 `STP`
   无屏蔽双绞线 `UTP`
   2、同轴电缆
   `50Ω`同轴电缆 用于数字传输，由于多用于基带传输，也叫基带同轴电缆；
   `75Ω`同轴电缆用于模拟传输，即宽带同轴电缆。
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-49db03ae1ec39e12.png?imageMogr2/auto-orient/strip|imageView2/2/w/558/format/webp)

  9

   这里我们细说一下网线：

   1、直通线：具体的线序制作方法是，双绞线夹线顺序是两边一致，统一都是：

  ```
  1：白橙、2：橙、3：白绿、4：蓝、5：白蓝、6：绿、7：白棕、8：棕
  ```

  。注意两端都是同样的线序且一一对应。这就是

  ```
  100M
  ```

  网线的做线标准，即

  ```
  568B
  ```

  标准，也就是我们平常所说的正线或标准线、直通线。

   2、直通线应用最广泛，这种类型的以太网电缆用来实现下列连接：

   主机到交换机或集线器，路由器到交换机或集线器，而主机到主机要使用交叉线。

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-8d68eed4efc28d43.png?imageMogr2/auto-orient/strip|imageView2/2/w/579/format/webp)

  10

   现在有些网卡比较智能，可以自动调整线序。

   3、光缆

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-1ce8b71e0ee16525.png?imageMogr2/auto-orient/strip|imageView2/2/w/628/format/webp)

  11

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-81ac73cff55ace47.png?imageMogr2/auto-orient/strip|imageView2/2/w/573/format/webp)

  12

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-975b2efcc71ac918.png?imageMogr2/auto-orient/strip|imageView2/2/w/695/format/webp)

  12

  说明：

  单模光纤指只能传输一种电磁波模式，多模光纤只可以传输多个电磁波模式，实际上单模光纤和多模光纤之分，也就是纤芯的直径之分。其实就是多模光纤可以传播多种入射角的光，而单模光纤中，光就不进行反射，而是直接传播。单模光纤细，多模光纤粗。在有线电视网络中使用的光纤全是单模光纤，其传播特性好，带宽可达

  ```
  10GHZ
  ```

  ，可以在一根光纤中传输

  ```
  60
  ```

  套

  ```
  PAL—D
  ```

  电视节目。

  

- **非导向传输媒体**
   非导向传输媒体就是指自由空间，其中的电磁波传输被称为无线传输。无线传输所使用的频段很广。短波通信主要是靠电离层的反射，但短波信道的通信质量较差。微波在空间主要是直线传播。 有地面微波接力通信，卫星通信 。

- **物理层设备-集线器**
   工作特点：它在网络中只起到信号放大和重发作用，其目的是扩大网络的传输范围，而不具备信号的定向传送能力，就是集线器会将收到的信号像所有接在其上的主机发送，有网卡去判断是否要接收。最大传输距离：`100m`。集线器是一个大的冲突域。现在使用较少了，一般都使用交换机

## 2.4 信道复用技术

复用是通信技术中的基本概念。



![img](https:////upload-images.jianshu.io/upload_images/1925650-f066d2f03d9e4023.png?imageMogr2/auto-orient/strip|imageView2/2/w/672/format/webp)

1

- 频分复用（`FDM`）
   用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。频分复用的所有用户在同样的时间占用不同的带宽资源（请注意，这里的“带宽”是频率带宽而不是数据的发送速率）。
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-3763997de472a093.png?imageMogr2/auto-orient/strip|imageView2/2/w/643/format/webp)

  2

  说明：

  三种信号的波先经过调制之后相加得到一个总的波形，接收端接收到之后进行解调，依次分解出三种信号。例如打电话就是这样。

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-ec2cfbe51041597f.png?imageMogr2/auto-orient/strip|imageView2/2/w/630/format/webp)

  3

  

- 时分复用（`TDM`）
   时分复用则是将时间划分为一段段等长的时分复用帧（`TDM` 帧）。每一个时分复用的用户在每一个 `TDM` 帧中占用固定序号的时隙。每一个用户所占用的时隙是周期性地出现（其周期就是 TDM  帧的长度对应的时间）。`TDM`信号也称为等时(`isochronous`)信号。时分复用的所有用户是在不同的时间占用同样的频带宽度。
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-0cf80036ee6a3e33.png?imageMogr2/auto-orient/strip|imageView2/2/w/631/format/webp)

  4

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-64efbf2be36c8da7.png?imageMogr2/auto-orient/strip|imageView2/2/w/572/format/webp)

  5

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-cf3fcccd80237a7b.png?imageMogr2/auto-orient/strip|imageView2/2/w/686/format/webp)

  6

  说明：

  使用时分复用系统传送计算机数据时，由于计算机数据的突发性质，用户对分配到的子信道的利用率一般是不高的。

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-9f0915cf48f832b0.png?imageMogr2/auto-orient/strip|imageView2/2/w/657/format/webp)

  7

   可以看到一个时间片内有很多空余的位置，这样就造成了浪费。

  

- **统计时分复用（STDM）**
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-5cecb574862cd338.png?imageMogr2/auto-orient/strip|imageView2/2/w/609/format/webp)

  8

  说明：

  就是在信号中标注这个信号是从哪个用户发送过来的，接收到之后根据这些标记进行分解。这里放数据时是没有顺序的。

  

- **波分复用（WDM）**
   波分复用就是光的频分复用。
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-410ef8c6d290863f.png?imageMogr2/auto-orient/strip|imageView2/2/w/689/format/webp)

  9

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-1695877096666bc7.png?imageMogr2/auto-orient/strip|imageView2/2/w/659/format/webp)

  10

  

## 2.5 数字传输系统

脉码调制`PCM`体制最初是为了在电话局之间的中继线上传送多路的电话。由于历史上的原因，`PCM` 有两个互不兼容的国际标准，即北美的 `24` 路 `PCM`（简称为 `T1`）和欧洲的 `30`路`PCM`（简称为`E1`）。我国采用的是欧洲的`E1`标准。`E1`的速率是`2.048 Mb/s`，而 `T1`的速率是 `1.544 Mb/s`。当需要有更高的数据率时，可采用复用的方法。

## 2.6 宽带接入技术

这里特指接入`Internet`的技术。

- `xDSL`(用数字技术对现有的模拟电话用户线进行改造)。标准模拟电话信号的频带被限制在 `300~3400 Hz` 的范围内，但用户线本身实际可通过的信号频率仍然超过 `1 MHz`。`xDSL` 技术就把 `0~4 kHz`低端频谱留给传统电话使用，而把原来没有被利用的高端频谱留给用户上网使用。而我们常用的使用电话线进行上网是使用的`ADSL`，其特点是：上行和下行带宽做成不对称的。`ADSL` 在用户线的两端各安装一个 `ADSL` 调制解调器。我国目前采用的方案是离散多音调 `DMT (Discrete Multi-Tone)`调制技术。`DMT` 调制技术采用频分复用的方法，把`40 kHz` 以上一直到 `1.1 MHz` 的高端频谱划分为许多的子信道，其中 `25`个子信道用于上行信道，而`249`个子信道用于下行信道。每个子信道占据 `4 kHz`带宽,并使用不同的载波（即不同的音调）进行数字调制。这种做法相当于在一对用户线上使用许多小的调制解调器并行地传送数据。
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-6ee2e290af1fde09.png?imageMogr2/auto-orient/strip|imageView2/2/w/660/format/webp)

  11

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-22e64a2bd644bcb5.png?imageMogr2/auto-orient/strip|imageView2/2/w/639/format/webp)

  12

  

- 光纤同轴混合网`HFC（Hybrid Fiber Coax）`
   这里的`HFC` 网是在目前覆盖面很广的有线电视网`CATV`的基础上开发的一种居民宽带接入网。`HFC` 网除可传送 `CATV` 外，还提供电话、数据和其他宽带交互型业务。现有的 `CATV`网是树形拓扑结构的同轴电缆网络，它采用模拟技术的频分复用对电视节目进行单向传输。而`HFC`网则需要对 `CATV` 网进行改造 。其主要特点是：
   (1) `HFC`网的主干线路采用光纤
   `HFC`网将原 `CATV` 网中的同轴电缆主干部分改换为光纤，并使用模拟光纤技术。在模拟光纤中采用光的振幅调制 `AM`，这比使用数字光纤更为经济。模拟光纤从头端连接到光纤结点(`fiber node`)，即光分配结点`ODN (Optical Distribution Node)`。在光纤结点光信号被转换为电信号。在光纤结点以下就是同轴电缆。
   （2）`HFC` 网采用结点体系结构
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-12f89388986e878c.png?imageMogr2/auto-orient/strip|imageView2/2/w/629/format/webp)

  13

   （3）

  ```
  HFC
  ```

   网具有比 

  ```
  CATV
  ```

   网更宽的频谱，且具有双向传输功能

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-f85630ac30b5edee.png?imageMogr2/auto-orient/strip|imageView2/2/w/661/format/webp)

  14

   （4）每个家庭要安装一个用户接口盒

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-3b9872f61b8d6aa5.png?imageMogr2/auto-orient/strip|imageView2/2/w/529/format/webp)

  15

   其最大的优点就是具有很宽的频带，能够利用已经有相当大的覆盖面的有线电视网。

  

- `FTTx`技术
   `FTTx`（光纤到……）也是一种实现宽带居民接入网的方案。这里字母 `x` 可代表不同意思。光纤到家 `FTTH (Fiber To The Home)`：光纤一直铺设到用户家庭可能是居民接入网最后的解决方法(`155Mb/s`)。光纤到大楼 `FTTB (Fiber To The Building)`：光纤进入大楼后就转换为电信号，然后用电缆或双绞线分配到各用户。光纤到路边`FTTC (Fiber To The Curb)`：从路边到各用户可使用星形结构双绞线作为传输媒体(`155Mb/s`) 。

# 三、数据链路层

## 3.1 基本概念及基本问题

### 3.1.1基本概念

数据链路层的简单模型
 



![img](https:////upload-images.jianshu.io/upload_images/1925650-77a43c708462b1c5.png?imageMogr2/auto-orient/strip|imageView2/2/w/712/format/webp)

1

说明：

本章我们只是关注数据链路层的传输，即仅从数据链路层观察帧的流动。



- **数据链路层的信道类型**
   数据链路层使用的信道主要有以下两种类型：
   1、点对点信道：这种信道使用一对一的点对点通信方式
   2、广播信道：这种信道使用一对多的广播通信方式，因此过程比较复杂。广播信道上连接的主机很多，因此必须使用抓用的共享信道协议来协调这些主机的数据发送。

- **链路与数据链路**
   1、链路是一条点到点的物理线路段，中间没有任何其他的交换结点。一条链路只是一条通路的一个组成部分。
   2、数据链路除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。现今最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件。一般的适配器都包括了数据链路层和物理层这两层的功能。

- **帧**
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-ad4eae27c8bdd69c.png?imageMogr2/auto-orient/strip|imageView2/2/w/716/format/webp)

  2

  说明：

  网络层中传递过来的数据报加上帧头和帧尾以及校验之后就变为数据帧了。数据链路层就像一个数字管道，所以常常在两个对等的数据链路层之间画出一个数字管道，而在这条数字管道上传输的数据单位就是帧。

  

### 3.1.2 三个基本问题

- 封装成帧

   1、封装成帧就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。确定帧的界限。

   2、首部和尾部的一个重要作用就是进行帧定界。

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-1e4eb5484eb82d95.png?imageMogr2/auto-orient/strip|imageView2/2/w/639/format/webp)

  3

   下面看一个例子，用控制字符进行帧定界的方法

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-25b1a33daeb328b0.png?imageMogr2/auto-orient/strip|imageView2/2/w/665/format/webp)

  4

  说明：

  试想，帧还未发送完，发送端出了问题，只能重发该帧。接收端却收到了前面“半截子帧”，它会抛弃吗？为什么？当然这里的开始和结束字符也可以是别的。

- **透明传输**
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-ad8041bb5fc1f24e.png?imageMogr2/auto-orient/strip|imageView2/2/w/701/format/webp)

  5

  说明：

  若传输的数据是

  ```
  ASCII
  ```

  码中“可打印字符（供

  ```
  95
  ```

  个）”集时，一切正常。若传输的数据不是仅由“可打印字符”组成时，就会出现问题，如图所示。如果数据部分恰好包含了开始标记或者结束标记，如何告诉计算机？

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-17b23c8a29d92754.png?imageMogr2/auto-orient/strip|imageView2/2/w/726/format/webp)

  6

  说明：

  发送端的数据链路层在数据中出现控制字符“

  ```
  SOH
  ```

  ”或“

  ```
  EOT
  ```

  ”的前面插入一个转义字符“

  ```
  ESC
  ```

  ”（其十六进制编码是

  ```
  1B
  ```

  ）。

  字节填充或字符填充

  ：接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。如果转义字符也出现在数据当中，那么应在转义字符前插入一个转义字符。当接收端收到连续的两个转义字符时，就删除其中前面的一个。

  

- **差错控制**
   传输过程中可能会产生比特差错：`1`可能会变成`0`，而`0`也可能变成`1`。在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率`BER（Bit Error Rate）`。误码率与信噪比有很大关系。为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施。数据链路层中如果发现数据有误会直接将其扔掉，而是否需要重发是由传输层来决定。

## 3.2 两种情况下的数据链路层

### 3.2.1 使用点对点信道的数据链路层

- **PPP协议使用场合**
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-fdbc1c7cd8ed7a63.png?imageMogr2/auto-orient/strip|imageView2/2/w/695/format/webp)

  7

  说明：

  我们家用的电脑到路由器的那根线就是点对点，使用的是

  ```
  PPP
  ```

  协议。这是一个数据链路层的协议。现在全世界是有那个的最多的数据链路层协议是点对点协议

  ```
  PPP（Point-toPoint Protocol）
  ```

  。用户使用拨号电话线接入

  ```
  Internet
  ```

  时，一般都是使用此协议。

  

- **PPP协议满足的要求**

  - 简单：这是首要的要求
  - 封装成帧
  - 透明性
  - 多种网络协议：如`TCP` 
  - 多种类型链路
  - 差错检测
  - 检测连接状态
  - 最大传送单元
  - 网络层地址协商
  - 数据压缩协商

- **PPP协议不需要满足的要求**

  - 纠错
  - 流量控制
  - 序号
  - 多点线路
  - 半双工或单工链路

- **PPP协议的组成**

  - 数据链路层协议可以用于异步串行或同步串行介质

  - 它使用`LCP`（链路控制协议）建立并维护数据链路连接，如身份验证，计费

  - 网络控制协议（

    ```
    NCP
    ```

    ）允许在点到点连接上使用多种网络协议，如图所示

    

    ![img](https:////upload-images.jianshu.io/upload_images/1925650-ae6f64bf8c551dc5.png?imageMogr2/auto-orient/strip|imageView2/2/w/389/format/webp)

    8

- **PPP协议的帧格式**
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-7c5ee88ea2009ccc.png?imageMogr2/auto-orient/strip|imageView2/2/w/688/format/webp)

  9

  说明：

  其中

  ```
  A、C
  ```

  段是固定的，因为这是点对点，所以不需要地址。而

  ```
  FCS
  ```

  是帧检验序列。

  ```
  PPP
  ```

  是面向字节的，所有的

  ```
  PPP
  ```

  帧的长度都是整数字节。

   这里也会出现字节填充的问题：信息字段中出现了标志字段的值，可能会被误认为是“标志”，怎么办？

  

  - 将信息字段中出现的每个`0x7E`字节转变成两个字节序列（`0x7D，0x5E`）
  - 若信息字段中出现一个`0x7D`的字节，则将其转变成两个字节序列（`0x7D，0x5D`）
  - 若信息字段中出现`ASCII`码的控制字符（即数值小于`0x20`的字符），则在该字符前面要加上一个`0x7D`字节，同时将该字符的编码加以改变。

如果信息部分传递的不是上面所说的字节流，而是二进制流，则透明传输的问题需要使用零比特填充方法：`PPP`协议用在`SONET/SDH`链路时，是使用同步传输（一连串的比特连续传送）。这时`PPP`协议采用零比特填充方法来实现透明传输。在发送端，只要发现有五个连续的`1`，则立即填入一个`0`。接收端对帧中的比特流进行扫描。每当发现五个连续`1`，就把这五个连续`1`后的一个`0`删除。
 



![img](https:////upload-images.jianshu.io/upload_images/1925650-aa0c435f8e18548c.png?imageMogr2/auto-orient/strip|imageView2/2/w/691/format/webp)

10



- **PPP协议不使用序号和确认机制**
   此协议之所以不适用序号和确认机制是出于一下考虑：
  - 在数据链路层出现差错的概率不大时，使用比较简单的`PPP`协议较为合理
  - 在`Internet`环境下，`PPP`的信息字段放入的数据是IP数据报。数据链路层的可靠传输并不能够保证网络层的传输页式可靠的。比如在传输的过程中数据丢失了、有错，这里是不会让发送端重发的，如果有错就扔掉。
  - 帧检验序列`FCS`字段可保证无差错接受。
- **PPP协议的工作状态**
   当用户拨号接入`ISP`时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。`PC`机向路由器发送一系列的`LCP`分组（封装成多个`PPP`帧）。这些分组及其响应的选择一些`PPP`参数，和进行网络层配置，`NCP`（网络控制协议）给新接入的`PC`机分配一个临时的`IP`地址，使`PC`机称为`Internet`上的一个主机。通信完毕时，`NCP`释放网络层连接，收回原来分配出去的`IP`地址。接着，`LCP`释放数据链路层连接。最后释放的是物理层的连接。

### 3.2.2 使用广播信道的数据链路层

局域网中使用广播信道进行数据传输。

- 共享通信媒体
   1、静态划分信道（太麻烦，一般不使用）
   频分复用
   时分复用
   波分复用
   马分复用
   2、动态媒体接入控制（多点接入）
   随机接入（主要被以太网采用）
   受控接入，如多点线路探寻或轮询（目前已不被采用）

- 认识以太网
   最初的以太网是将许多计算机都连接到一根总线上。当初人为这样的连接方法既简单又可靠，因为总线上没有源器件。
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-cd2e58c56082a4aa.png?imageMogr2/auto-orient/strip|imageView2/2/w/692/format/webp)

  11

  说明：

  这是正常情况下的情况，但是如果

  ```
  A
  ```

  计算机想要获得相关数据，就可以使用一些抓包工具实现，这样信息就不安全了。

  

- 以太网使用`CSMA/CD`协议
   `CSMA/CD`表示载波监听多点接入/碰撞检测`Carrier Sense Multiple Access with Collision Detection`。“多点接入”表示许多计算机以多点接入的方式连接在一根总线上行。“载波监听”是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞，就是用电子技术检测总线上有没有其他计算机发送的数据信号。

- 碰撞检测

  - 碰撞检测就是计算机边发送数据边检测信道上的信号电压大小。
     1、当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）
     2、当一个站检测到信号电压摆动值超过一定的门限值时，就人为总线上至少有两个站同时在发送数据，标明产生了碰撞。
     3、所谓“碰撞”就是发生了冲突。因此“碰撞检测”也称“冲突检测”。
  - 检测到碰撞后
     1、在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。
     2、每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送。

- `CSMA/CD`协议的重要特性
   使用此协议的以太网不能进行全双工通信而只能进行双向交替通信（半双工通信）。每个站在发送数据之后一小段时间内，存在着遭遇碰撞的可能性。这种发送的不确定性使整个以太网的平均通信量远小于以太网的最高数据率。

- 争用期
   最先发送数据帧的站，在发送数据帧后至多经过时间2τ（两倍的端到端时延）就可知道发送的数据帧是否遭到了碰撞。经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞。
   **争用期**
   1、以太网的端到端时延`2τ`称为争用期或碰撞窗口。通常，取`51.2μs`为争用期的长度。
   2、对于`10Mb/s`以太网，在争用期内可发送`512bit`，即`64`字节
   3、以太网在发送数据时，若前`64`字节未发生冲突，则后续的数据就不会发生冲突
   **最短有效帧长**
   1、如果发生冲突，就一定是在发送的前`64`字节之内
   2、由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于`64`字节
   3、以太网规定了最短有效帧长为`64`字节，凡长度小于`64`字节的帧都是由于冲突而异常中止的无效帧。

- 二进制指数类型退避算法
   发生碰撞的站在停止发送数据后，要推迟（退避）一个随机时间才能再发送数据

  - 确定基本退避时间，一般是取为争用期`2τ` 
  - 确定参数`k，k = Min[重传次数, 10]` 
  - 从整数集合`[0, 1, ......, (2^k-1)]`中随机地取出一个数，记为`r`。重传所需的时延就是`r`倍的基本退避时间`2τ`。
  - 当重传达`16`次仍不能成功时即丢弃该帧，并向高层报告。



# 四、以太网

## 4.1 概述

- `DIX Ehternet V2`是世界上第一个局域网产品（以太网）的规约
- `IEEE的802.3`标准
   `DIX Ehternet V2`标准与`IEEE的802.3`标准只有很小的差别，因此可以将`802.3`局域网简称为“以太网”。严格来说，“以太网”应当指符合`DIX Ehternet V2`标准的局域网。
- 以太网与数据链路层的两个子层
   为了使数据链路层能更好地适应多种局域网标准，`802`委员会就将局域网的数据链路层拆成了两个子层：
   1、逻辑链路控制`LLC（Logical Link Control）`子层
   2、媒体接入控制`MAC（Medium Access Control）`子层
   与接入到传输媒体有关的内容都放在`MAC`子层，而`LLC`子层则与传输媒体无关，不管采用何种协议的局域网对`LLC`子层来说都是透明的。由于`TCP/IP`体系经常使用的局域网是`DIX Ehternet V2`而不是`802.3`标准中的几种局域网，因此现在`802`委员会制定的逻辑链路控制子层`LLC`（即`802.2`标准）的作用已经不大了。很多厂商的适配器上就仅装有`MAC`协议而没有`LLC`协议。
- 以太网提供的服务
   以太网提供的服务是不可靠的交付，即尽最大努力的交付。当接收站收到有差错的数据帧时就丢弃此帧，其他什么也不做。差错的纠正由高层来决定。如果高层发现丢失了一些数据而进行重传，但以太网并不知道这是一个重传的帧，而是当作一个新的数据帧来发送。

## 4.2 拓扑

- 星型拓扑
   传统以太网最初是使用粗同轴电缆，后来演进到使用比较便宜的细同轴电缆，最后发展为使用更便宜和更灵活的双绞线。不用电缆而使用无屏蔽双绞线。每个站需要用两对双绞线，分别用于发送和接收。这种以太网采用星型拓扑，在星型的中心则增加了一种可靠性非常高的设备，叫做集线器。

- 集线器的一些特点
   集线器是使用电子期间来模拟实际电缆线的工作，因此整个系统仍然像一个传统的以太网那样运行。集线器使用了大规模继承电路芯片，因此这样的硬件设备的可靠性已大大提高了。使用集线器的以太网在逻辑上仍是一个总线网，各工作站使用的还是`CSMA/CD`协议，并共享逻辑上的总线。集线器很像一个多接口的转发器，工作在物理层。
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-f97984cf26ad6a01.png?imageMogr2/auto-orient/strip|imageView2/2/w/523/format/webp)

  1

  

## 4.3 信道利用率

- 以太网的信道被占用的情况
   争用期长度为`2τ`，即端到端传播时延的两倍。检测到碰撞后不发送干扰信号。帧长为`L（bit）`，数据发送速率为`C（b/s）`，因而帧的发送时间为`L/C=T0(s)`。一个帧从开始发送，经可能发生的碰撞后，将再重传次数，到发送成功且信道转为空闲（即再经过时间`τ`使得信道上无信号在传播）时为止，是发送一帧所需的平均时间。
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-fad46296164493de.png?imageMogr2/auto-orient/strip|imageView2/2/w/647/format/webp)

  2

  

- 信道利用率：参数`a`

  - 要提供以太网的信道利用率，就必须减小`τ`与`T0`之比。在以太网中定义了参数`a`，它是以太网单程端到端时延τ与帧的发送时间`T0`之比：`a = τ/T0` 
  -  `a`趋向于`0`表示一发生碰撞就能检测出来，并立即停止发送，因而信道利用率很高。
  -  `a`越大，标明争用期所占的比例增大，每发生一次碰撞就浪费许多信道资源，使得信道利用率明显降低。
  - 对以太网参数的要求
     1、当数据率一定时，以太网的连线的长度收到限制，否则`τ`的数值会太大
     2、以太网的帧长不能太短，否则`T0`的值会太小，使`a`值太大。
  - 信道利用率的最大值
     1、在理想化情况下，以太网上的各站发送数据都不会产生碰撞（这显然已经不是`CSMA/CD`，而是需要使用一种特殊的调度方法），即总线一旦空闲就有某一个站立即发送数据。
     2、发送一帧占用线路的时间是`T0+τ`，而帧本身的发送时间是`T0`。于是我们可计算出理想情况下的极限信道利用率`Smax`为：`Smax = T0/(T0 + τ) = 1/(1+a)`。

## 4.4 MAC层

- **MAC**层的硬件地址（`MAC`地址）
   在局域网中，硬件地址又称物理地址，或`MAC`地址。`802`标准所说的“地址”严格来讲应当是每一个站的“名字”或标识符。但鉴于大家都早已习惯将这种`48`位“名字”称为“地址”，所以本书也采用这种习惯用法，尽管这种说法并不太严格。
   1、`IEEE`的注册管理机构`RA`负责向厂家分配地址字段的前三个字节（即高位`24`位）
   2、地址字段中的后三个字节（即低`24`位）由厂家自行指派，称为扩展标识符，必须保证生产出的适配器没有重复地址。
   3、一个地址块可以生成`2^24`个不同的地址。这种`48`位地址称为`MAC-48`，它的通用名称是`EUI-48`。
   4、“`MAC`地址”实际上就是适配器地址或适配器标识符`EUI-48`

- 适配器检查`MAC`地址
   适配器从网络上每收到一个`MAC`帧就首先用硬件检查`MAC`帧中的`MAC`地址。

  - 如果是发往本站的帧则收下，然后再进行其他的处理，否则就将此帧丢弃，不再进行其他处理。
  - 发往本站的帧包括一下三种帧：单播（`unicast`）帧（一对一）、广播（`broadcast`）帧（一对全体）、多播（`multicast`）帧（一对多）。

- `MAC`帧格式
   常用的以太网`MAC`帧格式有两种标准：`DIX Ethernet V2`标准和`IEEE`的`802.3`标准。最常用的`MAC`帧是以太网`V2`的格式。
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-28dd6601ff5520a2.png?imageMogr2/auto-orient/strip|imageView2/2/w/713/format/webp)

  3

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-6c9dbb1f5cf94e2a.png?imageMogr2/auto-orient/strip|imageView2/2/w/641/format/webp)

  4

  

- 无效的`MAC`帧

  - 帧的长度不是整数字节；
  - 用收到的帧检验序列`FCS`查出有差错；
  - 数据字段的长度不在`46~1500`字节之间；
  - 有效的`MAC`帧长度为`64~1518`字节之间；对于检查出的无效`MAC`帧就简单丢弃，以太网不负责重传丢弃的帧。

- 帧间最小间隔
   帧间最小间隔为`9.6μs`，相当于`96bit`的发送时间。一个站在检测到总线开始空闲后，还要等待`9.6μs`才能再次发送数据。这样做是为了使刚刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备。

# 五、扩展以太网

## 5.1 在物理层扩展

- 主机使用光纤和一对光纤调制解调器连接到集线器，这样距离就可以扩展到几公里了。
- 用集线器扩展局域网的优点
   1、使原来属于不同碰撞域的局域网上的计算机能够进行跨碰撞域的通信。
   2、扩大了局域网覆盖的地理范围。
   3、使得网络中计算机数量增加，但是效率低。
- 用集线器扩展局域网的缺点
   1、碰撞域增大了，但总的吞吐量并未提高
   2、如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互联起来。

## 5.2 在数据链路层扩展

在数据链路层扩展局域网是使用网桥。网桥工作在数据链路层，它根据`MAC`帧的目的地址对收到的帧进行转发。网桥具有过滤的功能。当网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的`MAC`地址，然后再确定将该帧转发到哪一个接口。而网桥就是交换机的前身。用交换机连接的网络是全双工的。

## 5.3 优化以太网

最开始是集线器，之后是网桥，而现在是使用交换机。交换机基本不会产生冲突，端口带宽是独享的，而且较为安全，基于`MAC`地址转发，能够学习`MAC`地址表。

# 六、高速以太网

## 6.1 100BASE-T以太网

速率达到或超过`100Mb/s`的以太网称为高速以太网，在双绞线上传送`100Mb/s`基带信号的星型拓扑以太网，仍使用`IEEE 802.3`的`CSMA/CD`协议。`100BASE-T`以太网又称为快速以太网（`Fast Ethernet`）。

- `100BASE-T`

  以太网的物理层 

  -  `100BASE-TX`：使用两对`UTP 5`类线或屏蔽双绞线`STP` 
  -  `100BASE-FX`：使用两对光纤
  -  `100BASE-T4`：使用四对`UTP 3`类线或`5`类线。

## 6.2 100BASE-T特点

可以在全双工方式下工作而无冲突发生。因此，不使用`CSMA/CD`协议。`MAC`帧格式仍然是`802.3`标准规定的。保持最短帧长不变，但将一个网段的最大电缆长度减小到`100m`。帧间时间间隔从原来的`9.6μs`改为现在的`0.96μs`。

## 6.3 吉比特以太网

允许在`1Gb/s`下全双工和半双工两种方式下工作。使用`802.3`协议规定的帧格式。在半双工方式下使用`CSMA/CD`协议（全双工不使用）。与`10BASE-T`和`100BASE-T`技术向后兼容。当吉比特以太网工作在全双工方式时，不使用载波延伸和分组突发。

## 6.4 吉比特以太网的物理层

- **1000BASE-X**基于光纤通道的物理层
- `1000BASE-SX`：`SX`表示短波长，传输距离`275`或`550m`
- `1000BASE-LX`：`LX`表示长波长，传输距离`550`或`5000m`
- `1000BASE-CX`：`CX`表示铜线，传输距离`25m`
- **1000BASE-T**
   使用四对`5`类线`UTP`

## 6.5 Cisco 建网三层模型



![img](https:////upload-images.jianshu.io/upload_images/1925650-42ff4ffe8ddb6443.png?imageMogr2/auto-orient/strip|imageView2/2/w/627/format/webp)

# 一、网络层提供的服务





![img](https:////upload-images.jianshu.io/upload_images/1925650-bdcf7845645fe460.png?imageMogr2/auto-orient/strip|imageView2/2/w/732/format/webp)

1

说明：

网络层负责在不同网络之间转发数据包，基于数据包的

```
IP
```

地址转发。至于多个数据包在接收端的顺序、是否丢包（不负责重传）这些都不是网络层的任务，而是传输层的任务了。



## 二、网络层如何发送数据

- 应用程序准备要传输的文件

- 传输层将文件分段并且编号

- 网络层田间目标`IP`地址和源`IP`地址

- 数据链路层一般有两种情况，一种是使用自己的子网掩码，判断自己在哪个网段和目标地址在哪个网段。如果在同一个网段，则直接使用

  ```
  ARP
  ```

  广播解析目标

  ```
  IP
  ```

  地址的

  ```
  MAC
  ```

  地址，然后直接传输。如果不是在同一个网段，则首先要询问网关的

  ```
  MAC
  ```

  地址，将数据先传递给路由器，路由器根据目标

  ```
  IP
  ```

  地址将数据发送目的主机。对于数据，在传输层叫段，在网络层叫包，在链路层叫帧。

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-83175553740d02c1.png?imageMogr2/auto-orient/strip|imageView2/2/w/1137/format/webp)

  2

  说明：

  从上图中我们可以清晰的看到数据是如何传送的，同时也可以看到各类设备工作在哪一层。

# 三、网络层协议

## 3.1 ARP协议

将`IP`地址通过广播目标`MAC`地址是`FF-FF-FF-FF-FF-FF`来解析目标`IP`地址的`MAC`地址。只能在本网络，不能跨网络。也就是只能扫描本网络的`MAC`地址。使用命令`arp -a`可以查看某时刻的网络`MAC`地址。

### 3.1.1 ARP欺骗

比如现在同一个网络中有三台计算机`P1、P2、P3`，其物理地址分别是`M1、M2、M3`，此时`P1`要向`P2`发送数据，于是使用`ARP`协议广播，首先`P2`将自己的物理地址高速了`P1`，于是这个地址`M2`就存储在了`P1`上，但是此时`P3`通过黑客软件伪装成`P2`告诉`P1`物理地址为`M3`，于是之后所有数据都发送给`P3`，当然`P3`为了不被发现，可以将数据再次转发给`P2`。这就是`ARP`欺骗。我们可以使用命令`arp -s 192.168.88.100 00-0c-29-53-48-c4`修改某个`IP`地址的`MAC`地址，此时本计算机就缓存了这个`MAC`地址，而且是静态的，因为是管理员告诉的。如果要清除缓存的物理地址可以点本地连接，点击修复即可。以上我们可以知道，**ARP协议是用来将IP地址解析为MAC地址，而IP地址用来将数据从一个网段转发到另一个网段**。

## 3.2 网际控制报文协议ICMP

此协议用来检测网络是否通畅，比如我们使用`ping`命令测试网络就是使用的此协议。在使用此命令的时候我们可以查看延时，同时关注一个信息，就是`TTL`。`TTL`表示数据包的生存周期，一般来说`Linux`为`64`、`Windows`为`128`、`Unix`为`255`，然后数据在传输的过程中每经过一个路由器则`TTL`减一，通过这个值我们可以大概判断所`ping`计算机的系统，如果`TTL`减为零则数据不再传输，直接被丢弃。如果给`ping`命令加上`-t`，则表示让此命令一直进行下去。`Windows`中`pathping`命令能跟踪数据包路径，计算丢包情况。

## 3.3 Internet组播管理协议IGMP

- 组播（多播）
   通过一个组播地址让一组计算机来进行接收，而不是向广播那样，所有的计算机都能接收到。
-  `IGMP`协议
   就是配置在一个组的路由器上面的，如果这个组都不需要接收数据了，那么配置了此协议的路由器就会知道发送端不需要发送数据了。

# 四、抓包分析数据

## 4.1 IP数据报结构

一个`IP`数据报由首部和数据两部分组成

- 首部的前一部分是固定长度，供`20`字节，是所有`IP`数据报必须有的

- 在首部的固定部分的后面是一些可选字段，其长度是可变的

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-1f3ac908e98a8623.png?imageMogr2/auto-orient/strip|imageView2/2/w/488/format/webp)

  3

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-7a18078a1783a039.png?imageMogr2/auto-orient/strip|imageView2/2/w/709/format/webp)

  4

  说明：

  版本用来标识

  ```
  TCP/IP
  ```

  协议的版本。

  区分服务

  是指，在传输信息的过程中，有些信息可能要求实时性，但是有些却没有这样的要求，于是对于这两种信息我们可以对其做上标记，同时也高速路由器优先传输哪种信息，这就是区分服务。

  总长度

  即数据报或分片之后数据报的长度。而前面讲到数据链路层的数据最大是

  ```
  1500
  ```

  字节（最大传输单元

  ```
  MTU
  ```

  ），而这里的数据报却最大是

  ```
  2^16-1
  ```

  个字节，这里就会产生冲突，这里使用

  分片

  将网络层数据报分成小的片，然后由链路层传输，一般情况下是不需要分片的。分片实例如下图

  ```
  6
  ```

  。

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-82d1b770d9647212.png?imageMogr2/auto-orient/strip|imageView2/2/w/646/format/webp)

  5

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-55f13e1da041468d.png?imageMogr2/auto-orient/strip|imageView2/2/w/709/format/webp)

  6

   而这里的

  标识

  是指，当一个数据报分片之后如何在接收端进行组装，那时就需要使用这个标识。

  标志

  表示数据报是否进行了分片，标志站

  ```
  3
  ```

  位，目前只有前两位有意义。标志字段的最低位是

  ```
  MF（More Fragment）
  ```

  。

  ```
  MF=1
  ```

  表示后面“还有分片”；

  ```
  MF=0
  ```

  表示最后一个分片。标志字段中间的一位是

  ```
  DF（Don't Fragment）
  ```

  。只有当

  ```
  DF=0
  ```

  时才允许分片。

  片偏移

  表示在分片之后， 某一个数据报在整个数据报中的分片位置的偏移是多少。

  生存时间

  （

  ```
  TTL
  ```

  ） 即数据报的生存时间，可以防止路由中的环路导致数据不能送达目的地。

  协议

  是指数据使用的是什么协议，是

  ```
  TCP
  ```

  还是

  ```
  UDP
  ```

  还是其他。

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-c0e5d97a21e49561.png?imageMogr2/auto-orient/strip|imageView2/2/w/700/format/webp)

  7

   其中各协议对应的协议号为，

  ```
  ICMP：1、IGMP：2、TCP：6、UDP：17、IPv6：41、OSPF：89
  ```

  。

  首部检验和（`16`位）

  用于检验数据报是否被修改或者出错，首部检验和字段只检验数据报的首部，不检验数据部分，这里不采用

  ```
  CRC
  ```

  检验码而采用简单的计算方法。

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-fdae46885b78f374.png?imageMogr2/auto-orient/strip|imageView2/2/w/705/format/webp)

  8

  可选字段

  一般没有，用于支持排错测量等，在

  ```
  IPv6
  ```

  中已被取消了。我们可以使用抓包工具进行查看，同时还可以使用抓包工具来排查网络故障。

# 五、IP协议

网络层的职责就是在路由器之间转发数据，不负责数据的是否出错等问题。而路由器是如何判断数据应该从哪个口转发出去呢？是如何选择路径的？这是通过路由表来进行选择的，路由表一种是由管理员告知的这一段数据应该怎么走，这就是静态路由；另一种是好几个路由器通过某种协议（`RIP`等）相互学习到某个网段该怎么走，在传输的时候自己选择走哪条路径传输，这就是动态路由。这里所述的`IP`协议是一个统称，即所有能让路由器学习到路由表的协议统称为`IP`协议。

## 5.1 网络畅通的条件





![img](https:////upload-images.jianshu.io/upload_images/1925650-300c94a851f95c8e.png?imageMogr2/auto-orient/strip|imageView2/2/w/700/format/webp)

9

说明：

网络畅通的条件就是数据报在发送的过程中有去有回，即传输路径中的每个路由器都知道其要传递的下一个路由器地址，并且也知道数据反向回来时的目的路由器地址。所以计算机和路由器必须配置网关，同一个局域网中通信是不需要网关的。



## 5.2 静态路由

在使用静态路由时，需要管理员高速所有路由器所有没有直连的网络下一跳（下一个传输结点）给哪个路由器。这里注意：如果是如上图那样的网络我们可以手动设置一些静态路由即可，但是如果网络较为复杂，都手动设置会特别麻烦，而且容易出错，此时就需要使用动态路由了。静态路由适合于小规模网络，不能够自动调整路由。

## 5.3 动态路由





![img](https:////upload-images.jianshu.io/upload_images/1925650-c3af3424da5e3e0b.png?imageMogr2/auto-orient/strip|imageView2/2/w/636/format/webp)

10

说明：



- **RIP**：周期性的广播路由表，使得网络中的其他路由器知道此路由器连接的线路。同时自己判断转发次数最少的路径为最佳路径，一般`30`秒更新一次路由信息。最大转发次数为`15`次，如果有`16`个及以上的路由器则仍未不可到达，不适合网络规模较大的情况。
- **OSPF**：此协议选择最佳路径的方式不是以转发多少次为标准，而是以带宽为标准，哪个路径的带宽大就选择哪条路径转发，这样会更快。

# 一、传输层的功能

## 1.1 OSI和DoD模型





![img](https:////upload-images.jianshu.io/upload_images/1925650-ff15807a58a60bba.png?imageMogr2/auto-orient/strip|imageView2/2/w/659/format/webp)

1

说明：

在

```
TCP/IP
```

协议栈中，传输层有两个协议

```
TCP
```

和

```
UDP
```



-  **TCP**（`Transmission Control Protocol`），传输控制协议，这是一种可靠安全的传输协议。一般如果一个文件在传输时需要分段，在需要使用此协议。此协议会建立一个会话，实现可靠传输。而且还有流量控制功能。可以使用命令`netstat -nb`查看会话。
-  **UDP**（`User Data Protocol`），用户数据报协议。此协议一般用在文件只需要一个数据报就可以传输完的情况，不需要分段，不需要建立会话，也不需要流量控制，是一种不可靠的传输。可用于多播和广播。

## 1.2 传输层协议和应用层协议之间的关系





![img](https:////upload-images.jianshu.io/upload_images/1925650-c9cd9fb2c4cd3d54.png?imageMogr2/auto-orient/strip|imageView2/2/w/554/format/webp)

2

说明：

常用的应用层协议使用的端口有

```
http=TCP+80
```

、

```
https=TCP+443
```

、

```
RDP=TCP+3389
```

、

```
ftp=TCP+21
```

、共享文件夹

```
=TCP+445
```

、

```
SMTP=TCP+25
```

、

```
PoP3=TCP+110
```

、

```
telnet=TCP+23
```

、

```
DNS=UDP+53
```

。这里相关的服务与应用层协议之间的关系是一个侦听的关系。当数据被发送到接收端的时候，接收端相应启动的服务会进行侦听。服务使用

```
TCP
```

或

```
UDP
```

的端口侦听客户的请求，客户端使用

```
IP
```

地址定位服务器，使用目标端口定位服务，可以在服务器网卡上设置只开放必要的端口，实现服务器的网络安全。一些命令：



- 查看服务侦听的端口`netstat -anb` 
- 产看建立的会话`netstat -n` 
- 查看建立会话的进程`netstat -nb` 
- 测试连接远程计算机某个端口是否打开`telnet 192.168.80.100 3389` 

## 1.3 传输层功能

为相互通信的应用进程提供了逻辑通信
 



![img](https:////upload-images.jianshu.io/upload_images/1925650-52ba966e5900bbf1.png?imageMogr2/auto-orient/strip|imageView2/2/w/703/format/webp)

3

说明：

传输层为应用进程之间提供端到端的逻辑通信（但网络层是为主机之间提供逻辑通信），还要对收到的报文进行差错检测，提供面向连接和无连接的服务。



## 1.4 传输层的端口





![img](https:////upload-images.jianshu.io/upload_images/1925650-dd3404b396d57f72.png?imageMogr2/auto-orient/strip|imageView2/2/w/638/format/webp)

4

说明：



-  **TCP**的端口：使用一个`16`位端口号进行标志，具有本地意义，即端口号只是为了标志本计算机应用层中的各进程。在`Internet`中不同计算机的相同端口号是没有联系的。

**分类：**

- 熟知的端口，数值一般为`0-1023` 

```css
FTP:21
telnet:23
SMTP:25
PoP3:110
DNS:53
HTTP:80
https:443
RDP:3389
```

- 登记端口号，数值为`1024-49151` 
- 客户端口号，数值为`49152-65535`，使用命令`netstat -n | find "ESTABLISHED"` 

# 二、传输层协议UDP和TCP

## 2.1 UDP协议

### 2.1.1 主要特点

此协议是无连接的，即发送数据之前不需要建立连接；使用尽最大努力交付，即不保证可靠交付，同时也不使用拥塞控制；是面向报文的，没有拥塞控制，很适合多媒体通信的要求；支持一对一、一对多、多对一和多对多的交互通信；首部开销小，只有八个字节。域名解析就是使用此协议。

### 2.1.2 UDP协议





![img](https:////upload-images.jianshu.io/upload_images/1925650-6f3f65c726fd8ea8.png?imageMogr2/auto-orient/strip|imageView2/2/w/718/format/webp)

5



![img](https:////upload-images.jianshu.io/upload_images/1925650-4181c4c2856f7da2.png?imageMogr2/auto-orient/strip|imageView2/2/w/687/format/webp)

6

说明：

```
UDP
```

协议的首部如上图。其中长度是指

```
UDP
```

用户数据报的长度。



## 2.2 TCP协议

### 2.2.1 概述

此协议是面向连接的传输层协议，每一条`TCP`连接只能有两个端点（`endpoint`），每一条`TCP`连接只能是点对点的（一对一），此协议提供可靠交付的服务，提供全双工通信，面向字节流。

### 2.2.2 TCP的连接

此协议把连接作为最基本的抽象，每一条`TCP`连接有两个端点，连接的端点不是主机，不是主机的`IP`地址，不是应用程序，也不是传输层的协议端口。`TCP`连接的端点叫做套接字（`socket`）。端口号拼接到`IP`地址即构成了套接字。`socket=(IP：port)`，每一条`TCP`连接唯一的被通信两端的两个端口（即两个套接字）所确定。

### 2.2.3 可靠传输原理





![img](https:////upload-images.jianshu.io/upload_images/1925650-33fc8f206de587e5.png?imageMogr2/auto-orient/strip|imageView2/2/w/685/format/webp)

7

说明：

在传输过程中如果无差错的情况则如图（

```
a
```

），发送端发出一个包，接收端接收到之后反馈一个消息，让发送端发送第二个包，一次类推，直到数据发送完毕。这就是停止等待协议，因为如果接收端不反馈成功接收的消息，发送端是不会发送下一个数据报的。如果在传输过程中出现错误，则发送端需要等待，等待一个稍微大于往返时间（

```
RTT
```

）的时间段，如果没收到接收端的反馈，则超时重传。



- **确认丢失和确认迟到**
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-0ad7478e292bc446.png?imageMogr2/auto-orient/strip|imageView2/2/w/711/format/webp)

  8

  说明：

  当发送端发送一个数据后，接收端接收到了，但是反馈的数据报丢了，那么发送端则重新发送前面的数据（认为没有收到），此时发送端收到之后将其丢弃，再次发送反馈的数据。这种情况即确认丢失。而确认迟到是指在上面的情况中，反馈的消息不是丢失了，而是发送太慢，导致发送端以为丢失了，然后重传，于是接收端继续丢弃重复数据报，并发送一个反馈消息。

  

- 使用上述的确认和重传机制，我们就可以在不可靠的传输网络上实现可靠的通信。这种可靠传输协议通常称为自动重传请求`ARQ（Automatic Repeate reQuest）`。`ARQ`标明重传的请求是自动进行的。接收方不需要请求发送方重传某个出错的分组。

- **信道利用率**
   停止等待协议的优点是简单，但缺点是信道利用率太低。
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-895fc861ad8681d9.png?imageMogr2/auto-orient/strip|imageView2/2/w/683/format/webp)

  8

  说明：

  从图中我们可以看到发送的时间为

  ```
  Td
  ```

  ，而一个往返的总时间为（

  ```
  Td+RTT+Ta
  ```

  ）。所以信道利用率

  ```
  U=Td/(Td+RTT+Ta)
  ```

  太低。那如果要向提高信道利用率，可选的办法有提高

  ```
  Td
  ```

  ，即流水线传输：

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-36566d7be547196a.png?imageMogr2/auto-orient/strip|imageView2/2/w/706/format/webp)

  9

   这种情况下，就是让发送端一直发送数据，不要等待。那么这种情况下如何实现可靠传输呢？

  

- **连续ARQ协议**
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-85fbb43af03e31bb.png?imageMogr2/auto-orient/strip|imageView2/2/w/666/format/webp)

  10

  说明：

  如上有

  ```
  12
  ```

  个数据报，而发送窗口为

  ```
  5
  ```

  标明每次可以连续发送

  ```
  5
  ```

  个数据报。发送

  ```
  5
  ```

  个数据报之后等待，此时如果收到第一个数据报的反馈信息，那么发送窗口向后移动，发送第六个数据报，依次类推。同时每接受到一个数据报的反馈消息，则此数据报就可以从缓存中删除了。当然这种方式在确认反馈消息的时候效率不高，可以使用累积确认。

  

- **累积确认**
   接收方一般采用累计确认。优点是容易实现，信道利用率高；缺点是不能向发送方反映出接收方已经正确收到的所有分组的信息。累积确认就是在发送时，首先发送多个数据报，比如此时发送的五个数据报中，第三个数据报没有收到，此此时就会反馈给接收端已经收到第二个数据报的信息，而接收端则会从第三个数据报开始，进行重发（当然也包括第四个和第五个数据报，虽然它们是发送成功的）。

### 2.2.4 TCP报文段的首部格式





![img](https:////upload-images.jianshu.io/upload_images/1925650-0882fb4ae82d95d7.png?imageMogr2/auto-orient/strip|imageView2/2/w/704/format/webp)

11

说明：

在发送数据时，有时候数据需要分成很多段发送，比如第一段为

```
0、1、2、3、4
```

这五个数据组成的一个段，而

序号

就是指每一段数据中第一个小数据（即

```
0
```

）在整个要发送的数据报中所占的位置（也是

```
0
```

）。当这个数据段被接收端收到之后会发送一个

确认号

，此时的确认号就是

```
5
```

，即要求发送端发送序号为

```
5
```

的数据段。

```
TCP
```

的首部大多数情况为

```
20
```

个字节，但是也有情况不是，而此时就需要使用

数据偏移

（首部长度）表示从第几个字节开始为真正的数据部分了，首部最长是

```
60=（0xFF）*4
```

个字节，这里的

```
0xFF
```

即数据偏移能够表示的最大十六进制数。



- 标记位`URG=1`表示在传输数据报时不需要排队，不管缓存中有多少数据。
- 标记位`ACK=0`表示确认号是无效的（在接收数据后其值为`1`，但是如果还没有发送数据，那当然就是`0`）。
- 标记位`SYN=1`表示同步，也就是这个数据报的发送需要建立一个会话。
- 标志位`PSH=1`表示接收端在将接收到的数据组装的时候不排序。
- 标志位`RST=1`表示`TCP`会话出现了严重的问题，需要重新建立连接。比如我们对某个打开但是会没有完全打开时，点击关闭，则会出现这种情况。
- 标志位`FIN=1`表示数据传输已经完毕了，需要释放连接。

**窗口**占两个字节，比如此时有两个主机`A、B`。`A`在发送数据时可以缓存的字节为`65530`个字节，于是需要将这个窗口发送给`B`，看`B`的接收缓存是不是能够满足最大的窗口字节，需要统一。同样，当`B`向`A`发送数据时也需要统一窗口。
 **紧急指针**只有在标志位`URG=1`的情况下才有作用，这表示`TCP`报文中数据部分中前面的多少个字节需要紧急处理。
 **选项**中有很多信息，比如最大`TCP`报文的长度为多少个字节，是不是支持**选择性确认**`SACK`。如果不够四个字节则会进行填充，以达到四个字节。

### 2.2.5 TCP如何实现可靠传输

- 以字节为单位的滑动窗口技术

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-286c8074a50a788e.png?imageMogr2/auto-orient/strip|imageView2/2/w/723/format/webp)

  12

  说明：

  首先注意发送窗口和接收窗口必须一致，这里使用前面讲到的停止等待协议。如果

  ```
  A
  ```

  向

  ```
  B
  ```

  发送数据，在不出错的情况下，比如将最前面的

  ```
  20
  ```

  个字节分成了三段，

  ```
  1~3、4~7、8~10、11~20
  ```

  进行发送，当

  ```
  B
  ```

  还没有收到相关数据时，

  ```
  A
  ```

  是不能发送第

  ```
  21
  ```

  个字节及之后的数据的，此时如果

  ```
  A
  ```

  没有收到

  ```
  B
  ```

  的反馈，则

  ```
  A
  ```

  缓存中的数据是不能删除的，窗口也是不能移动的，当

  ```
  B
  ```

  反馈确认号为

  ```
  8
  ```

  时，则

  ```
  A
  ```

  缓存中，之前的数据就可以删除了，发送第八个字节后的数据，同时

  ```
  A
  ```

  的窗口可以向后移动了，可以发送

  ```
  21~27
  ```

  的数据了，而

  ```
  B
  ```

  中就可以将

  ```
  1~7
  ```

  个字节提取出去了，缓存中就可以删除，同时

  ```
  B
  ```

  的窗口也会向后移动，依次类推。但是如果在传输过程中

  ```
  8~10
  ```

  这一段数据丢失了，其他段都接收到了，于是会通过前面讲的选择性确认

  ```
  SACK
  ```

  来告诉

  ```
  A
  ```

  哪一段缺失了，要求重发。注意，不是一收到数据就发送确认，而是发现接收的数据不是连续的才发送确认号。

### 2.2.6 超时重传时间的选择

**TCP**每发送一个报文段，就对这个报文段设置一次计时器。只要计时器设置的重传时间到但还没有收到确认，就要重传这一报文段。
 



![img](https:////upload-images.jianshu.io/upload_images/1925650-f22a58de96732700.png?imageMogr2/auto-orient/strip|imageView2/2/w/337/format/webp)

13

 超时重传时间应略大于上面得出的加权平均往返时间

```
RTTs
```

。

```
RFC2988
```

推荐的

```
α
```

值为

```
1/8
```

。



### 2.2.7 TCP的流量控制

用于解决发送端和接收端处理数据能力不同的问题。比如`A`发送数据很快，但是`B`的处理能力有限，很快A发送的数据就将`B`的缓存占满了，不能再接收数据了，比如先进行一部分处理才能再次接收，于是`B`需要向`A`告知这一点，这就是流量控制。在传输数据的过程中会根据自己的处理能力实时反馈相应的窗口，如果不能处理数据，则将窗口设置为零，先处理一部分数据之后再反馈相关信息，当接收端表示能够继续接收数据了，于是向发送端发送新的窗口和确认号，但是这个反馈信息如果丢失了怎么办？这里发送端会定时的发送窗口测定的数据报来检查接收端的窗口。

### 2.2.8 TCP拥塞控制

- 出现资源拥塞的条件：对资源需求的综合大于可用资源。

- 拥塞控制是一个全局性的过程，涉及到所有的主机、所有的路由器，以及与降低网络传输性能有关的所有因素。

- 流量控制往往指在给定的发送端和接收端之间的点对点通信量的控制，它所要做的就是抑制发送端发送数据的速率，以便使接收端来得急接收。

- 拥塞控制所起的作用
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-cb89c3f0047523b2.png?imageMogr2/auto-orient/strip|imageView2/2/w/621/format/webp)

  14

  说明：

  比如此时网路中最大的处理能力为

  ```
  100M
  ```

  ，但是现在各个主机不管，都向其发送数据，使得发送的数据达到

  ```
  500M
  ```

  ，此时可能路由器忙不过来了，可能只能处理了

  ```
  10M
  ```

  的数据，或者还可能死机，导致吞吐量极大的降低，这就是拥塞。而

  ```
  TCP
  ```

  都会有一个拥塞控制的作用，一般如果发现网络较忙时，就会协调传输速度，可能此时发送了

  ```
  90M
  ```

  的数据，但是网络正确处理了

  ```
  85
  ```

  个，此时网络的吞吐量却是很高的。

  

- 慢开始和拥塞避免
   发送方维持拥塞窗口`cwnd（congestion window）`。发送放控制拥塞窗口的原则是：
   1、只要网络没有出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去
   2、只要网络出现拥塞，拥塞窗口就减小一些，以减少注入到网络中的分组数。
   慢开始算法的原理：
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-c686897f77c8d14a.png?imageMogr2/auto-orient/strip|imageView2/2/w/716/format/webp)

  15

  说明:

  可以看到开始的时候只是发送了一个数据报，之后慢慢的增加发送速度，当然每次都会检查网路传输的情况，在网络畅通的情况下才会增加发送速度，反之则降低发送速度。

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-20178f36f8cdc81e.png?imageMogr2/auto-orient/strip|imageView2/2/w/722/format/webp)

  16

  说明：

  刚开始的时候速度增长是以

  ```
  2
  ```

  的倍数增加，当达到慢开始门限后，则是每次增加

  ```
  1
  ```

  的速度增加。当速度达到

  ```
  24
  ```

  时发现出现了拥塞，于是则要计算一个新的慢开始门限，即此时速度的一般

  ```
  12
  ```

  ，如果还是拥塞，则继续计算新的慢开始门限，之后则又开始慢慢增长，同时注意，此时的慢开始门限就是

  ```
  12
  ```

  了，而不是最开始的

  ```
  16
  ```

  。

  注意：

  拥塞避免并非指完全能够避免拥塞。而是在说在拥塞避免阶段把拥塞窗口控制为按线性规律增长，使网络比较不容易出现拥塞。这是最开始的拥塞控制方法，之后又出现了新的方法，即快重传和快恢复。

  

- 快重传和快恢复
   快重传：比如此时发送端向接收端发送了`1、2、3、4、5`这样一个数据段，但是在发送的过程中第三个数据丢失了，根据之前讲的累积确认，此时还是必须等到第`4、5`个数据接收到之后才发送确认号，但是要知道只要收到的数据为`1、2、4`，发送端就已经知道丢包了，于是此时会向发送端连续发送三个相同的确认号，让其发送第三个数据报，这就是快重传。
   快恢复：如上，丢失第三个数据报可能是因为拥塞，于是发送端会降低拥塞窗口，比如此时减小到了`1`，但是对于接收端发送的三个相同的确认号，此时却都收到了，这标明此时网络又是很好的，不再拥塞了，此时就不会向之前那样先指数再线性这样增长了，而是让拥塞窗口快速恢复到`12`，然后线性增长，这是相对慢开始来说的。
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-a50dd186b4001688.png?imageMogr2/auto-orient/strip|imageView2/2/w/698/format/webp)

  17

  

- 发送窗口的实际上限值
   发送方的发送窗口的上限值应当取为接收方窗口和拥塞窗口这两个变量中较小的一个，即应按一下公式确定：
   发送窗口的上限值`= Min{rwnd, cwnd}`

### 2.2.9 TCP的运输连接管理

传输连接有三个阶段，即：连接建立、数据传送和连接释放。`TCP`连接的建立都是采用客户服务器方式。主动发起连接建立的应用进程叫客户（`client`），被动等待连接建立的应用进程叫做服务器（`server`）。

- 三次握手建立`TCP`连接
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-06bd5dc023416935.png?imageMogr2/auto-orient/strip|imageView2/2/w/668/format/webp)

  18

  说明：

  建立连接个过程中首先客户端发送一个同步数据报，此时同步标记

  ```
  SYN=1
  ```

  ，标志位

  ```
  ACK=0
  ```

  ，序号

  ```
  seq=x
  ```

  。服务器接受到这样一个数据报之后就知道这是一个主动发起连接的数据报，此时服务器发送一个数据报，其中

  ```
  SYN=1
  ```

  ，标志位

  ```
  ACK=1
  ```

  ，序号

  ```
  seq=y
  ```

  ，由服务器指定，确认号

  ```
  ack=x+1
  ```

  ，让客户端发送第

  ```
  x+1
  ```

  个字节，接下来，客户端就再次发送确认数据报，此时就没有同步标记了。在前两次数据传输中已经足够确定网络是否畅通，那么为什么还要发第三次确认数据？这是因为当客户端发起请求，而这个请求可能在网路传输中传输较慢，一直没有到达服务器，于是客户端再次发出请求，而此时请求很快便到达，而此次会话在传输任务完成之后会话就断开了，然而，第一次发起的请求数据报在之后又被服务器接受到了，服务器以为这是客户端又发起的请求，于是就向客户端发出确认，然而可能此时客户端不需要建立连接，于是便不理睬这个确认，于是服务器就一直等待客户端的确认且发出数据，这样资源便被浪费了，这种情况多的时候服务器就可能宕机。而在三次握手方式中，服务器如果接受到第三次确认后，那么就人为自己发出的确认信息有用，于是就开始进行数据传输了，如果等了一段时间，没有等到第三次确认，那么就释放这个连接了。

  

- 三次握手建立`TCP`连接的各状态
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-6f3bf11013f1e675.png?imageMogr2/auto-orient/strip|imageView2/2/w/668/format/webp)

  19

  说明：

  客户端发出第一次请求之后就变成了

  ```
  SYN-SENT
  ```

  状态，而服务器收到之前是

  ```
  LISTEN
  ```

  状态，收到之后变为

  ```
  SYN-RCVD
  ```

  状态，客户端收到反馈后，发出请求，状态变为

  ```
  ESTABLISHED
  ```

  ，而服务器收到之后变为

  ```
  ESTABLISHED
  ```

  。

  

- **TCP**的连接释放
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-91a92be09dbeafc0.png?imageMogr2/auto-orient/strip|imageView2/2/w/590/format/webp)

  20

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-9d2eff5a2469b9d8.png?imageMogr2/auto-orient/strip|imageView2/2/w/656/format/webp)

  21

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-0783cd61464fe34d.png?imageMogr2/auto-orient/strip|imageView2/2/w/673/format/webp)

  22

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-2778c5a454c824f7.png?imageMogr2/auto-orient/strip|imageView2/2/w/674/format/webp)

  23

  说明：

  连接过程如上。

  

- 连接释放过程中的状态
   

  

  ![img](https:////upload-images.jianshu.io/upload_images/1925650-558149d8e424c357.png?imageMogr2/auto-orient/strip|imageView2/2/w/683/format/webp)

  24

  说明：

  连接必须经过

  2MSL

  的时间才真正释放，因为最后一次客户端向服务器确认的数据可能会丢失，所以需要等待。

# 一、域名系统DNS（Domain Name System）

负责将域名解析成`IP`地址，域名的组成都是以英文点号开始的，表示域名的根，顶级域名有`com、edu、net、cn`等，二级域名`jianshu`，我们在申请域名的时候是申请的`jianshu.com`，而不是`www.jianshu.com`。当然域名还可以有更多级。要查看域名解析服务器可使用`nslookup`命令查看。

- 域名解析过程
   一般是多个`DNS`服务器共同服务，比如有一个根服务器，然后有的服务器负责`.com`的域名解析，有的负责`.net`的域名解析。如果请求到的`DNS`服务器恰好能够解析我们需要解析的域名，那就直接解析，如果不行，则让根服务器去找到对应的服务器去解析。
- 配置`DNS`服务器
   当我们需要解析内网的域名或者为了节省到互联网的域名解析流量的情况下需要配置自己的服务器。可以直接在`windows`中安装服务。

# 二、动态主机配置协议DHCP

有时候我们想要让用户可以使用`IP`地址直接访问服务器，那么此服务器可以使用静态`IP`地址，这也就标明这台服务器的`IP`地址是固定的、唯一的。但是有时候我们使用笔记本可能此刻在这个局域网中上网，之后可能又在别的局域网中上网，那么此时就需要使用`DHCP`动态分配IP地址了。

- **DHCP**客户端请求`IP`地址的过程
   当客户端需要自动获得一个`IP`地址的时候，就会向局域网中以广播的方式发送请求，因为可能`DHCP`服务器可能不止一台，当服务器收到请求后就会为此主机分配一个`IP`地址，但是可能多态`DHCP`服务器都为此主机分配了一个地址，于是主机需要自己选择一个，而没有选择的那个由服务器回收。
- 跨网段地址分配
   对于多个局域网，如果每个局域网都配置一个`DHCP`服务器那是很浪费的，我们可以配置一个`DHCP`服务器就可以为多个局域网中的主机动态分配地址，首先是为`DHCP`服务器配置多个`IP`地址作用域（即多个网关），如果是被局域网中的主机请求分配地址，那么`DHCP`服务器收到的是广播信号，就会查自己是在哪个网段，然后为主机分配地址，所以这里`DHCP`服务器的地址一定必须是静态的。如果是别的局域网中的主机请求地址，同样这个主机是在自己所在的局域网中发送广播，而路由器是会屏蔽广播信号的，也就是说，这个请求不会以广播的形式到达`DHCP`服务器，这里我们需要为路由器配置`DHCP`服务器的地址，当收到请求分配地址的时候采用定点发送的方式向`DHCP`服务器发起请求，然后获得地址。

# 三、文件传送协议FTP（File Transfer Protocol）





![img](https:////upload-images.jianshu.io/upload_images/1925650-480491783aec0ea8.png?imageMogr2/auto-orient/strip|imageView2/2/w/701/format/webp)

1

说明：



- 控制连接：标准端口为`21`，用于发送`FTP`命令信息。`TCP`传送文件操作命令，比如是下载还是复制等等，而真正需要传输数据的时候还需要建立一个`TCP`数据连接。而数据连接建立有两种方式，一种是主动连接，一种是被动连接。

- 数据连接：

  - 主动模式就是

    ```
    FTP
    ```

    客户端告诉

    ```
    FTP
    ```

    服务器使用什么端口侦听，

    ```
    FTP
    ```

    服务器就和客户端的这个端口建立连接，使用的源端口是

    ```
    20
    ```

    。

    

    ![img](https:////upload-images.jianshu.io/upload_images/1925650-2247c3aef2c10aa3.png?imageMogr2/auto-orient/strip|imageView2/2/w/644/format/webp)

    2

  - 被动模式就是

    ```
    FTP
    ```

    服务器告诉客户端其开启了一个源端口，于是客户端就和这个源端口建立连接。由于被动模式下服务器端不确定是打开哪个端口作为源端口，所以如果我们需要建立防火墙，则还是需要使用主动模式。

    

    ![img](https:////upload-images.jianshu.io/upload_images/1925650-03595e12bf8fe661.png?imageMogr2/auto-orient/strip|imageView2/2/w/660/format/webp)

    3

- **FTP**传输模式

  - 文本模式：`ASCII`模式，以文本序列传输数据
  - 二进制模式：以二进制序列传输数据

# 四、远程终端协议Telnet

使用`TCP`的`23`端口

# 五、远程桌面协议RDP

和`Telnet`协议最大的不同是，`Telnet`是命令行窗口，而`RDP`可以实现图形界面。默认只允许连接两台远程主机。这里注意`windows Server`一般都是多用户操作系统，启用远程桌面可以多用户同时使用服务器，而`XP`和`windows7`是单用户操作系统，多个用户不能同时使用。

# 六、超文本传输协议HTTP（Hyper Text Transfer Protocol）

使用`TCP`协议。

# 七、电子邮件（SMTP、PoP3、IMAP）

